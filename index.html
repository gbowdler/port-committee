<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Port Committee</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            port: {
              50: '#fdf2f8',
              100: '#fce7f3',
              200: '#f5d0e0',
              300: '#e8a0c0',
              400: '#d4658f',
              500: '#b8396b',
              600: '#9b1b50',
              700: '#7a1240',
              800: '#5c0e30',
              900: '#3d0920',
              950: '#2a0615',
            },
            gold: {
              300: '#fcd34d',
              400: '#f6c344',
              500: '#d4a23a',
              600: '#b8860b',
            },
          },
        },
      },
    };
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap');

    /* ── Base body styles ── */
    body {
      font-family: 'Inter', sans-serif;
      background: #1a0a10;
      position: relative;
      min-height: 100vh;
    }

    /* ── Dynamic theme background layers ── */
    #theme-bg, #theme-bg-overlay {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      transition: opacity 0.6s ease;
    }
    #theme-bg { opacity: 0; }
    #theme-bg-overlay { opacity: 0; }
    #theme-bg.active { opacity: 1; }
    #theme-bg-overlay.active { opacity: 1; }

    /* ── Shared styles (always active) ── */
    #root { position: relative; z-index: 1; }

    h1, h2, h3, .font-display { font-family: 'Playfair Display', serif; }
    .glass { background: rgba(92, 14, 48, 0.25); backdrop-filter: blur(12px); border: 1px solid rgba(184, 57, 107, 0.2); }
    .glass-light { background: rgba(255,255,255,0.04); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.08); }
    .star-glow { filter: drop-shadow(0 0 3px rgba(212,162,58,0.5)); }
    input, select, textarea {
      background: rgba(255,255,255,0.06) !important;
      border: 1px solid rgba(255,255,255,0.12) !important;
      color: #f5d0e0 !important;
    }
    input::placeholder, textarea::placeholder { color: rgba(245,208,224,0.4) !important; }
    input:focus, select:focus, textarea:focus {
      outline: none !important;
      border-color: rgba(184,57,107,0.6) !important;
      box-shadow: 0 0 0 2px rgba(184,57,107,0.2) !important;
    }
    select option { background: #3d0920; color: #f5d0e0; }
    .fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
    ::-webkit-scrollbar-thumb { background: rgba(184,57,107,0.4); border-radius: 3px; }
  </style>
</head>
<body class="min-h-screen text-port-200">
  <div id="theme-bg"></div>
  <div id="theme-bg-overlay"></div>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useMemo, useRef } = React;

    /* ───────────────── Storage Helpers ───────────────── */

    let serverStorageAvailable = null;

    const canUseServerStorage = () => {
      if (serverStorageAvailable === false) return false;
      return window.location.protocol.startsWith('http');
    };

    const serverStorage = {
      async get(key) {
        if (!canUseServerStorage()) return null;
        try {
          const res = await fetch(`/api/storage?key=${encodeURIComponent(key)}`);
          if (!res.ok) throw new Error(`Server storage GET failed: ${res.status}`);
          const data = await res.json();
          serverStorageAvailable = true;
          return data.value ? JSON.parse(data.value) : null;
        } catch (e) {
          serverStorageAvailable = false;
          console.warn('Server storage unavailable, falling back to localStorage.', e);
          return null;
        }
      },
      async set(key, json) {
        if (!canUseServerStorage()) return false;
        try {
          const res = await fetch('/api/storage', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ key, value: json }),
          });
          if (!res.ok) throw new Error(`Server storage SET failed: ${res.status}`);
          serverStorageAvailable = true;
          return true;
        } catch (e) {
          serverStorageAvailable = false;
          console.warn('Server storage unavailable, falling back to localStorage.', e);
          return false;
        }
      },
    };

    const storage = {
      async get(key) {
        try {
          if (window.storage && typeof window.storage.get === 'function') {
            const raw = await window.storage.get(key, true);
            return raw ? JSON.parse(raw) : null;
          }
          const serverValue = await serverStorage.get(key);
          if (serverValue !== null) return serverValue;
          const raw = localStorage.getItem(key);
          return raw ? JSON.parse(raw) : null;
        } catch (e) {
          console.error('Storage get error:', e);
          return null;
        }
      },
      async set(key, data) {
        try {
          const json = JSON.stringify(data);
          if (window.storage && typeof window.storage.set === 'function') {
            await window.storage.set(key, json, true);
            return true;
          }
          const serverSaved = await serverStorage.set(key, json);
          if (serverSaved) return true;
          localStorage.setItem(key, json);
          return true;
        } catch (e) {
          console.error('Storage set error:', e);
          return false;
        }
      },
    };

    /* ───────────────── Constants ───────────────── */

    const PORT_TYPES = ['Vintage', 'Tawny', 'Ruby', 'LBV', 'White', 'Rose', 'Crusted'];

    const SORT_OPTIONS = [
      { value: 'rating-desc', label: 'Highest Rated' },
      { value: 'rating-asc', label: 'Lowest Rated' },
      { value: 'name-asc', label: 'Name A-Z' },
      { value: 'name-desc', label: 'Name Z-A' },
      { value: 'date-desc', label: 'Newest First' },
      { value: 'date-asc', label: 'Oldest First' },
    ];

    /* ───────────────── Theme Definitions ───────────────── */

    /* Enhanced SVG backgrounds for embossed and vineyard themes */

    const SVG_EMBOSSED = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 600 600" width="600" height="600">
<defs>
<pattern id="lg" width="6" height="6" patternUnits="userSpaceOnUse">
<rect width="6" height="6" fill="#1a0a10"/>
<rect x="0" y="0" width="2" height="1" fill="#231018" opacity="0.7"/>
<rect x="3" y="2" width="2" height="1" fill="#150812" opacity="0.6"/>
<rect x="1" y="4" width="2" height="1" fill="#1e0c14" opacity="0.5"/>
<rect x="4" y="5" width="1" height="1" fill="#221018" opacity="0.55"/>
<rect x="5" y="1" width="1" height="1" fill="#1c0e13" opacity="0.45"/>
<rect x="0" y="3" width="1" height="2" fill="#1f0f15" opacity="0.35"/>
</pattern>
<filter id="em" x="-30%" y="-30%" width="160%" height="160%">
<feGaussianBlur in="SourceAlpha" stdDeviation="5" result="b"/>
<feOffset in="b" dx="-3" dy="-3" result="lo"/>
<feOffset in="b" dx="3" dy="3" result="do"/>
<feFlood flood-color="#e8a0c0" flood-opacity="0.28" result="lc"/>
<feFlood flood-color="#000000" flood-opacity="0.55" result="dc"/>
<feComposite in="lc" in2="lo" operator="in" result="l"/>
<feComposite in="dc" in2="do" operator="in" result="d"/>
<feMerge><feMergeNode in="l"/><feMergeNode in="d"/></feMerge>
</filter>
<filter id="de" x="-30%" y="-30%" width="160%" height="160%">
<feGaussianBlur in="SourceAlpha" stdDeviation="4" result="b"/>
<feOffset dx="2.5" dy="2.5" result="lo"/>
<feFlood flood-color="#e8a0c0" flood-opacity="0.18"/>
<feComposite in2="lo" operator="in" result="ls"/>
<feOffset in="b" dx="-2.5" dy="-2.5" result="dof"/>
<feFlood flood-color="#000" flood-opacity="0.45"/>
<feComposite in2="dof" operator="in" result="ds"/>
<feMerge><feMergeNode in="ls"/><feMergeNode in="ds"/><feMergeNode in="SourceGraphic"/></feMerge>
</filter>
</defs>
<rect width="600" height="600" fill="url(#lg)"/>
<rect x="26" y="26" width="548" height="548" rx="8" fill="none" stroke="#e8a0c0" stroke-width="1.8" opacity="0.14" filter="url(#em)"/>
<rect x="38" y="38" width="524" height="524" rx="6" fill="none" stroke="#e8a0c0" stroke-width="1" opacity="0.10" filter="url(#em)"/>
<rect x="48" y="48" width="504" height="504" rx="4" fill="none" stroke="#e8a0c0" stroke-width="0.6" opacity="0.07" filter="url(#em)"/>
<g transform="translate(90,100) scale(0.74)" filter="url(#em)">
<path d="M80 200 C85 155 120 118 172 96 C212 78 260 68 308 64 C348 60 388 60 425 65 C472 72 515 90 548 115 C578 138 602 170 618 208 C630 238 638 275 640 312 C641 342 636 378 622 408 C606 445 580 476 548 500 C516 522 478 536 436 544 C390 553 340 555 294 550 C248 544 204 530 168 508 C134 486 106 456 86 420 C66 384 54 344 50 304 C46 268 50 236 60 210 Z" fill="#e8a0c0" opacity="0.10"/>
<path d="M80 200 C85 155 120 118 172 96 C212 78 260 68 308 64 C348 60 388 60 425 65 C472 72 515 90 548 115 C578 138 602 170 618 208 C630 238 638 275 640 312 C641 342 636 378 622 408 C606 445 580 476 548 500 C516 522 478 536 436 544 C390 553 340 555 294 550 C248 544 204 530 168 508 C134 486 106 456 86 420 C66 384 54 344 50 304 C46 268 50 236 60 210 Z" fill="none" stroke="#e8a0c0" stroke-width="3" opacity="0.20"/>
</g>
<g transform="translate(90,100) scale(0.74)" filter="url(#de)">
<path d="M60 290 Q135 255 225 282 T400 256 T560 288 T650 265" fill="none" stroke="#e8a0c0" stroke-width="5" opacity="0.16" stroke-linecap="round"/>
<path d="M75 308 Q148 278 235 300 T408 278 T565 304" fill="none" stroke="#e8a0c0" stroke-width="2.8" opacity="0.10" stroke-linecap="round"/>
</g>
<g transform="translate(90,100) scale(0.74)" filter="url(#em)">
<path d="M145 155 Q275 130 415 152 T625 138" fill="none" stroke="#e8a0c0" stroke-width="1.4" opacity="0.10"/>
<path d="M130 185 Q265 162 405 183 T620 170" fill="none" stroke="#e8a0c0" stroke-width="1.1" opacity="0.08"/>
<path d="M120 215 Q260 195 400 214 T615 202" fill="none" stroke="#e8a0c0" stroke-width="0.9" opacity="0.06"/>
<path d="M115 340 Q255 318 400 338 T620 325" fill="none" stroke="#e8a0c0" stroke-width="1.4" opacity="0.10"/>
<path d="M135 368 Q270 348 408 366 T615 354" fill="none" stroke="#e8a0c0" stroke-width="1.1" opacity="0.08"/>
<path d="M160 410 Q295 392 430 408 T610 398" fill="none" stroke="#e8a0c0" stroke-width="1.4" opacity="0.09"/>
<path d="M180 438 Q310 422 440 436 T605 426" fill="none" stroke="#e8a0c0" stroke-width="0.9" opacity="0.06"/>
<path d="M200 462 Q325 448 445 460 T600 452" fill="none" stroke="#e8a0c0" stroke-width="0.7" opacity="0.05"/>
</g>
<g opacity="0.16" filter="url(#em)">
<path d="M40 40 Q40 68 55 83" fill="none" stroke="#e8a0c0" stroke-width="1.3"/>
<path d="M40 40 Q68 40 83 55" fill="none" stroke="#e8a0c0" stroke-width="1.3"/>
<path d="M50 50 Q50 70 62 78" fill="none" stroke="#e8a0c0" stroke-width="0.8"/>
<path d="M50 50 Q70 50 78 62" fill="none" stroke="#e8a0c0" stroke-width="0.8"/>
<circle cx="52" cy="52" r="2.5" fill="#e8a0c0" opacity="0.6"/>
<path d="M560 40 Q560 68 545 83" fill="none" stroke="#e8a0c0" stroke-width="1.3"/>
<path d="M560 40 Q532 40 517 55" fill="none" stroke="#e8a0c0" stroke-width="1.3"/>
<path d="M550 50 Q550 70 538 78" fill="none" stroke="#e8a0c0" stroke-width="0.8"/>
<path d="M550 50 Q530 50 522 62" fill="none" stroke="#e8a0c0" stroke-width="0.8"/>
<circle cx="548" cy="52" r="2.5" fill="#e8a0c0" opacity="0.6"/>
<path d="M40 560 Q40 532 55 517" fill="none" stroke="#e8a0c0" stroke-width="1.3"/>
<path d="M40 560 Q68 560 83 545" fill="none" stroke="#e8a0c0" stroke-width="1.3"/>
<path d="M50 550 Q50 530 62 522" fill="none" stroke="#e8a0c0" stroke-width="0.8"/>
<path d="M50 550 Q70 550 78 538" fill="none" stroke="#e8a0c0" stroke-width="0.8"/>
<circle cx="52" cy="548" r="2.5" fill="#e8a0c0" opacity="0.6"/>
<path d="M560 560 Q560 532 545 517" fill="none" stroke="#e8a0c0" stroke-width="1.3"/>
<path d="M560 560 Q532 560 517 545" fill="none" stroke="#e8a0c0" stroke-width="1.3"/>
<path d="M550 550 Q550 530 538 522" fill="none" stroke="#e8a0c0" stroke-width="0.8"/>
<path d="M550 550 Q530 550 522 538" fill="none" stroke="#e8a0c0" stroke-width="0.8"/>
<circle cx="548" cy="548" r="2.5" fill="#e8a0c0" opacity="0.6"/>
</g>
<g filter="url(#em)" opacity="0.08">
<line x1="120" y1="36" x2="480" y2="36" stroke="#e8a0c0" stroke-width="0.5"/>
<line x1="120" y1="564" x2="480" y2="564" stroke="#e8a0c0" stroke-width="0.5"/>
<line x1="36" y1="120" x2="36" y2="480" stroke="#e8a0c0" stroke-width="0.5"/>
<line x1="564" y1="120" x2="564" y2="480" stroke="#e8a0c0" stroke-width="0.5"/>
</g>
</svg>`;

    const SVG_VINEYARD = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240" width="240" height="240">
<defs><style>path,circle,ellipse,line{fill:none;stroke:#e8a0c0;stroke-linecap:round;stroke-linejoin:round}</style></defs>
<g opacity="0.14">
<path d="M120 0 Q114 30 120 58 Q127 86 115 114 Q105 142 118 170 Q130 198 120 228 L120 240" stroke-width="2"/>
<path d="M92 72 Q76 54 66 42 Q62 50 54 46 Q65 64 76 78 Q66 84 56 80 Q68 98 86 94 Q78 106 72 116 Q88 108 100 96 Q108 102 118 98 Q108 90 104 80 Q114 74 118 64 Q104 68 92 72 Z" stroke-width="1" fill="#e8a0c0" fill-opacity="0.18"/>
<path d="M92 72 L76 56" stroke-width="0.6" opacity="0.8"/>
<path d="M92 72 L64 76" stroke-width="0.6" opacity="0.8"/>
<path d="M92 72 L80 98" stroke-width="0.6" opacity="0.8"/>
<path d="M92 72 L108 88" stroke-width="0.6" opacity="0.8"/>
<path d="M92 72 L110 62" stroke-width="0.6" opacity="0.8"/>
<path d="M92 72 Q106 66 116 60 Q120 54 120 46" stroke-width="0.9"/>
<circle cx="140" cy="84" r="5" fill="#e8a0c0" fill-opacity="0.22" stroke-width="0.7"/>
<circle cx="150" cy="80" r="5" fill="#e8a0c0" fill-opacity="0.22" stroke-width="0.7"/>
<circle cx="145" cy="94" r="5" fill="#e8a0c0" fill-opacity="0.22" stroke-width="0.7"/>
<circle cx="155" cy="90" r="4.5" fill="#e8a0c0" fill-opacity="0.20" stroke-width="0.7"/>
<circle cx="135" cy="93" r="4.5" fill="#e8a0c0" fill-opacity="0.20" stroke-width="0.7"/>
<circle cx="141" cy="104" r="4.5" fill="#e8a0c0" fill-opacity="0.20" stroke-width="0.6"/>
<circle cx="151" cy="100" r="4" fill="#e8a0c0" fill-opacity="0.18" stroke-width="0.6"/>
<circle cx="146" cy="112" r="3.8" fill="#e8a0c0" fill-opacity="0.16" stroke-width="0.5"/>
<circle cx="138" cy="112" r="3.5" fill="#e8a0c0" fill-opacity="0.14" stroke-width="0.5"/>
<path d="M146 74 Q138 66 126 64 Q122 70 120 76" stroke-width="0.8"/>
<path d="M120 36 Q134 28 142 36 Q148 46 140 54 Q132 58 128 48" stroke-width="0.8"/>
<path d="M128 48 Q126 44 130 42" stroke-width="0.5"/>
<path d="M120 128 Q104 120 96 128 Q90 140 100 148 Q110 152 114 142" stroke-width="0.8"/>
<path d="M114 142 Q116 136 110 136" stroke-width="0.5"/>
<path d="M152 160 Q166 146 174 134 Q178 142 184 140 Q176 156 164 168 Q174 172 180 168 Q170 182 156 178 Q162 186 166 196 Q152 188 146 176 Q138 180 128 178 Q138 170 142 162 Q134 158 130 148 Q144 154 152 160 Z" stroke-width="0.9" fill="#e8a0c0" fill-opacity="0.14"/>
<path d="M152 160 L168 146" stroke-width="0.5" opacity="0.7"/>
<path d="M152 160 L174 164" stroke-width="0.5" opacity="0.7"/>
<path d="M152 160 L160 180" stroke-width="0.5" opacity="0.7"/>
<path d="M152 160 L138 170" stroke-width="0.5" opacity="0.7"/>
<path d="M152 160 Q140 152 128 150 Q122 144 120 136" stroke-width="0.8"/>
<circle cx="84" cy="170" r="4.2" fill="#e8a0c0" fill-opacity="0.20" stroke-width="0.6"/>
<circle cx="94" cy="166" r="4.2" fill="#e8a0c0" fill-opacity="0.20" stroke-width="0.6"/>
<circle cx="78" cy="178" r="4" fill="#e8a0c0" fill-opacity="0.18" stroke-width="0.6"/>
<circle cx="89" cy="178" r="4" fill="#e8a0c0" fill-opacity="0.18" stroke-width="0.6"/>
<circle cx="84" cy="186" r="3.5" fill="#e8a0c0" fill-opacity="0.16" stroke-width="0.5"/>
<circle cx="76" cy="184" r="3" fill="#e8a0c0" fill-opacity="0.14" stroke-width="0.5"/>
<path d="M94 160 Q104 154 112 158 Q118 166 120 174" stroke-width="0.7"/>
<path d="M120 120 Q78 112 46 124 Q24 134 0 126" stroke-width="1.4"/>
<path d="M120 120 Q162 112 194 124 Q216 134 240 126" stroke-width="1.4"/>
<path d="M8 8 L20 0 L32 8 L20 16 Z" stroke-width="0.7" opacity="0.6"/>
<path d="M208 8 L220 0 L232 8 L220 16 Z" stroke-width="0.7" opacity="0.6"/>
<path d="M8 232 L20 240 L32 232 L20 224 Z" stroke-width="0.7" opacity="0.6"/>
<path d="M208 232 L220 240 L232 232 L220 224 Z" stroke-width="0.7" opacity="0.6"/>
<circle cx="120" cy="2" r="2" fill="#e8a0c0" stroke="none" opacity="0.5"/>
<circle cx="120" cy="238" r="2" fill="#e8a0c0" stroke="none" opacity="0.5"/>
<circle cx="2" cy="120" r="2" fill="#e8a0c0" stroke="none" opacity="0.5"/>
<circle cx="238" cy="120" r="2" fill="#e8a0c0" stroke="none" opacity="0.5"/>
<path d="M120 8 Q138 2 144 14 Q148 26 138 32 Q128 30 132 18" stroke-width="0.7"/>
<path d="M60 120 Q54 108 42 106 Q36 112 38 122" stroke-width="0.6"/>
<path d="M180 120 Q186 108 198 106 Q204 112 202 122" stroke-width="0.6"/>
</g>
</svg>`;

    const THEMES = [
      {
        id: 'douro',
        name: 'Douro Valley',
        desc: 'Topographic contour watermark',
        bg: 'radial-gradient(ellipse 80% 60% at 50% 40%, rgba(122, 18, 64, 0.3) 0%, transparent 70%), url("data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 1200 900\'%3E%3Cdefs%3E%3Cstyle%3Epath%7Bfill:none;stroke:%23e8a0c0;stroke-linecap:round%7D%3C/style%3E%3C/defs%3E%3Cg opacity=\'0.06\'%3E%3Cpath d=\'M-20 80 Q150 40 300 90 T600 70 T900 100 T1220 60\' stroke-width=\'1.2\'/%3E%3Cpath d=\'M-20 130 Q180 95 350 140 T650 115 T950 150 T1220 110\' stroke-width=\'1\'/%3E%3Cpath d=\'M-20 185 Q120 155 280 190 T580 170 T880 200 T1220 165\' stroke-width=\'1.3\'/%3E%3Cpath d=\'M-20 240 Q200 210 380 245 T700 225 T980 255 T1220 220\' stroke-width=\'0.8\'/%3E%3Cpath d=\'M-20 295 Q160 270 320 300 T640 280 T940 310 T1220 275\' stroke-width=\'1.1\'/%3E%3Cpath d=\'M-20 350 Q140 325 310 355 T620 340 T920 365 T1220 335\' stroke-width=\'1\'/%3E%3Cpath d=\'M-20 410 Q190 385 370 415 T680 395 T960 420 T1220 390\' stroke-width=\'1.2\'/%3E%3Cpath d=\'M-20 465 Q130 445 290 470 T590 455 T890 475 T1220 450\' stroke-width=\'0.9\'/%3E%3Cpath d=\'M-20 520 Q170 500 340 525 T660 510 T940 535 T1220 505\' stroke-width=\'1.1\'/%3E%3Cpath d=\'M-20 580 Q210 560 400 585 T720 565 T1000 590 T1220 565\' stroke-width=\'1\'/%3E%3Cpath d=\'M-20 635 Q150 620 310 640 T610 625 T910 645 T1220 620\' stroke-width=\'1.3\'/%3E%3Cpath d=\'M-20 690 Q180 675 360 695 T670 680 T960 700 T1220 680\' stroke-width=\'0.8\'/%3E%3Cpath d=\'M-20 750 Q140 735 300 755 T600 740 T900 760 T1220 740\' stroke-width=\'1\'/%3E%3Cpath d=\'M-20 810 Q200 795 380 815 T700 800 T980 820 T1220 800\' stroke-width=\'1.1\'/%3E%3Cpath d=\'M-20 865 Q160 855 330 870 T640 860 T940 875 T1220 855\' stroke-width=\'0.9\'/%3E%3Cpath d=\'M-20 200 Q100 230 250 180 T500 220 T750 170 T1000 210 T1220 190\' stroke-width=\'2\' opacity=\'0.7\'/%3E%3Cpath d=\'M-20 210 Q110 240 260 195 T510 235 T760 185 T1010 225 T1220 200\' stroke-width=\'1.5\' opacity=\'0.5\'/%3E%3Cpath d=\'M200 300 Q280 280 360 310 T520 290 T680 320\' stroke-width=\'0.7\'/%3E%3Cpath d=\'M200 315 Q280 298 360 325 T520 308 T680 335\' stroke-width=\'0.7\'/%3E%3Cpath d=\'M200 330 Q280 316 360 340 T520 326 T680 350\' stroke-width=\'0.7\'/%3E%3Cpath d=\'M600 500 Q700 480 800 510 T1000 490 T1150 520\' stroke-width=\'0.7\'/%3E%3Cpath d=\'M600 515 Q700 498 800 525 T1000 508 T1150 535\' stroke-width=\'0.7\'/%3E%3Cpath d=\'M600 530 Q700 516 800 540 T1000 526 T1150 550\' stroke-width=\'0.7\'/%3E%3Ccircle cx=\'350\' cy=\'310\' r=\'3\' fill=\'%23e8a0c0\' stroke=\'none\' opacity=\'0.4\'/%3E%3Ccircle cx=\'750\' cy=\'180\' r=\'3\' fill=\'%23e8a0c0\' stroke=\'none\' opacity=\'0.4\'/%3E%3Ccircle cx=\'900\' cy=\'520\' r=\'3\' fill=\'%23e8a0c0\' stroke=\'none\' opacity=\'0.4\'/%3E%3C/g%3E%3C/svg%3E")',
        bgSize: 'cover',
        bgPos: 'center',
        bgRepeat: 'no-repeat',
        bgAttach: 'scroll',
        overlay: null,
      },
      {
        id: 'embossed',
        name: 'Embossed Region',
        desc: 'Debossed leather journal',
        bg: 'radial-gradient(ellipse 90% 70% at 50% 45%, rgba(92, 14, 48, 0.25) 0%, transparent 60%), url("data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 600 600\' width=\'600\' height=\'600\'%3E%3Cdefs%3E%3Cpattern id=\'leather\' width=\'4\' height=\'4\' patternUnits=\'userSpaceOnUse\'%3E%3Crect width=\'4\' height=\'4\' fill=\'%231a0a10\'/%3E%3Crect x=\'0\' y=\'0\' width=\'1\' height=\'1\' fill=\'%23200d14\' opacity=\'0.5\'/%3E%3Crect x=\'2\' y=\'2\' width=\'1\' height=\'1\' fill=\'%23150812\' opacity=\'0.4\'/%3E%3Crect x=\'1\' y=\'3\' width=\'1\' height=\'1\' fill=\'%231d0b12\' opacity=\'0.3\'/%3E%3Crect x=\'3\' y=\'1\' width=\'1\' height=\'1\' fill=\'%23180a10\' opacity=\'0.35\'/%3E%3C/pattern%3E%3Cfilter id=\'emboss\'%3E%3CfeGaussianBlur in=\'SourceAlpha\' stdDeviation=\'3\' result=\'blur\'/%3E%3CfeOffset in=\'blur\' dx=\'-1.5\' dy=\'-1.5\' result=\'lightOffset\'/%3E%3CfeOffset in=\'blur\' dx=\'1.5\' dy=\'1.5\' result=\'darkOffset\'/%3E%3CfeFlood flood-color=\'%23e8a0c0\' flood-opacity=\'0.07\' result=\'lightColor\'/%3E%3CfeFlood flood-color=\'%23000000\' flood-opacity=\'0.2\' result=\'darkColor\'/%3E%3CfeComposite in=\'lightColor\' in2=\'lightOffset\' operator=\'in\' result=\'light\'/%3E%3CfeComposite in=\'darkColor\' in2=\'darkOffset\' operator=\'in\' result=\'dark\'/%3E%3CfeMerge%3E%3CfeMergeNode in=\'light\'/%3E%3CfeMergeNode in=\'dark\'/%3E%3C/feMerge%3E%3C/filter%3E%3Cfilter id=\'inner\'%3E%3CfeGaussianBlur in=\'SourceAlpha\' stdDeviation=\'2\' result=\'b\'/%3E%3CfeOffset dx=\'1\' dy=\'1\' result=\'lo\'/%3E%3CfeFlood flood-color=\'%23e8a0c0\' flood-opacity=\'0.04\'/%3E%3CfeComposite in2=\'lo\' operator=\'in\' result=\'ls\'/%3E%3CfeOffset in=\'b\' dx=\'-1\' dy=\'-1\' result=\'do\'/%3E%3CfeFlood flood-color=\'%23000\' flood-opacity=\'0.15\'/%3E%3CfeComposite in2=\'do\' operator=\'in\' result=\'ds\'/%3E%3CfeMerge%3E%3CfeMergeNode in=\'ls\'/%3E%3CfeMergeNode in=\'ds\'/%3E%3CfeMergeNode in=\'SourceGraphic\'/%3E%3C/feMerge%3E%3C/filter%3E%3C/defs%3E%3Crect width=\'600\' height=\'600\' fill=\'url(%23leather)\'/%3E%3Crect x=\'40\' y=\'40\' width=\'520\' height=\'520\' rx=\'6\' fill=\'none\' stroke=\'%23e8a0c0\' stroke-width=\'0.5\' opacity=\'0.06\' filter=\'url(%23emboss)\'/%3E%3Crect x=\'50\' y=\'50\' width=\'500\' height=\'500\' rx=\'4\' fill=\'none\' stroke=\'%23e8a0c0\' stroke-width=\'0.3\' opacity=\'0.04\' filter=\'url(%23emboss)\'/%3E%3Cg transform=\'translate(120,140) scale(0.6)\' filter=\'url(%23emboss)\'%3E%3Cpath d=\'M80 200 C90 170 120 140 170 120 C200 108 240 100 280 95 C310 91 340 90 370 92 C410 95 450 105 480 120 C510 135 530 155 550 180 C565 200 575 225 580 250 C584 270 582 295 575 315 C565 340 548 360 525 375 C500 390 470 400 440 405 C400 412 360 415 320 412 C280 409 245 400 215 385 C185 370 160 350 140 325 C120 300 105 272 95 245 C85 220 78 218 80 200 Z\' fill=\'%23e8a0c0\' opacity=\'0.03\'/%3E%3C/g%3E%3Cg transform=\'translate(120,140) scale(0.6)\' filter=\'url(%23inner)\'%3E%3Cpath d=\'M100 240 Q150 220 200 235 T310 215 T420 240 T530 220 T570 250\' fill=\'none\' stroke=\'%23e8a0c0\' stroke-width=\'2.5\' opacity=\'0.04\' stroke-linecap=\'round\'/%3E%3C/g%3E%3Cg transform=\'translate(120,140) scale(0.6)\' opacity=\'0.025\'%3E%3Cpath d=\'M160 180 Q250 160 340 175 T520 165\' fill=\'none\' stroke=\'%23e8a0c0\' stroke-width=\'1\' filter=\'url(%23emboss)\'/%3E%3Cpath d=\'M140 280 Q240 260 340 275 T540 265\' fill=\'none\' stroke=\'%23e8a0c0\' stroke-width=\'1\' filter=\'url(%23emboss)\'/%3E%3Cpath d=\'M170 340 Q270 320 370 335 T520 325\' fill=\'none\' stroke=\'%23e8a0c0\' stroke-width=\'1\' filter=\'url(%23emboss)\'/%3E%3C/g%3E%3Cg opacity=\'0.04\' filter=\'url(%23emboss)\'%3E%3Cpath d=\'M60 60 Q60 80 70 90 Q80 80 90 60\' fill=\'none\' stroke=\'%23e8a0c0\' stroke-width=\'1\'/%3E%3Cpath d=\'M540 60 Q540 80 530 90 Q520 80 510 60\' fill=\'none\' stroke=\'%23e8a0c0\' stroke-width=\'1\'/%3E%3Cpath d=\'M60 540 Q60 520 70 510 Q80 520 90 540\' fill=\'none\' stroke=\'%23e8a0c0\' stroke-width=\'1\'/%3E%3Cpath d=\'M540 540 Q540 520 530 510 Q520 520 510 540\' fill=\'none\' stroke=\'%23e8a0c0\' stroke-width=\'1\'/%3E%3C/g%3E%3C/svg%3E")',
        bgSize: '600px 600px',
        bgPos: 'center',
        bgRepeat: 'repeat',
        bgAttach: 'scroll',
        overlay: 'radial-gradient(circle at 30% 30%, rgba(122, 18, 64, 0.15) 0%, transparent 50%), radial-gradient(circle at 70% 70%, rgba(61, 9, 32, 0.2) 0%, transparent 50%)',
      },
      {
        id: 'vineyard',
        name: 'Vineyard Pattern',
        desc: 'Grape vine damask pattern',
        bg: 'url("data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 200 200\' width=\'200\' height=\'200\'%3E%3Cdefs%3E%3Cstyle%3Epath,circle,line,ellipse%7Bfill:none;stroke:%23e8a0c0;stroke-linecap:round%7D%3C/style%3E%3C/defs%3E%3Cg opacity=\'0.10\'%3E%3Cline x1=\'-10\' y1=\'50\' x2=\'50\' y2=\'-10\' stroke-width=\'0.5\' opacity=\'0.6\'/%3E%3Cline x1=\'10\' y1=\'70\' x2=\'70\' y2=\'10\' stroke-width=\'0.5\' opacity=\'0.6\'/%3E%3Cline x1=\'30\' y1=\'90\' x2=\'90\' y2=\'30\' stroke-width=\'0.5\' opacity=\'0.6\'/%3E%3Cline x1=\'50\' y1=\'110\' x2=\'110\' y2=\'50\' stroke-width=\'0.5\' opacity=\'0.6\'/%3E%3Cline x1=\'70\' y1=\'130\' x2=\'130\' y2=\'70\' stroke-width=\'0.5\' opacity=\'0.6\'/%3E%3Cline x1=\'90\' y1=\'150\' x2=\'150\' y2=\'90\' stroke-width=\'0.5\' opacity=\'0.6\'/%3E%3Cline x1=\'110\' y1=\'170\' x2=\'170\' y2=\'110\' stroke-width=\'0.5\' opacity=\'0.6\'/%3E%3Cline x1=\'130\' y1=\'190\' x2=\'190\' y2=\'130\' stroke-width=\'0.5\' opacity=\'0.6\'/%3E%3Cline x1=\'150\' y1=\'210\' x2=\'210\' y2=\'150\' stroke-width=\'0.5\' opacity=\'0.6\'/%3E%3Cpath d=\'M25 55 Q32 48 28 40 Q24 32 32 28\' stroke-width=\'0.7\' opacity=\'0.8\'/%3E%3Cpath d=\'M65 75 Q72 68 68 60 Q64 52 72 48\' stroke-width=\'0.7\' opacity=\'0.8\'/%3E%3Cpath d=\'M105 95 Q112 88 108 80 Q104 72 112 68\' stroke-width=\'0.7\' opacity=\'0.8\'/%3E%3Cpath d=\'M145 115 Q152 108 148 100 Q144 92 152 88\' stroke-width=\'0.7\' opacity=\'0.8\'/%3E%3Cg opacity=\'0.7\'%3E%3Ccircle cx=\'40\' cy=\'38\' r=\'2\' fill=\'%23e8a0c0\' stroke=\'none\'/%3E%3Ccircle cx=\'43\' cy=\'41\' r=\'2\' fill=\'%23e8a0c0\' stroke=\'none\'/%3E%3Ccircle cx=\'37\' cy=\'41\' r=\'2\' fill=\'%23e8a0c0\' stroke=\'none\'/%3E%3Ccircle cx=\'40\' cy=\'44\' r=\'1.8\' fill=\'%23e8a0c0\' stroke=\'none\'/%3E%3C/g%3E%3Cg opacity=\'0.7\'%3E%3Ccircle cx=\'120\' cy=\'78\' r=\'2\' fill=\'%23e8a0c0\' stroke=\'none\'/%3E%3Ccircle cx=\'123\' cy=\'81\' r=\'2\' fill=\'%23e8a0c0\' stroke=\'none\'/%3E%3Ccircle cx=\'117\' cy=\'81\' r=\'2\' fill=\'%23e8a0c0\' stroke=\'none\'/%3E%3Ccircle cx=\'120\' cy=\'84\' r=\'1.8\' fill=\'%23e8a0c0\' stroke=\'none\'/%3E%3C/g%3E%3Cellipse cx=\'30\' cy=\'32\' rx=\'4\' ry=\'2.5\' transform=\'rotate(-30 30 32)\' stroke-width=\'0.5\' opacity=\'0.6\'/%3E%3Cpath d=\'M30 32 L28 35\' stroke-width=\'0.4\' opacity=\'0.5\'/%3E%3Cellipse cx=\'110\' cy=\'72\' rx=\'4\' ry=\'2.5\' transform=\'rotate(-30 110 72)\' stroke-width=\'0.5\' opacity=\'0.6\'/%3E%3Cpath d=\'M110 72 L108 75\' stroke-width=\'0.4\' opacity=\'0.5\'/%3E%3Cpath d=\'M100 100 L104 96 L108 100 L104 104 Z\' stroke-width=\'0.4\' opacity=\'0.3\'/%3E%3C/g%3E%3C/svg%3E")',
        bgSize: '200px 200px',
        bgPos: 'center',
        bgRepeat: 'repeat',
        bgAttach: 'fixed',
        overlay: 'radial-gradient(ellipse 100% 80% at 50% 30%, rgba(92, 14, 48, 0.2) 0%, transparent 60%), radial-gradient(ellipse 60% 40% at 80% 80%, rgba(61, 9, 32, 0.15) 0%, transparent 50%)',
      },
    ];

    const THEME_SVG_OVERRIDES = {
      embossed: {
        gradient: 'radial-gradient(ellipse 90% 70% at 50% 45%, rgba(92, 14, 48, 0.35) 0%, transparent 60%), ',
        svg: SVG_EMBOSSED,
        overlay: 'radial-gradient(circle at 30% 30%, rgba(122, 18, 64, 0.22) 0%, transparent 50%), radial-gradient(circle at 70% 70%, rgba(61, 9, 32, 0.28) 0%, transparent 50%)',
      },
      vineyard: {
        gradient: '',
        svg: SVG_VINEYARD,
        bgSize: '240px 240px',
        overlay: 'radial-gradient(ellipse 100% 80% at 50% 30%, rgba(92, 14, 48, 0.28) 0%, transparent 60%), radial-gradient(ellipse 60% 40% at 80% 80%, rgba(61, 9, 32, 0.22) 0%, transparent 50%)',
      },
    };

    function applyTheme(themeId) {
      const theme = THEMES.find(t => t.id === themeId) || THEMES[0];
      const el = document.getElementById('theme-bg');
      const ov = document.getElementById('theme-bg-overlay');
      if (!el) return;

      el.classList.remove('active');
      ov.classList.remove('active');

      let bgVal = theme.bg;
      let overlayVal = theme.overlay;
      let bgSize = theme.bgSize;
      const ovr = THEME_SVG_OVERRIDES[themeId];
      if (ovr) {
        bgVal = ovr.gradient + 'url("data:image/svg+xml,' + encodeURIComponent(ovr.svg) + '")';
        if (ovr.overlay) overlayVal = ovr.overlay;
        if (ovr.bgSize) bgSize = ovr.bgSize;
      }

      requestAnimationFrame(() => {
        el.style.background = bgVal;
        el.style.backgroundSize = bgSize;
        el.style.backgroundPosition = theme.bgPos;
        el.style.backgroundRepeat = theme.bgRepeat;
        el.style.backgroundAttachment = theme.bgAttach;

        if (overlayVal) {
          ov.style.background = overlayVal;
        } else {
          ov.style.background = 'none';
        }

        requestAnimationFrame(() => {
          el.classList.add('active');
          if (overlayVal) ov.classList.add('active');
        });
      });
    }

    /* ───────────────── Theme Switcher Component ───────────────── */

    function ThemeSwitcher() {
      const [open, setOpen] = useState(false);
      const [current, setCurrent] = useState(() => localStorage.getItem('pc_theme') || 'douro');
      const panelRef = useRef(null);

      useEffect(() => {
        applyTheme(current);
      }, []);

      useEffect(() => {
        if (!open) return;
        const handler = (e) => {
          if (panelRef.current && !panelRef.current.contains(e.target)) setOpen(false);
        };
        document.addEventListener('mousedown', handler);
        return () => document.removeEventListener('mousedown', handler);
      }, [open]);

      const select = (id) => {
        setCurrent(id);
        localStorage.setItem('pc_theme', id);
        applyTheme(id);
        setOpen(false);
      };

      return (
        <div className="relative" ref={panelRef}>
          <button
            onClick={() => setOpen(!open)}
            className="p-2 rounded-lg glass-light text-port-400 hover:text-port-200 transition"
            title="Switch theme"
          >
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1V5zm10 0a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1v-4zm10 0a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
            </svg>
          </button>

          {open && (
            <div className="absolute right-0 top-full mt-2 w-64 glass rounded-xl p-3 shadow-2xl fade-in z-50">
              <p className="text-[10px] font-semibold text-port-400 uppercase tracking-wider mb-2 px-1">Background Theme</p>
              {THEMES.map(t => (
                <button
                  key={t.id}
                  onClick={() => select(t.id)}
                  className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left transition mb-1 last:mb-0 ${
                    current === t.id
                      ? 'bg-port-700/40 border border-port-500/30'
                      : 'hover:bg-white/5 border border-transparent'
                  }`}
                >
                  <span className={`flex-shrink-0 w-3.5 h-3.5 rounded-full border-2 flex items-center justify-center ${
                    current === t.id ? 'border-gold-400' : 'border-port-500'
                  }`}>
                    {current === t.id && <span className="w-1.5 h-1.5 rounded-full bg-gold-400" />}
                  </span>
                  <span>
                    <span className={`block text-sm font-medium ${current === t.id ? 'text-port-100' : 'text-port-300'}`}>{t.name}</span>
                    <span className="block text-[11px] text-port-500">{t.desc}</span>
                  </span>
                </button>
              ))}
            </div>
          )}
        </div>
      );
    }

    /* ───────────────── Star Rating Component ───────────────── */

    function StarRating({ rating, max = 10, size = 'md', interactive = false, onChange }) {
      const sizes = { sm: 'w-4 h-4', md: 'w-5 h-5', lg: 'w-7 h-7' };
      const sz = sizes[size] || sizes.md;
      const [hover, setHover] = useState(0);

      return (
        <div className="flex gap-0.5 items-center">
          {Array.from({ length: max }, (_, i) => {
            const val = i + 1;
            const filled = interactive ? val <= (hover || rating) : val <= rating;
            return (
              <button
                key={i}
                type="button"
                disabled={!interactive}
                className={`${sz} transition-all ${interactive ? 'cursor-pointer hover:scale-110' : 'cursor-default'}`}
                onMouseEnter={() => interactive && setHover(val)}
                onMouseLeave={() => interactive && setHover(0)}
                onClick={() => interactive && onChange && onChange(val)}
                aria-label={`${val} star${val > 1 ? 's' : ''}`}
              >
                <svg viewBox="0 0 24 24" className={`${filled ? 'star-glow' : ''}`}>
                  <path
                    d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"
                    fill={filled ? '#d4a23a' : 'transparent'}
                    stroke={filled ? '#d4a23a' : 'rgba(245,208,224,0.25)'}
                    strokeWidth="1.5"
                  />
                </svg>
              </button>
            );
          })}
        </div>
      );
    }

    /* ───────────────── Toast Notification ───────────────── */

    function Toast({ message, type = 'success', onClose }) {
      useEffect(() => {
        const t = setTimeout(onClose, 3000);
        return () => clearTimeout(t);
      }, [onClose]);

      const bg = type === 'success' ? 'bg-emerald-900/80 border-emerald-600/40' : 'bg-red-900/80 border-red-600/40';
      return (
        <div className={`fixed top-4 right-4 z-50 px-5 py-3 rounded-lg border ${bg} text-port-100 shadow-xl fade-in`}>
          {message}
        </div>
      );
    }

    /* ───────────────── Confirm Dialog ───────────────── */

    function ConfirmDialog({ title, message, onConfirm, onCancel }) {
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm fade-in p-4">
          <div className="glass rounded-xl p-6 max-w-sm w-full">
            <h3 className="font-display text-xl text-port-100 mb-2">{title}</h3>
            <p className="text-port-300 mb-6">{message}</p>
            <div className="flex gap-3 justify-end">
              <button onClick={onCancel} className="px-4 py-2 rounded-lg glass-light text-port-200 hover:bg-white/10 transition">Cancel</button>
              <button onClick={onConfirm} className="px-4 py-2 rounded-lg bg-red-800/60 text-port-100 hover:bg-red-700/60 transition">Delete</button>
            </div>
          </div>
        </div>
      );
    }

    /* ───────────────── Loading Spinner ───────────────── */

    function Spinner() {
      return (
        <div className="flex justify-center py-12">
          <div className="w-8 h-8 border-2 border-port-500 border-t-gold-400 rounded-full animate-spin" />
        </div>
      );
    }

    /* ───────────────── Add/Edit Port Form ───────────────── */

    function PortForm({ port, onSave, onCancel }) {
      const isEdit = !!port;
      const [form, setForm] = useState({
        name: port?.name || '',
        producer: port?.producer || '',
        type: port?.type || 'Tawny',
        year: port?.year || '',
        photo: port?.photo || '',
        purchaseLocation: port?.purchaseLocation || '',
        purchasePrice: port?.purchasePrice || '',
      });
      const fileInputRef = useRef(null);
      const [errors, setErrors] = useState({});
      const [saving, setSaving] = useState(false);

      const validate = () => {
        const errs = {};
        if (!form.name.trim()) errs.name = 'Port name is required';
        if (!form.producer.trim()) errs.producer = 'Producer is required';
        if (form.year && (isNaN(form.year) || form.year < 1700 || form.year > new Date().getFullYear()))
          errs.year = 'Enter a valid year';
        if (form.purchasePrice && (isNaN(form.purchasePrice) || Number(form.purchasePrice) < 0))
          errs.purchasePrice = 'Enter a valid price';
        setErrors(errs);
        return Object.keys(errs).length === 0;
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!validate()) return;
        setSaving(true);
        const data = {
          ...form,
          year: form.year ? Number(form.year) : null,
          purchasePrice: form.purchasePrice ? Number(form.purchasePrice) : null,
        };
        await onSave(data);
        setSaving(false);
      };

      const field = (label, key, type = 'text', opts = {}) => (
        <div className={opts.full ? 'sm:col-span-2' : ''}>
          <label className="block text-sm font-medium text-port-300 mb-1">{label}{opts.required && <span className="text-port-500 ml-0.5">*</span>}</label>
          {opts.textarea ? (
            <textarea
              value={form[key]}
              onChange={(e) => setForm({ ...form, [key]: e.target.value })}
              rows={3}
              placeholder={opts.placeholder || ''}
              className="w-full rounded-lg px-3 py-2 text-sm"
            />
          ) : opts.select ? (
            <select
              value={form[key]}
              onChange={(e) => setForm({ ...form, [key]: e.target.value })}
              className="w-full rounded-lg px-3 py-2 text-sm"
            >
              {opts.options.map((o) => <option key={o} value={o}>{o}</option>)}
            </select>
          ) : (
            <input
              type={type}
              value={form[key]}
              onChange={(e) => setForm({ ...form, [key]: e.target.value })}
              placeholder={opts.placeholder || ''}
              className="w-full rounded-lg px-3 py-2 text-sm"
            />
          )}
          {errors[key] && <p className="text-red-400 text-xs mt-1">{errors[key]}</p>}
        </div>
      );

      return (
        <div className="fade-in max-w-2xl mx-auto">
          <button onClick={onCancel} className="flex items-center gap-1 text-port-400 hover:text-port-200 mb-4 transition text-sm">
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg>
            Back
          </button>
          <div className="glass rounded-xl p-6">
            <h2 className="font-display text-2xl text-port-100 mb-6">{isEdit ? 'Edit Port' : 'Add New Port'}</h2>
            <form onSubmit={handleSubmit} className="grid sm:grid-cols-2 gap-4">
              {field('Port Name', 'name', 'text', { required: true, placeholder: "e.g. Dow's 2017 Vintage" })}
              {field('Producer', 'producer', 'text', { required: true, placeholder: "e.g. Dow's" })}
              {field('Type', 'type', 'text', { select: true, options: PORT_TYPES })}
              {field('Year', 'year', 'number', { placeholder: 'e.g. 2017' })}
              <div className="sm:col-span-2">
                <label className="block text-sm font-medium text-port-300 mb-1">Photo</label>
                <div className="flex items-start gap-4">
                  <button
                    type="button"
                    onClick={() => fileInputRef.current?.click()}
                    className="flex items-center gap-2 px-4 py-2 rounded-lg glass-light text-port-200 hover:bg-white/10 transition text-sm"
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    {form.photo ? 'Change Photo' : 'Upload Photo'}
                  </button>
                  <input
                    ref={fileInputRef}
                    type="file"
                    accept="image/jpeg,image/png,image/webp"
                    className="hidden"
                    onChange={(e) => {
                      const file = e.target.files?.[0];
                      if (!file) return;
                      const reader = new FileReader();
                      reader.onload = (ev) => setForm({ ...form, photo: ev.target.result });
                      reader.readAsDataURL(file);
                    }}
                  />
                  {form.photo && (
                    <div className="relative group">
                      <img src={form.photo} alt="Port bottle" className="w-20 h-20 object-cover rounded-lg border border-white/10" />
                      <button
                        type="button"
                        onClick={() => { setForm({ ...form, photo: '' }); if (fileInputRef.current) fileInputRef.current.value = ''; }}
                        className="absolute -top-2 -right-2 w-5 h-5 rounded-full bg-red-800 text-port-100 text-xs flex items-center justify-center opacity-0 group-hover:opacity-100 transition"
                      >&times;</button>
                    </div>
                  )}
                </div>
                <p className="text-port-500 text-xs mt-1">JPG, PNG, or WebP (optional)</p>
              </div>
              {field('Purchase Location', 'purchaseLocation', 'text', { placeholder: 'Store or website' })}
              {field('Purchase Price', 'purchasePrice', 'number', { placeholder: '0.00' })}
              <div className="sm:col-span-2 flex gap-3 justify-end pt-2">
                <button type="button" onClick={onCancel} className="px-5 py-2.5 rounded-lg glass-light text-port-200 hover:bg-white/10 transition text-sm">Cancel</button>
                <button type="submit" disabled={saving} className="px-5 py-2.5 rounded-lg bg-port-700 text-port-100 hover:bg-port-600 transition text-sm disabled:opacity-50">
                  {saving ? 'Saving...' : isEdit ? 'Update Port' : 'Add Port'}
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }

    /* ───────────────── Port Detail View ───────────────── */

    function PortDetail({ portId, onBack, onEdit, onDelete, showToast, onNavigateToMeeting }) {
      const [port, setPort] = useState(null);
      const [ratings, setRatings] = useState([]);
      const [portMeetings, setPortMeetings] = useState([]);
      const [loading, setLoading] = useState(true);
      const [memberName, setMemberName] = useState(() => localStorage.getItem('pc_member') || '');
      const [newRating, setNewRating] = useState(0);
      const [newNotes, setNewNotes] = useState('');
      const [submitting, setSubmitting] = useState(false);
      const [ratingErrors, setRatingErrors] = useState({});
      const [showConfirm, setShowConfirm] = useState(false);

      const load = useCallback(async () => {
        setLoading(true);
        const p = await storage.get(`port:${portId}`);
        const r = await storage.get(`ratings:${portId}`);
        setPort(p);
        setRatings(r?.ratings || []);
        // Load meetings that include this port
        const meetingIds = (await storage.get('meetings:list')) || [];
        const mList = [];
        for (const mid of meetingIds) {
          const m = await storage.get(`meeting:${mid}`);
          if (m && m.portsTasted && m.portsTasted.includes(portId)) mList.push(m);
        }
        setPortMeetings(mList);
        setLoading(false);
      }, [portId]);

      useEffect(() => { load(); }, [load]);

      const avgRating = useMemo(() => {
        if (!ratings.length) return 0;
        return ratings.reduce((s, r) => s + r.rating, 0) / ratings.length;
      }, [ratings]);

      const submitRating = async (e) => {
        e.preventDefault();
        const errs = {};
        if (!memberName.trim()) errs.name = 'Enter your name';
        if (!newRating) errs.rating = 'Select a rating';
        setRatingErrors(errs);
        if (Object.keys(errs).length) return;

        setSubmitting(true);
        localStorage.setItem('pc_member', memberName.trim());
        const updated = ratings.filter((r) => r.memberName !== memberName.trim());
        updated.push({
          memberName: memberName.trim(),
          rating: newRating,
          notes: newNotes.trim(),
          date: new Date().toISOString(),
        });
        const ok = await storage.set(`ratings:${portId}`, { portId, ratings: updated });
        if (ok) {
          setRatings(updated);
          setNewRating(0);
          setNewNotes('');
          showToast('Rating saved!');
        } else {
          showToast('Failed to save rating', 'error');
        }
        setSubmitting(false);
      };

      const handleDelete = async () => {
        const list = (await storage.get('ports:list')) || [];
        await storage.set('ports:list', list.filter((id) => id !== portId));
        await storage.set(`port:${portId}`, null);
        await storage.set(`ratings:${portId}`, null);
        showToast('Port deleted');
        onBack();
      };

      if (loading) return <Spinner />;
      if (!port) return <p className="text-center text-port-400 py-12">Port not found.</p>;

      return (
        <div className="fade-in max-w-2xl mx-auto">
          {showConfirm && (
            <ConfirmDialog
              title="Delete Port"
              message={`Are you sure you want to delete "${port.name}"? This will also remove all ratings.`}
              onConfirm={handleDelete}
              onCancel={() => setShowConfirm(false)}
            />
          )}

          <button onClick={onBack} className="flex items-center gap-1 text-port-400 hover:text-port-200 mb-4 transition text-sm">
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg>
            Back to list
          </button>

          {/* Port Info Card */}
          <div className="glass rounded-xl p-6 mb-6">
            <div className="flex flex-wrap items-start justify-between gap-3 mb-4">
              <div>
                <span className="inline-block text-xs font-medium px-2.5 py-1 rounded-full bg-port-800/60 text-port-300 mb-2">{port.type}</span>
                <h2 className="font-display text-2xl sm:text-3xl text-port-100">{port.name}</h2>
                <p className="text-port-300 mt-0.5">{port.producer}{port.year ? ` \u00B7 ${port.year}` : ''}</p>
              </div>
              <div className="text-right">
                <div className="text-3xl font-display text-gold-400">{avgRating ? avgRating.toFixed(1) : '\u2014'}</div>
                <div className="text-xs text-port-400">{ratings.length} rating{ratings.length !== 1 ? 's' : ''}</div>
              </div>
            </div>

            {avgRating > 0 && (
              <div className="mb-4">
                <StarRating rating={Math.round(avgRating)} size="md" />
              </div>
            )}

            {port.photo && (
              <div className="mb-4">
                <img src={port.photo} alt={port.name} className="w-full max-w-xs rounded-lg border border-white/10" />
              </div>
            )}
            {(port.purchaseLocation || port.purchasePrice) && (
              <div className="mb-3">
                <h4 className="text-xs font-semibold text-port-400 uppercase tracking-wider mb-1">Purchase Info</h4>
                <p className="text-port-200 text-sm">
                  {port.purchaseLocation}{port.purchaseLocation && port.purchasePrice ? ' \u00B7 ' : ''}
                  {port.purchasePrice ? `$${Number(port.purchasePrice).toFixed(2)}` : ''}
                </p>
              </div>
            )}

            <div className="flex gap-2 mt-5 pt-4 border-t border-white/5">
              <button onClick={() => onEdit(port)} className="flex items-center gap-1.5 text-sm text-port-300 hover:text-port-100 transition">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                Edit
              </button>
              <button onClick={() => setShowConfirm(true)} className="flex items-center gap-1.5 text-sm text-red-400/70 hover:text-red-400 transition ml-4">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                Delete
              </button>
            </div>
          </div>

          {/* Member Ratings */}
          <div className="glass rounded-xl p-6 mb-6">
            <h3 className="font-display text-xl text-port-100 mb-4">Member Ratings</h3>
            {ratings.length === 0 ? (
              <p className="text-port-400 text-sm">No ratings yet. Be the first!</p>
            ) : (
              <div className="space-y-4">
                {ratings.sort((a, b) => new Date(b.date) - new Date(a.date)).map((r, i) => (
                  <div key={i} className="glass-light rounded-lg p-4">
                    <div className="flex items-center justify-between mb-1">
                      <span className="font-medium text-port-100">{r.memberName}</span>
                      <span className="text-xs text-port-400">{new Date(r.date).toLocaleDateString()}</span>
                    </div>
                    <StarRating rating={r.rating} size="sm" />
                    {r.notes && <p className="text-port-300 text-sm mt-2 leading-relaxed">{r.notes}</p>}
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Add Rating */}
          <div className="glass rounded-xl p-6">
            <h3 className="font-display text-xl text-port-100 mb-4">Add Your Rating</h3>
            <form onSubmit={submitRating} className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-port-300 mb-1">Your Name<span className="text-port-500 ml-0.5">*</span></label>
                <input
                  type="text"
                  value={memberName}
                  onChange={(e) => setMemberName(e.target.value)}
                  placeholder="Enter your name"
                  className="w-full rounded-lg px-3 py-2 text-sm"
                />
                {ratingErrors.name && <p className="text-red-400 text-xs mt-1">{ratingErrors.name}</p>}
              </div>
              <div>
                <label className="block text-sm font-medium text-port-300 mb-1">Rating<span className="text-port-500 ml-0.5">*</span></label>
                <StarRating rating={newRating} size="lg" interactive onChange={setNewRating} />
                {newRating > 0 && <span className="text-sm text-gold-400 ml-1">{newRating}/10</span>}
                {ratingErrors.rating && <p className="text-red-400 text-xs mt-1">{ratingErrors.rating}</p>}
              </div>
              <div>
                <label className="block text-sm font-medium text-port-300 mb-1">Tasting Notes</label>
                <textarea
                  value={newNotes}
                  onChange={(e) => setNewNotes(e.target.value)}
                  rows={3}
                  placeholder="Your impressions, flavors, finish..."
                  className="w-full rounded-lg px-3 py-2 text-sm"
                />
              </div>
              <button type="submit" disabled={submitting} className="w-full sm:w-auto px-6 py-2.5 rounded-lg bg-gold-600 text-port-950 font-medium hover:bg-gold-500 transition text-sm disabled:opacity-50">
                {submitting ? 'Saving...' : 'Submit Rating'}
              </button>
            </form>
          </div>

          {/* Tasted At Meetings */}
          {portMeetings.length > 0 && (
            <div className="glass rounded-xl p-6 mt-6">
              <h3 className="font-display text-xl text-port-100 mb-4">Tasted At Meetings</h3>
              <div className="space-y-2">
                {portMeetings.map(m => {
                  const d = new Date(m.date + 'T12:00:00');
                  return (
                    <button key={m.id} onClick={() => onNavigateToMeeting && onNavigateToMeeting(m.id)}
                      className="w-full text-left glass-light rounded-lg p-3 hover:bg-white/10 transition flex items-center justify-between">
                      <span className="text-port-100 text-sm">{d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>
                      <span className="text-port-400 text-sm">{m.location}</span>
                    </button>
                  );
                })}
              </div>
            </div>
          )}
        </div>
      );
    }

    /* ───────────────── Port Card (List Item) ───────────────── */

    function PortCard({ port, avgRating, ratingCount, onClick, onQuickRate }) {
      return (
        <div
          onClick={onClick}
          className="glass rounded-xl p-4 cursor-pointer hover:border-port-500/40 transition group"
        >
          <div className="flex items-start justify-between gap-2">
            <div className="min-w-0">
              <span className="inline-block text-[10px] font-medium px-2 py-0.5 rounded-full bg-port-800/60 text-port-300 mb-1.5">{port.type}</span>
              <h3 className="font-display text-lg text-port-100 group-hover:text-gold-400 transition truncate">{port.name}</h3>
              <p className="text-port-400 text-sm truncate">{port.producer}{port.year ? ` \u00B7 ${port.year}` : ''}</p>
            </div>
            <div className="text-right flex-shrink-0">
              <div className="text-2xl font-display text-gold-400">{avgRating ? avgRating.toFixed(1) : '\u2014'}</div>
              <div className="text-[10px] text-port-400">{ratingCount} rating{ratingCount !== 1 ? 's' : ''}</div>
            </div>
          </div>
          {avgRating > 0 && (
            <div className="mt-2">
              <StarRating rating={Math.round(avgRating)} size="sm" />
            </div>
          )}
        </div>
      );
    }

    /* ───────────────── Port List / Home View ───────────────── */

    function PortList({ onSelect, onAdd }) {
      const [ports, setPorts] = useState([]);
      const [ratingsMap, setRatingsMap] = useState({});
      const [loading, setLoading] = useState(true);
      const [search, setSearch] = useState('');
      const [typeFilter, setTypeFilter] = useState('');
      const [sort, setSort] = useState('date-desc');

      const load = useCallback(async () => {
        setLoading(true);
        const ids = (await storage.get('ports:list')) || [];
        const portData = [];
        const ratData = {};
        for (const id of ids) {
          const p = await storage.get(`port:${id}`);
          if (p) {
            portData.push(p);
            const r = await storage.get(`ratings:${id}`);
            ratData[id] = r?.ratings || [];
          }
        }
        setPorts(portData);
        setRatingsMap(ratData);
        setLoading(false);
      }, []);

      useEffect(() => { load(); }, [load]);

      const getAvg = (id) => {
        const r = ratingsMap[id] || [];
        return r.length ? r.reduce((s, x) => s + x.rating, 0) / r.length : 0;
      };

      const filtered = useMemo(() => {
        let list = [...ports];
        if (search) {
          const q = search.toLowerCase();
          list = list.filter((p) => p.name.toLowerCase().includes(q) || p.producer.toLowerCase().includes(q));
        }
        if (typeFilter) list = list.filter((p) => p.type === typeFilter);

        const [field, dir] = sort.split('-');
        list.sort((a, b) => {
          if (field === 'rating') {
            const diff = getAvg(a.id) - getAvg(b.id);
            return dir === 'desc' ? -diff : diff;
          }
          if (field === 'name') {
            const diff = a.name.localeCompare(b.name);
            return dir === 'desc' ? -diff : diff;
          }
          const diff = new Date(a.dateAdded) - new Date(b.dateAdded);
          return dir === 'desc' ? -diff : diff;
        });
        return list;
      }, [ports, search, typeFilter, sort, ratingsMap]);

      if (loading) return <Spinner />;

      return (
        <div className="fade-in">
          {/* Search / Filter Bar */}
          <div className="flex flex-col sm:flex-row gap-3 mb-6">
            <div className="relative flex-1">
              <svg className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-port-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
              <input
                type="text"
                placeholder="Search ports..."
                value={search}
                onChange={(e) => setSearch(e.target.value)}
                className="w-full rounded-lg pl-9 pr-3 py-2.5 text-sm"
              />
            </div>
            <select value={typeFilter} onChange={(e) => setTypeFilter(e.target.value)} className="rounded-lg px-3 py-2.5 text-sm min-w-[130px]">
              <option value="">All Types</option>
              {PORT_TYPES.map((t) => <option key={t} value={t}>{t}</option>)}
            </select>
            <select value={sort} onChange={(e) => setSort(e.target.value)} className="rounded-lg px-3 py-2.5 text-sm min-w-[150px]">
              {SORT_OPTIONS.map((o) => <option key={o.value} value={o.value}>{o.label}</option>)}
            </select>
          </div>

          {/* Port Cards Grid */}
          {filtered.length === 0 ? (
            <div className="text-center py-16">
              {ports.length === 0 ? (
                <>
                  <div className="text-5xl mb-4 opacity-30">&#127863;</div>
                  <p className="text-port-400 mb-4">No ports in the collection yet.</p>
                  <button onClick={onAdd} className="px-5 py-2.5 rounded-lg bg-port-700 text-port-100 hover:bg-port-600 transition text-sm">Add Your First Port</button>
                </>
              ) : (
                <p className="text-port-400">No ports match your search.</p>
              )}
            </div>
          ) : (
            <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
              {filtered.map((p) => (
                <PortCard
                  key={p.id}
                  port={p}
                  avgRating={getAvg(p.id)}
                  ratingCount={(ratingsMap[p.id] || []).length}
                  onClick={() => onSelect(p.id)}
                />
              ))}
            </div>
          )}

          {/* Stats Footer */}
          {ports.length > 0 && (
            <div className="mt-8 pt-6 border-t border-white/5 flex flex-wrap gap-6 text-sm text-port-400">
              <span>{ports.length} port{ports.length !== 1 ? 's' : ''} in collection</span>
              <span>{Object.values(ratingsMap).reduce((s, r) => s + r.length, 0)} total ratings</span>
            </div>
          )}
        </div>
      );
    }

    /* ───────────────── Quick Rate Modal ───────────────── */

    function QuickRateModal({ port, onClose, onSaved }) {
      const [memberName, setMemberName] = useState(() => localStorage.getItem('pc_member') || '');
      const [rating, setRating] = useState(0);
      const [notes, setNotes] = useState('');
      const [saving, setSaving] = useState(false);
      const [errors, setErrors] = useState({});

      const handleSubmit = async (e) => {
        e.preventDefault();
        const errs = {};
        if (!memberName.trim()) errs.name = 'Enter your name';
        if (!rating) errs.rating = 'Select a rating';
        setErrors(errs);
        if (Object.keys(errs).length) return;

        setSaving(true);
        localStorage.setItem('pc_member', memberName.trim());
        const existing = await storage.get(`ratings:${port.id}`);
        const arr = existing?.ratings || [];
        const updated = arr.filter((r) => r.memberName !== memberName.trim());
        updated.push({
          memberName: memberName.trim(),
          rating,
          notes: notes.trim(),
          date: new Date().toISOString(),
        });
        const ok = await storage.set(`ratings:${port.id}`, { portId: port.id, ratings: updated });
        setSaving(false);
        if (ok) onSaved();
        else onSaved('Failed to save');
      };

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm fade-in p-4" onClick={onClose}>
          <div className="glass rounded-xl p-6 max-w-md w-full" onClick={(e) => e.stopPropagation()}>
            <h3 className="font-display text-xl text-port-100 mb-1">Quick Rate</h3>
            <p className="text-port-300 text-sm mb-4">{port.name}</p>
            <form onSubmit={handleSubmit} className="space-y-3">
              <div>
                <input type="text" value={memberName} onChange={(e) => setMemberName(e.target.value)} placeholder="Your name" className="w-full rounded-lg px-3 py-2 text-sm" />
                {errors.name && <p className="text-red-400 text-xs mt-1">{errors.name}</p>}
              </div>
              <div>
                <StarRating rating={rating} size="lg" interactive onChange={setRating} />
                {rating > 0 && <span className="text-sm text-gold-400 ml-1">{rating}/10</span>}
                {errors.rating && <p className="text-red-400 text-xs mt-1">{errors.rating}</p>}
              </div>
              <textarea value={notes} onChange={(e) => setNotes(e.target.value)} rows={2} placeholder="Quick notes (optional)" className="w-full rounded-lg px-3 py-2 text-sm" />
              <div className="flex gap-3 justify-end pt-1">
                <button type="button" onClick={onClose} className="px-4 py-2 rounded-lg glass-light text-port-200 hover:bg-white/10 transition text-sm">Cancel</button>
                <button type="submit" disabled={saving} className="px-4 py-2 rounded-lg bg-gold-600 text-port-950 font-medium hover:bg-gold-500 transition text-sm disabled:opacity-50">
                  {saving ? 'Saving...' : 'Rate'}
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }

    /* ───────────────── Meeting Card ───────────────── */

    function MeetingCard({ meeting, onClick }) {
      const yesCount = meeting.attendees?.filter(a => a.rsvp === 'yes').length || 0;
      const maybeCount = meeting.attendees?.filter(a => a.rsvp === 'maybe').length || 0;
      const dateObj = new Date(meeting.date + 'T12:00:00');
      const isUpcoming = meeting.status === 'upcoming';
      const formatted = dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });

      return (
        <div onClick={onClick} className="glass rounded-xl p-4 cursor-pointer hover:border-port-500/40 transition group">
          <div className="flex items-start justify-between gap-2">
            <div className="min-w-0">
              <span className={`inline-block text-[10px] font-medium px-2 py-0.5 rounded-full mb-1.5 ${
                isUpcoming ? 'bg-emerald-900/40 text-emerald-400' : 'bg-port-800/60 text-port-400'
              }`}>{isUpcoming ? 'Upcoming' : 'Completed'}</span>
              <h3 className="font-display text-lg text-port-100 group-hover:text-gold-400 transition">{formatted}</h3>
              <p className="text-port-400 text-sm truncate">{meeting.location}</p>
            </div>
            <div className="text-right flex-shrink-0">
              <div className="text-sm text-port-300">Host: {meeting.host}</div>
              <div className="text-[10px] text-port-400 mt-1">
                {yesCount > 0 && <span className="text-emerald-400">{yesCount} yes</span>}
                {yesCount > 0 && maybeCount > 0 && <span>, </span>}
                {maybeCount > 0 && <span className="text-gold-400">{maybeCount} maybe</span>}
                {yesCount === 0 && maybeCount === 0 && <span>No RSVPs</span>}
              </div>
            </div>
          </div>
          {meeting.portsTasted?.length > 0 && (
            <div className="mt-2 text-[10px] text-port-500">{meeting.portsTasted.length} port{meeting.portsTasted.length !== 1 ? 's' : ''} tasted</div>
          )}
        </div>
      );
    }

    /* ───────────────── Meeting List ───────────────── */

    function MeetingList({ onSelect, onAdd }) {
      const [meetings, setMeetings] = useState([]);
      const [loading, setLoading] = useState(true);

      const load = useCallback(async () => {
        setLoading(true);
        const ids = (await storage.get('meetings:list')) || [];
        const data = [];
        for (const id of ids) {
          const m = await storage.get(`meeting:${id}`);
          if (m) data.push(m);
        }
        setMeetings(data);
        setLoading(false);
      }, []);

      useEffect(() => { load(); }, [load]);

      const today = new Date().toISOString().slice(0, 10);
      const upcoming = meetings
        .filter(m => m.status === 'upcoming' || m.date >= today)
        .sort((a, b) => a.date.localeCompare(b.date));
      const past = meetings
        .filter(m => m.status === 'completed' && m.date < today)
        .sort((a, b) => b.date.localeCompare(a.date));

      if (loading) return <Spinner />;

      return (
        <div className="fade-in">
          {meetings.length === 0 ? (
            <div className="text-center py-16">
              <div className="text-5xl mb-4 opacity-30">&#128197;</div>
              <p className="text-port-400 mb-4">No meetings scheduled yet.</p>
              <button onClick={onAdd} className="px-5 py-2.5 rounded-lg bg-port-700 text-port-100 hover:bg-port-600 transition text-sm">Create First Meeting</button>
            </div>
          ) : (
            <>
              {upcoming.length > 0 && (
                <div className="mb-8">
                  <h3 className="text-xs font-semibold text-port-400 uppercase tracking-wider mb-3">Upcoming</h3>
                  <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                    {upcoming.map(m => <MeetingCard key={m.id} meeting={m} onClick={() => onSelect(m.id)} />)}
                  </div>
                </div>
              )}
              {past.length > 0 && (
                <div>
                  <h3 className="text-xs font-semibold text-port-400 uppercase tracking-wider mb-3">Past Meetings</h3>
                  <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                    {past.map(m => <MeetingCard key={m.id} meeting={m} onClick={() => onSelect(m.id)} />)}
                  </div>
                </div>
              )}
              <div className="mt-8 pt-6 border-t border-white/5 flex flex-wrap gap-6 text-sm text-port-400">
                <span>{upcoming.length} upcoming</span>
                <span>{past.length} past meeting{past.length !== 1 ? 's' : ''}</span>
              </div>
            </>
          )}
        </div>
      );
    }

    /* ───────────────── Meeting Form ───────────────── */

    function MeetingForm({ meeting, onSave, onCancel }) {
      const isEdit = !!meeting;
      const [form, setForm] = useState({
        date: meeting?.date || '',
        location: meeting?.location || '',
        host: meeting?.host || localStorage.getItem('pc_member') || '',
        status: meeting?.status || 'upcoming',
        notes: meeting?.notes || '',
      });
      const [errors, setErrors] = useState({});
      const [saving, setSaving] = useState(false);

      const validate = () => {
        const errs = {};
        if (!form.date) errs.date = 'Date is required';
        if (!form.location.trim()) errs.location = 'Location is required';
        if (!form.host.trim()) errs.host = 'Host is required';
        setErrors(errs);
        return Object.keys(errs).length === 0;
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!validate()) return;
        setSaving(true);
        await onSave({ ...form, location: form.location.trim(), host: form.host.trim(), notes: form.notes.trim() });
        setSaving(false);
      };

      const field = (label, key, type = 'text', opts = {}) => (
        <div className={opts.full ? 'sm:col-span-2' : ''}>
          <label className="block text-sm font-medium text-port-300 mb-1">{label}{opts.required && <span className="text-port-500 ml-0.5">*</span>}</label>
          {opts.textarea ? (
            <textarea value={form[key]} onChange={(e) => setForm({ ...form, [key]: e.target.value })} rows={3} placeholder={opts.placeholder || ''} className="w-full rounded-lg px-3 py-2 text-sm" />
          ) : opts.select ? (
            <select value={form[key]} onChange={(e) => setForm({ ...form, [key]: e.target.value })} className="w-full rounded-lg px-3 py-2 text-sm">
              {opts.options.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
            </select>
          ) : (
            <input type={type} value={form[key]} onChange={(e) => setForm({ ...form, [key]: e.target.value })} placeholder={opts.placeholder || ''} className="w-full rounded-lg px-3 py-2 text-sm" />
          )}
          {errors[key] && <p className="text-red-400 text-xs mt-1">{errors[key]}</p>}
        </div>
      );

      return (
        <div className="fade-in max-w-2xl mx-auto">
          <button onClick={onCancel} className="flex items-center gap-1 text-port-400 hover:text-port-200 mb-4 transition text-sm">
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg>
            Back
          </button>
          <div className="glass rounded-xl p-6">
            <h2 className="font-display text-2xl text-port-100 mb-6">{isEdit ? 'Edit Meeting' : 'Create Meeting'}</h2>
            <form onSubmit={handleSubmit} className="grid sm:grid-cols-2 gap-4">
              {field('Date', 'date', 'date', { required: true })}
              {field('Location', 'location', 'text', { required: true, placeholder: "e.g. John's house" })}
              {field('Host', 'host', 'text', { required: true, placeholder: 'Who is hosting?' })}
              {field('Status', 'status', 'text', { select: true, options: [{ value: 'upcoming', label: 'Upcoming' }, { value: 'completed', label: 'Completed' }] })}
              {field('Notes', 'notes', 'text', { textarea: true, full: true, placeholder: 'Details, what to bring, theme...' })}
              <div className="sm:col-span-2 flex gap-3 justify-end pt-2">
                <button type="button" onClick={onCancel} className="px-5 py-2.5 rounded-lg glass-light text-port-200 hover:bg-white/10 transition text-sm">Cancel</button>
                <button type="submit" disabled={saving} className="px-5 py-2.5 rounded-lg bg-port-700 text-port-100 hover:bg-port-600 transition text-sm disabled:opacity-50">
                  {saving ? 'Saving...' : isEdit ? 'Update Meeting' : 'Create Meeting'}
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }

    /* ───────────────── Port Picker Modal ───────────────── */

    function PortPicker({ linkedIds, onSelect, onClose }) {
      const [ports, setPorts] = useState([]);
      const [search, setSearch] = useState('');
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        (async () => {
          const ids = (await storage.get('ports:list')) || [];
          const data = [];
          for (const id of ids) {
            const p = await storage.get(`port:${id}`);
            if (p) data.push(p);
          }
          setPorts(data);
          setLoading(false);
        })();
      }, []);

      const filtered = search
        ? ports.filter(p => p.name.toLowerCase().includes(search.toLowerCase()) || p.producer.toLowerCase().includes(search.toLowerCase()))
        : ports;

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm fade-in p-4" onClick={onClose}>
          <div className="glass rounded-xl p-6 max-w-md w-full max-h-[80vh] flex flex-col" onClick={e => e.stopPropagation()}>
            <h3 className="font-display text-xl text-port-100 mb-3">Add Port to Meeting</h3>
            <input
              type="text" value={search} onChange={e => setSearch(e.target.value)}
              placeholder="Search ports..." className="w-full rounded-lg px-3 py-2 text-sm mb-3"
            />
            <div className="overflow-y-auto flex-1 space-y-1 min-h-0">
              {loading ? <Spinner /> : filtered.length === 0 ? (
                <p className="text-port-400 text-sm text-center py-4">No ports found.</p>
              ) : filtered.map(p => {
                const linked = linkedIds.includes(p.id);
                return (
                  <button key={p.id} disabled={linked} onClick={() => onSelect(p.id)}
                    className={`w-full text-left rounded-lg p-3 transition text-sm ${linked ? 'opacity-40 cursor-default' : 'glass-light hover:bg-white/10 cursor-pointer'}`}>
                    <span className="text-port-100">{p.name}</span>
                    <span className="text-port-400 ml-2">{p.producer}</span>
                    {linked && <span className="text-port-500 ml-2 text-xs">(linked)</span>}
                  </button>
                );
              })}
            </div>
            <button onClick={onClose} className="mt-3 w-full px-4 py-2 rounded-lg glass-light text-port-200 hover:bg-white/10 transition text-sm">Close</button>
          </div>
        </div>
      );
    }

    /* ───────────────── Meeting Detail View ───────────────── */

    function MeetingDetail({ meetingId, onBack, onEdit, showToast, onNavigateToPort }) {
      const [meeting, setMeeting] = useState(null);
      const [loading, setLoading] = useState(true);
      const [showConfirm, setShowConfirm] = useState(false);
      const [showPortPicker, setShowPortPicker] = useState(false);
      const [linkedPorts, setLinkedPorts] = useState([]);
      // RSVP form
      const [rsvpName, setRsvpName] = useState(() => localStorage.getItem('pc_member') || '');
      const [rsvpStatus, setRsvpStatus] = useState('yes');
      const [rsvpBringing, setRsvpBringing] = useState('');
      const [rsvpErrors, setRsvpErrors] = useState({});

      const load = useCallback(async () => {
        setLoading(true);
        const m = await storage.get(`meeting:${meetingId}`);
        setMeeting(m);
        if (m?.portsTasted?.length) {
          const pList = [];
          for (const pid of m.portsTasted) {
            const p = await storage.get(`port:${pid}`);
            if (p) pList.push(p);
          }
          setLinkedPorts(pList);
        }
        setLoading(false);
      }, [meetingId]);

      useEffect(() => { load(); }, [load]);

      const submitRsvp = async (e) => {
        e.preventDefault();
        const errs = {};
        if (!rsvpName.trim()) errs.name = 'Enter your name';
        setRsvpErrors(errs);
        if (Object.keys(errs).length) return;

        localStorage.setItem('pc_member', rsvpName.trim());
        const updated = (meeting.attendees || []).filter(a => a.name !== rsvpName.trim());
        updated.push({ name: rsvpName.trim(), rsvp: rsvpStatus, bringing: rsvpBringing.trim() });
        const newMeeting = { ...meeting, attendees: updated };
        const ok = await storage.set(`meeting:${meetingId}`, newMeeting);
        if (ok) {
          setMeeting(newMeeting);
          setRsvpBringing('');
          showToast('RSVP saved!');
        } else {
          showToast('Failed to save RSVP', 'error');
        }
      };

      const linkPort = async (portId) => {
        const updatedPorts = [...(meeting.portsTasted || []), portId];
        const newMeeting = { ...meeting, portsTasted: updatedPorts };
        await storage.set(`meeting:${meetingId}`, newMeeting);
        // Update port's datesTasted
        const port = await storage.get(`port:${portId}`);
        if (port) {
          const datesTasted = port.datesTasted || [];
          if (!datesTasted.includes(meeting.date)) {
            datesTasted.push(meeting.date);
            await storage.set(`port:${portId}`, { ...port, datesTasted });
          }
        }
        setMeeting(newMeeting);
        if (port) setLinkedPorts([...linkedPorts, port]);
        setShowPortPicker(false);
        showToast('Port linked!');
      };

      const unlinkPort = async (portId) => {
        const updatedPorts = (meeting.portsTasted || []).filter(id => id !== portId);
        const newMeeting = { ...meeting, portsTasted: updatedPorts };
        await storage.set(`meeting:${meetingId}`, newMeeting);
        // Remove date from port's datesTasted
        const port = await storage.get(`port:${portId}`);
        if (port && port.datesTasted) {
          port.datesTasted = port.datesTasted.filter(d => d !== meeting.date);
          await storage.set(`port:${portId}`, port);
        }
        setMeeting(newMeeting);
        setLinkedPorts(linkedPorts.filter(p => p.id !== portId));
        showToast('Port unlinked');
      };

      const handleDelete = async () => {
        const list = (await storage.get('meetings:list')) || [];
        await storage.set('meetings:list', list.filter(id => id !== meetingId));
        await storage.set(`meeting:${meetingId}`, null);
        showToast('Meeting deleted');
        onBack();
      };

      if (loading) return <Spinner />;
      if (!meeting) return <p className="text-center text-port-400 py-12">Meeting not found.</p>;

      const dateObj = new Date(meeting.date + 'T12:00:00');
      const formatted = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
      const isUpcoming = meeting.status === 'upcoming';
      const attendees = meeting.attendees || [];

      return (
        <div className="fade-in max-w-2xl mx-auto">
          {showConfirm && (
            <ConfirmDialog
              title="Delete Meeting"
              message={`Are you sure you want to delete this meeting on ${formatted}?`}
              onConfirm={handleDelete}
              onCancel={() => setShowConfirm(false)}
            />
          )}
          {showPortPicker && (
            <PortPicker
              linkedIds={meeting.portsTasted || []}
              onSelect={linkPort}
              onClose={() => setShowPortPicker(false)}
            />
          )}

          <button onClick={onBack} className="flex items-center gap-1 text-port-400 hover:text-port-200 mb-4 transition text-sm">
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg>
            Back to meetings
          </button>

          {/* Meeting Info */}
          <div className="glass rounded-xl p-6 mb-6">
            <div className="flex flex-wrap items-start justify-between gap-3 mb-4">
              <div>
                <span className={`inline-block text-xs font-medium px-2.5 py-1 rounded-full mb-2 ${
                  isUpcoming ? 'bg-emerald-900/40 text-emerald-400' : 'bg-port-800/60 text-port-300'
                }`}>{isUpcoming ? 'Upcoming' : 'Completed'}</span>
                <h2 className="font-display text-2xl sm:text-3xl text-port-100">{formatted}</h2>
                <p className="text-port-300 mt-0.5">{meeting.location} &middot; Hosted by {meeting.host}</p>
              </div>
            </div>
            {meeting.notes && (
              <div className="mb-3">
                <h4 className="text-xs font-semibold text-port-400 uppercase tracking-wider mb-1">Notes</h4>
                <p className="text-port-200 text-sm leading-relaxed">{meeting.notes}</p>
              </div>
            )}
            <div className="flex gap-2 mt-5 pt-4 border-t border-white/5">
              <button onClick={() => onEdit(meeting)} className="flex items-center gap-1.5 text-sm text-port-300 hover:text-port-100 transition">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                Edit
              </button>
              <button onClick={() => setShowConfirm(true)} className="flex items-center gap-1.5 text-sm text-red-400/70 hover:text-red-400 transition ml-4">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                Delete
              </button>
            </div>
          </div>

          {/* RSVPs */}
          <div className="glass rounded-xl p-6 mb-6">
            <h3 className="font-display text-xl text-port-100 mb-4">RSVPs ({attendees.length})</h3>
            {attendees.length > 0 && (
              <div className="space-y-2 mb-6">
                {attendees.map((a, i) => (
                  <div key={i} className="glass-light rounded-lg p-3 flex items-center justify-between gap-2">
                    <div className="min-w-0">
                      <span className="text-port-100 text-sm font-medium">{a.name}</span>
                      {a.bringing && <span className="text-port-400 text-xs ml-2">Bringing: {a.bringing}</span>}
                    </div>
                    <span className={`text-xs font-medium px-2 py-0.5 rounded-full flex-shrink-0 ${
                      a.rsvp === 'yes' ? 'bg-emerald-900/40 text-emerald-400' :
                      a.rsvp === 'maybe' ? 'bg-yellow-900/40 text-gold-400' :
                      'bg-red-900/40 text-red-400'
                    }`}>{a.rsvp}</span>
                  </div>
                ))}
              </div>
            )}
            <h4 className="text-sm font-medium text-port-300 mb-3">Add Your RSVP</h4>
            <form onSubmit={submitRsvp} className="space-y-3">
              <div>
                <input type="text" value={rsvpName} onChange={e => setRsvpName(e.target.value)} placeholder="Your name" className="w-full rounded-lg px-3 py-2 text-sm" />
                {rsvpErrors.name && <p className="text-red-400 text-xs mt-1">{rsvpErrors.name}</p>}
              </div>
              <div>
                <label className="block text-sm font-medium text-port-300 mb-2">Attending?</label>
                <div className="flex gap-2">
                  {[{ v: 'yes', l: 'Yes', c: 'emerald' }, { v: 'maybe', l: 'Maybe', c: 'gold' }, { v: 'no', l: 'No', c: 'red' }].map(opt => (
                    <button key={opt.v} type="button" onClick={() => setRsvpStatus(opt.v)}
                      className={`px-4 py-1.5 rounded-full text-sm font-medium transition ${
                        rsvpStatus === opt.v
                          ? opt.c === 'emerald' ? 'bg-emerald-900/60 text-emerald-400 border border-emerald-500/30'
                          : opt.c === 'gold' ? 'bg-yellow-900/60 text-gold-400 border border-gold-500/30'
                          : 'bg-red-900/60 text-red-400 border border-red-500/30'
                          : 'glass-light text-port-300 border border-transparent hover:bg-white/5'
                      }`}>{opt.l}</button>
                  ))}
                </div>
              </div>
              <div>
                <input type="text" value={rsvpBringing} onChange={e => setRsvpBringing(e.target.value)} placeholder="What are you bringing? (optional)" className="w-full rounded-lg px-3 py-2 text-sm" />
              </div>
              <button type="submit" className="px-5 py-2.5 rounded-lg bg-gold-600 text-port-950 font-medium hover:bg-gold-500 transition text-sm">Save RSVP</button>
            </form>
          </div>

          {/* Ports Tasted */}
          <div className="glass rounded-xl p-6">
            <div className="flex items-center justify-between mb-4">
              <h3 className="font-display text-xl text-port-100">Ports Tasted</h3>
              <button onClick={() => setShowPortPicker(true)} className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg glass-light text-port-200 hover:bg-white/10 transition text-sm">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>
                Add Port
              </button>
            </div>
            {linkedPorts.length === 0 ? (
              <p className="text-port-400 text-sm">No ports linked to this meeting yet.</p>
            ) : (
              <div className="space-y-2">
                {linkedPorts.map(p => (
                  <div key={p.id} className="glass-light rounded-lg p-3 flex items-center justify-between gap-2">
                    <button onClick={() => onNavigateToPort(p.id)} className="text-left min-w-0 hover:text-gold-400 transition">
                      <span className="text-port-100 text-sm font-medium">{p.name}</span>
                      <span className="text-port-400 text-xs ml-2">{p.producer}{p.year ? ` \u00B7 ${p.year}` : ''}</span>
                    </button>
                    <button onClick={() => unlinkPort(p.id)} className="text-port-500 hover:text-red-400 transition flex-shrink-0" title="Unlink port">
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      );
    }

    /* ───────────────── Export Function ───────────────── */

    async function exportData() {
      const ids = (await storage.get('ports:list')) || [];
      const data = { ports: [], ratings: {}, meetings: [] };
      for (const id of ids) {
        const p = await storage.get(`port:${id}`);
        if (p) data.ports.push(p);
        const r = await storage.get(`ratings:${id}`);
        if (r) data.ratings[id] = r;
      }
      const meetingIds = (await storage.get('meetings:list')) || [];
      for (const id of meetingIds) {
        const m = await storage.get(`meeting:${id}`);
        if (m) data.meetings.push(m);
      }
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `port-committee-export-${new Date().toISOString().slice(0, 10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    /* ───────────────── Main App ───────────────── */

    function App() {
      // Section navigation
      const [section, setSection] = useState('ports'); // ports | meetings
      // Port views
      const [view, setView] = useState('list'); // list | add | detail | edit
      const [selectedPort, setSelectedPort] = useState(null);
      const [editPort, setEditPort] = useState(null);
      // Meeting views
      const [meetingView, setMeetingView] = useState('list'); // list | add | detail | edit
      const [selectedMeeting, setSelectedMeeting] = useState(null);
      const [editMeeting, setEditMeeting] = useState(null);
      // Shared
      const [toast, setToast] = useState(null);
      const [quickRate, setQuickRate] = useState(null);

      const showToast = useCallback((message, type = 'success') => {
        setToast({ message, type });
      }, []);

      const handleAddPort = async (data) => {
        const id = `port_${Date.now()}`;
        const port = {
          id,
          ...data,
          dateAdded: new Date().toISOString(),
          datesTasted: [],
        };
        const ok1 = await storage.set(`port:${id}`, port);
        const ids = (await storage.get('ports:list')) || [];
        ids.push(id);
        const ok2 = await storage.set('ports:list', ids);
        if (ok1 && ok2) {
          showToast('Port added successfully!');
          setView('list');
        } else {
          showToast('Failed to save port', 'error');
        }
      };

      const handleEditPort = async (data) => {
        const updated = { ...editPort, ...data };
        const ok = await storage.set(`port:${editPort.id}`, updated);
        if (ok) {
          showToast('Port updated!');
          setSelectedPort(editPort.id);
          setView('detail');
          setEditPort(null);
        } else {
          showToast('Failed to update port', 'error');
        }
      };

      const handleAddMeeting = async (data) => {
        const id = `meeting_${Date.now()}`;
        const meeting = {
          id,
          ...data,
          attendees: [],
          portsTasted: [],
          dateCreated: new Date().toISOString(),
        };
        const ok1 = await storage.set(`meeting:${id}`, meeting);
        const ids = (await storage.get('meetings:list')) || [];
        ids.push(id);
        const ok2 = await storage.set('meetings:list', ids);
        if (ok1 && ok2) {
          showToast('Meeting created!');
          setMeetingView('list');
        } else {
          showToast('Failed to save meeting', 'error');
        }
      };

      const handleEditMeeting = async (data) => {
        const updated = { ...editMeeting, ...data, attendees: editMeeting.attendees, portsTasted: editMeeting.portsTasted };
        const ok = await storage.set(`meeting:${editMeeting.id}`, updated);
        if (ok) {
          showToast('Meeting updated!');
          setSelectedMeeting(editMeeting.id);
          setMeetingView('detail');
          setEditMeeting(null);
        } else {
          showToast('Failed to update meeting', 'error');
        }
      };

      return (
        <div className="min-h-screen">
          {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
          {quickRate && (
            <QuickRateModal
              port={quickRate}
              onClose={() => setQuickRate(null)}
              onSaved={(err) => {
                setQuickRate(null);
                showToast(err || 'Rating saved!', err ? 'error' : 'success');
                setView('list');
              }}
            />
          )}

          {/* Header */}
          <header className="border-b border-white/5">
            <div className="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
              <button onClick={() => { setSection('ports'); setView('list'); setSelectedPort(null); }} className="flex items-center gap-2.5 group">
                <span className="text-2xl">&#127863;</span>
                <h1 className="font-display text-xl text-port-100 group-hover:text-gold-400 transition leading-tight">Port Committee</h1>
              </button>
              <div className="flex gap-2">
                <ThemeSwitcher />
                <button
                  onClick={exportData}
                  className="p-2 rounded-lg glass-light text-port-400 hover:text-port-200 transition"
                  title="Export Data"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                </button>
                {section === 'ports' && view !== 'add' && (
                  <button
                    onClick={() => setView('add')}
                    className="flex items-center gap-1.5 px-4 py-2 rounded-lg bg-port-700 text-port-100 hover:bg-port-600 transition text-sm"
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>
                    Add Port
                  </button>
                )}
                {section === 'meetings' && meetingView !== 'add' && (
                  <button
                    onClick={() => setMeetingView('add')}
                    className="flex items-center gap-1.5 px-4 py-2 rounded-lg bg-port-700 text-port-100 hover:bg-port-600 transition text-sm"
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>
                    Create Meeting
                  </button>
                )}
              </div>
            </div>
            {/* Section Tabs */}
            <div className="max-w-5xl mx-auto px-4 flex gap-1">
              <button
                onClick={() => { setSection('ports'); setView('list'); setSelectedPort(null); setEditPort(null); }}
                className={`px-4 py-2 text-sm font-medium transition border-b-2 ${
                  section === 'ports'
                    ? 'text-port-100 border-gold-500'
                    : 'text-port-400 border-transparent hover:text-port-200'
                }`}
              >
                Ports
              </button>
              <button
                onClick={() => { setSection('meetings'); setMeetingView('list'); setSelectedMeeting(null); setEditMeeting(null); }}
                className={`px-4 py-2 text-sm font-medium transition border-b-2 ${
                  section === 'meetings'
                    ? 'text-port-100 border-gold-500'
                    : 'text-port-400 border-transparent hover:text-port-200'
                }`}
              >
                Meetings
              </button>
            </div>
          </header>

          {/* Main Content */}
          <main className="max-w-5xl mx-auto px-4 py-6">
            {section === 'ports' && (
              <>
                {view === 'list' && (
                  <PortList
                    key={Date.now()}
                    onSelect={(id) => { setSelectedPort(id); setView('detail'); }}
                    onAdd={() => setView('add')}
                  />
                )}
                {view === 'add' && (
                  <PortForm
                    onSave={handleAddPort}
                    onCancel={() => setView('list')}
                  />
                )}
                {view === 'edit' && editPort && (
                  <PortForm
                    port={editPort}
                    onSave={handleEditPort}
                    onCancel={() => { setView('detail'); setEditPort(null); }}
                  />
                )}
                {view === 'detail' && selectedPort && (
                  <PortDetail
                    key={selectedPort}
                    portId={selectedPort}
                    onBack={() => { setView('list'); setSelectedPort(null); }}
                    onEdit={(p) => { setEditPort(p); setView('edit'); }}
                    onDelete={() => { setView('list'); setSelectedPort(null); }}
                    showToast={showToast}
                    onNavigateToMeeting={(mid) => { setSection('meetings'); setSelectedMeeting(mid); setMeetingView('detail'); }}
                  />
                )}
              </>
            )}
            {section === 'meetings' && (
              <>
                {meetingView === 'list' && (
                  <MeetingList
                    key={Date.now()}
                    onSelect={(id) => { setSelectedMeeting(id); setMeetingView('detail'); }}
                    onAdd={() => setMeetingView('add')}
                  />
                )}
                {meetingView === 'add' && (
                  <MeetingForm
                    onSave={handleAddMeeting}
                    onCancel={() => setMeetingView('list')}
                  />
                )}
                {meetingView === 'edit' && editMeeting && (
                  <MeetingForm
                    meeting={editMeeting}
                    onSave={handleEditMeeting}
                    onCancel={() => { setMeetingView('detail'); setEditMeeting(null); }}
                  />
                )}
                {meetingView === 'detail' && selectedMeeting && (
                  <MeetingDetail
                    key={selectedMeeting}
                    meetingId={selectedMeeting}
                    onBack={() => { setMeetingView('list'); setSelectedMeeting(null); }}
                    onEdit={(m) => { setEditMeeting(m); setMeetingView('edit'); }}
                    showToast={showToast}
                    onNavigateToPort={(portId) => { setSection('ports'); setSelectedPort(portId); setView('detail'); }}
                  />
                )}
              </>
            )}
          </main>
        </div>
      );
    }

    /* ───────────────── Mount ───────────────── */
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
