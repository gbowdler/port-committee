<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Port Committee</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            port: {
              50: '#fdf2f8',
              100: '#fce7f3',
              200: '#f5d0e0',
              300: '#e8a0c0',
              400: '#d4658f',
              500: '#b8396b',
              600: '#9b1b50',
              700: '#7a1240',
              800: '#5c0e30',
              900: '#3d0920',
              950: '#2a0615',
            },
            gold: {
              300: '#fcd34d',
              400: '#f6c344',
              500: '#d4a23a',
              600: '#b8860b',
            },
          },
        },
      },
    };
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap');

    /* ── Base body styles ── */
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #1a0505 0%, #2d0a0a 100%);
      background-attachment: fixed;
      position: relative;
      min-height: 100vh;
    }

    /* ── Dynamic theme background layers ── */
    #theme-bg {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      transition: opacity 0.6s ease;
    }
    #theme-bg { opacity: 0; }
    #theme-bg.active { opacity: 1; }

    /* ── Shared styles (always active) ── */
    #root { position: relative; z-index: 1; }

    h1, h2, h3, .font-display { font-family: 'Playfair Display', serif; }
    .glass { background: rgba(92, 14, 48, 0.25); backdrop-filter: blur(12px); border: 1px solid rgba(184, 57, 107, 0.2); }
    .glass-light { background: rgba(255,255,255,0.04); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.08); }
    .star-glow { filter: drop-shadow(0 0 3px rgba(212,162,58,0.5)); }
    input, select, textarea {
      background: rgba(255,255,255,0.06) !important;
      border: 1px solid rgba(255,255,255,0.12) !important;
      color: #f5d0e0 !important;
    }
    input::placeholder, textarea::placeholder { color: rgba(245,208,224,0.4) !important; }
    input:focus, select:focus, textarea:focus {
      outline: none !important;
      border-color: rgba(184,57,107,0.6) !important;
      box-shadow: 0 0 0 2px rgba(184,57,107,0.2) !important;
    }
    select option { background: #3d0920; color: #f5d0e0; }
    .fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
    ::-webkit-scrollbar-thumb { background: rgba(184,57,107,0.4); border-radius: 3px; }

    /* ── Landing page ── */
    .landing {
      position: fixed;
      inset: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #1a0505 0%, #2d0a0a 100%);
      transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .landing.exit {
      opacity: 0;
      pointer-events: none;
    }
    .landing-contours {
      position: absolute;
      inset: 0;
      opacity: 0;
      animation: landingLayer 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.1s forwards;
    }
    .landing-headline {
      opacity: 0;
      transform: translateY(10px);
      animation: landingReveal 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.6s forwards;
    }
    .landing-sub {
      opacity: 0;
      transform: translateY(10px);
      animation: landingReveal 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94) 1.1s forwards;
    }
    .landing-btn {
      opacity: 0;
      transform: translateY(10px);
      animation: landingReveal 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94) 1.6s forwards;
    }
    @keyframes landingLayer {
      from { opacity: 0; }
      to   { opacity: 1; }
    }
    @keyframes landingReveal {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .landing-enter {
      display: inline-block;
      padding: 14px 48px;
      border-radius: 9999px;
      border: 1px solid rgba(242, 236, 228, 0.18);
      color: #f2ece4;
      font-family: 'Inter', sans-serif;
      font-weight: 300;
      font-size: 0.9rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      background: transparent;
      cursor: pointer;
      box-shadow: 0 0 20px rgba(242, 236, 228, 0.04);
      transition: border-color 0.4s, box-shadow 0.4s, letter-spacing 0.4s;
    }
    .landing-enter:hover {
      border-color: rgba(242, 236, 228, 0.35);
      box-shadow: 0 0 30px rgba(242, 236, 228, 0.08);
      letter-spacing: 0.24em;
    }

    /* ── Dashboard ── */
    .dashboard-view {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      animation: dashFadeIn 0.5s ease-out;
    }
    @keyframes dashFadeIn {
      from { opacity: 0; }
      to   { opacity: 1; }
    }
    .dashboard-card {
      background: rgba(92, 14, 48, 0.18);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(184, 57, 107, 0.15);
      border-radius: 1rem;
      padding: 1.5rem 2rem;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      max-width: 400px;
    }
    .dashboard-card:hover {
      background: rgba(92, 14, 48, 0.35);
      border-color: rgba(184, 57, 107, 0.35);
      transform: translateY(-2px);
      box-shadow: 0 8px 32px rgba(92, 14, 48, 0.3);
    }
    .dashboard-card-0 {
      opacity: 0; transform: translateY(10px);
    }
    .dashboard-card-1 {
      opacity: 0; transform: translateY(10px);
    }
    .dashboard-card-2 {
      opacity: 0; transform: translateY(10px);
    }
    .dashboard-title {
      opacity: 0; transform: translateY(10px);
    }
    .dashboard-content-visible .dashboard-title {
      animation: landingReveal 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0s forwards;
    }
    .dashboard-content-visible .dashboard-card-0 {
      animation: landingReveal 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.15s forwards;
    }
    .dashboard-content-visible .dashboard-card-1 {
      animation: landingReveal 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.35s forwards;
    }
    .dashboard-content-visible .dashboard-card-2 {
      animation: landingReveal 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.55s forwards;
    }

    /* ── Section enter transition ── */
    .section-enter {
      animation: dashFadeIn 0.5s ease-out;
    }
  </style>
</head>
<body class="min-h-screen text-port-200">
  <div id="theme-bg"></div>
  <div id="root"></div>

  <script type="text/babel">
    /*
     * PORT COMMITTEE APP
     *
     * STORAGE: Firebase Firestore (cloud-based, shared across all users)
     *
     * All Port Committee members access the same data in real-time.
     * Data is stored in Google's Firebase cloud infrastructure.
     *
     * File attachments are stored in Firebase Storage.
     */

    const { useState, useEffect, useCallback, useMemo, useRef } = React;

    /* ───────────────── Firebase Initialization ───────────────── */

    const firebaseConfig = {
      apiKey: "AIzaSyAdBfk1roLWIrND0UpsCyejcirT0RVXtbM",
      authDomain: "port-committee.firebaseapp.com",
      projectId: "port-committee",
      storageBucket: "port-committee.firebasestorage.app",
      messagingSenderId: "603218289835",
      appId: "1:603218289835:web:e95d41e140dc53818843ee",
      measurementId: "G-CLYQ44S74E"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const firebaseStorage = firebase.storage();
    const auth = firebase.auth();
    auth.useDeviceLanguage();

    /* ───────────────── Phone Auth ───────────────── */

    // Approved Port Committee members
    const APPROVED_PHONE_NUMBERS = [
      '+447732118690',  // Gareth B
      '+447577409988',  // Duncan
      '+447792519392',  // Felix
      '+447730590696',  // Nick L
      '+447960855016',  // Chris C
      '+447964561290',  // Craig
      '+447375470442',  // David
      '+447507634516',  // Joe
      '+447801991387',  // Wardy
    ];

    function isPhoneApproved(phoneNumber) {
      const normalized = phoneNumber.replace(/\s/g, '');
      return APPROVED_PHONE_NUMBERS.includes(normalized);
    }

    async function getUserProfile(userId) {
      try {
        const doc = await db.collection('portCommittee').doc(`user_profile:${userId}`).get();
        return doc.exists ? doc.data() : null;
      } catch (e) {
        console.error('Error loading user profile:', e);
        return null;
      }
    }

    async function saveUserProfile(userId, name) {
      await db.collection('portCommittee').doc(`user_profile:${userId}`).set({
        name,
        userId,
        phoneNumber: auth.currentUser?.phoneNumber || '',
        createdAt: new Date().toISOString(),
        lastLogin: new Date().toISOString(),
      });
    }

    async function updateLastLogin(userId) {
      try {
        await db.collection('portCommittee').doc(`user_profile:${userId}`).update({
          lastLogin: new Date().toISOString(),
        });
      } catch (e) {
        console.error('Error updating last login:', e);
      }
    }

    /* ───────────────── Storage Helpers ───────────────── */

    const storage = {
      async get(key) {
        try {
          const doc = await db.collection('portCommittee').doc(key).get();
          return doc.exists ? doc.data().value : null;
        } catch (error) {
          console.error('Storage get error:', error);
          return null;
        }
      },
      async set(key, value) {
        try {
          if (value === null || value === undefined) {
            await db.collection('portCommittee').doc(key).delete();
          } else {
            await db.collection('portCommittee').doc(key).set({ value });
          }
          return true;
        } catch (error) {
          console.error('Storage set error:', error);
          return false;
        }
      },
      async remove(key) {
        try {
          await db.collection('portCommittee').doc(key).delete();
          return true;
        } catch (error) {
          console.error('Storage remove error:', error);
          return false;
        }
      },
      async getMulti(keys) {
        return Promise.all(keys.map(key => this.get(key)));
      },
    };

    /* ───────────────── Constants ───────────────── */

    const PORT_TYPES = ['Vintage', 'Tawny', 'Ruby', 'LBV', 'White', 'Rose', 'Crusted'];

    const SORT_OPTIONS = [
      { value: 'rating-desc', label: 'Highest Rated' },
      { value: 'rating-asc', label: 'Lowest Rated' },
      { value: 'name-asc', label: 'Name A-Z' },
      { value: 'name-desc', label: 'Name Z-A' },
      { value: 'date-desc', label: 'Newest First' },
      { value: 'date-asc', label: 'Oldest First' },
    ];

    /* ───────────────── Theme ───────────────── */

    const DOURO_BG = 'radial-gradient(ellipse 80% 60% at 50% 40%, rgba(122, 18, 64, 0.3) 0%, transparent 70%), url("data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 1200 900\'%3E%3Cdefs%3E%3Cstyle%3Epath%7Bfill:none;stroke:%23e8a0c0;stroke-linecap:round%7D%3C/style%3E%3C/defs%3E%3Cg opacity=\'0.06\'%3E%3Cpath d=\'M-20 80 Q150 40 300 90 T600 70 T900 100 T1220 60\' stroke-width=\'1.2\'/%3E%3Cpath d=\'M-20 130 Q180 95 350 140 T650 115 T950 150 T1220 110\' stroke-width=\'1\'/%3E%3Cpath d=\'M-20 185 Q120 155 280 190 T580 170 T880 200 T1220 165\' stroke-width=\'1.3\'/%3E%3Cpath d=\'M-20 240 Q200 210 380 245 T700 225 T980 255 T1220 220\' stroke-width=\'0.8\'/%3E%3Cpath d=\'M-20 295 Q160 270 320 300 T640 280 T940 310 T1220 275\' stroke-width=\'1.1\'/%3E%3Cpath d=\'M-20 350 Q140 325 310 355 T620 340 T920 365 T1220 335\' stroke-width=\'1\'/%3E%3Cpath d=\'M-20 410 Q190 385 370 415 T680 395 T960 420 T1220 390\' stroke-width=\'1.2\'/%3E%3Cpath d=\'M-20 465 Q130 445 290 470 T590 455 T890 475 T1220 450\' stroke-width=\'0.9\'/%3E%3Cpath d=\'M-20 520 Q170 500 340 525 T660 510 T940 535 T1220 505\' stroke-width=\'1.1\'/%3E%3Cpath d=\'M-20 580 Q210 560 400 585 T720 565 T1000 590 T1220 565\' stroke-width=\'1\'/%3E%3Cpath d=\'M-20 635 Q150 620 310 640 T610 625 T910 645 T1220 620\' stroke-width=\'1.3\'/%3E%3Cpath d=\'M-20 690 Q180 675 360 695 T670 680 T960 700 T1220 680\' stroke-width=\'0.8\'/%3E%3Cpath d=\'M-20 750 Q140 735 300 755 T600 740 T900 760 T1220 740\' stroke-width=\'1\'/%3E%3Cpath d=\'M-20 810 Q200 795 380 815 T700 800 T980 820 T1220 800\' stroke-width=\'1.1\'/%3E%3Cpath d=\'M-20 865 Q160 855 330 870 T640 860 T940 875 T1220 855\' stroke-width=\'0.9\'/%3E%3Cpath d=\'M-20 200 Q100 230 250 180 T500 220 T750 170 T1000 210 T1220 190\' stroke-width=\'2\' opacity=\'0.7\'/%3E%3Cpath d=\'M-20 210 Q110 240 260 195 T510 235 T760 185 T1010 225 T1220 200\' stroke-width=\'1.5\' opacity=\'0.5\'/%3E%3Cpath d=\'M200 300 Q280 280 360 310 T520 290 T680 320\' stroke-width=\'0.7\'/%3E%3Cpath d=\'M200 315 Q280 298 360 325 T520 308 T680 335\' stroke-width=\'0.7\'/%3E%3Cpath d=\'M200 330 Q280 316 360 340 T520 326 T680 350\' stroke-width=\'0.7\'/%3E%3Cpath d=\'M600 500 Q700 480 800 510 T1000 490 T1150 520\' stroke-width=\'0.7\'/%3E%3Cpath d=\'M600 515 Q700 498 800 525 T1000 508 T1150 535\' stroke-width=\'0.7\'/%3E%3Cpath d=\'M600 530 Q700 516 800 540 T1000 526 T1150 550\' stroke-width=\'0.7\'/%3E%3Ccircle cx=\'350\' cy=\'310\' r=\'3\' fill=\'%23e8a0c0\' stroke=\'none\' opacity=\'0.4\'/%3E%3Ccircle cx=\'750\' cy=\'180\' r=\'3\' fill=\'%23e8a0c0\' stroke=\'none\' opacity=\'0.4\'/%3E%3Ccircle cx=\'900\' cy=\'520\' r=\'3\' fill=\'%23e8a0c0\' stroke=\'none\' opacity=\'0.4\'/%3E%3C/g%3E%3C/svg%3E")';

    (function initTheme() {
      const el = document.getElementById('theme-bg');
      if (!el) return;
      el.style.background = DOURO_BG;
      el.style.backgroundSize = 'cover';
      el.style.backgroundPosition = 'center';
      el.style.backgroundRepeat = 'no-repeat';
      el.style.backgroundAttachment = 'scroll';
      el.classList.add('active');
    })();

    /* ───────────────── Star Rating Component ───────────────── */

    function StarRating({ rating, max = 10, size = 'md', interactive = false, onChange }) {
      const sizes = { sm: 'w-4 h-4', md: 'w-5 h-5', lg: 'w-7 h-7' };
      const sz = sizes[size] || sizes.md;
      const [hover, setHover] = useState(0);

      return (
        <div className="flex gap-0.5 items-center">
          {Array.from({ length: max }, (_, i) => {
            const val = i + 1;
            const filled = interactive ? val <= (hover || rating) : val <= rating;
            return (
              <button
                key={i}
                type="button"
                disabled={!interactive}
                className={`${sz} transition-all ${interactive ? 'cursor-pointer hover:scale-110' : 'cursor-default'}`}
                onMouseEnter={() => interactive && setHover(val)}
                onMouseLeave={() => interactive && setHover(0)}
                onClick={() => interactive && onChange && onChange(val)}
                aria-label={`${val} star${val > 1 ? 's' : ''}`}
              >
                <svg viewBox="0 0 24 24" className={`${filled ? 'star-glow' : ''}`}>
                  <path
                    d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"
                    fill={filled ? '#d4a23a' : 'transparent'}
                    stroke={filled ? '#d4a23a' : 'rgba(245,208,224,0.25)'}
                    strokeWidth="1.5"
                  />
                </svg>
              </button>
            );
          })}
        </div>
      );
    }

    /* ───────────────── Toast Notification ───────────────── */

    function Toast({ message, type = 'success', onClose }) {
      useEffect(() => {
        const t = setTimeout(onClose, 3000);
        return () => clearTimeout(t);
      }, [onClose]);

      const bg = type === 'success' ? 'bg-emerald-900/80 border-emerald-600/40' : 'bg-red-900/80 border-red-600/40';
      return (
        <div className={`fixed top-4 right-4 z-50 px-5 py-3 rounded-lg border ${bg} text-port-100 shadow-xl fade-in`}>
          {message}
        </div>
      );
    }

    /* ───────────────── Confirm Dialog ───────────────── */

    function ConfirmDialog({ title, message, onConfirm, onCancel }) {
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm fade-in p-4">
          <div className="glass rounded-xl p-6 max-w-sm w-full">
            <h3 className="font-display text-xl text-port-100 mb-2">{title}</h3>
            <p className="text-port-300 mb-6">{message}</p>
            <div className="flex gap-3 justify-end">
              <button onClick={onCancel} className="px-4 py-2 rounded-lg glass-light text-port-200 hover:bg-white/10 transition">Cancel</button>
              <button onClick={onConfirm} className="px-4 py-2 rounded-lg bg-red-800/60 text-port-100 hover:bg-red-700/60 transition">Delete</button>
            </div>
          </div>
        </div>
      );
    }

    /* ───────────────── Loading Spinner ───────────────── */

    function Spinner() {
      return (
        <div className="flex justify-center py-12">
          <div className="w-8 h-8 border-2 border-port-500 border-t-gold-400 rounded-full animate-spin" />
        </div>
      );
    }

    /* ───────────────── Add/Edit Port Form ───────────────── */

    function PortForm({ port, onSave, onCancel }) {
      const isEdit = !!port;
      const [form, setForm] = useState({
        name: port?.name || '',
        producer: port?.producer || '',
        type: port?.type || 'Tawny',
        year: port?.year || '',
        officialNotes: port?.officialNotes || '',
        photo: port?.photo || '',
        purchaseLocation: port?.purchaseLocation || '',
      });
      const fileInputRef = useRef(null);
      const [errors, setErrors] = useState({});
      const [saving, setSaving] = useState(false);

      const validate = () => {
        const errs = {};
        if (!form.name.trim()) errs.name = 'Port name is required';
        if (!form.producer.trim()) errs.producer = 'Producer is required';
        setErrors(errs);
        return Object.keys(errs).length === 0;
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!validate()) return;
        setSaving(true);
        const data = {
          ...form,
          year: form.year ? form.year.trim() : null,
        };
        await onSave(data);
        setSaving(false);
      };

      const field = (label, key, type = 'text', opts = {}) => (
        <div className={opts.full ? 'sm:col-span-2' : ''}>
          <label className="block text-sm font-medium text-port-300 mb-1">{label}{opts.required && <span className="text-port-500 ml-0.5">*</span>}</label>
          {opts.textarea ? (
            <textarea
              value={form[key]}
              onChange={(e) => setForm({ ...form, [key]: e.target.value })}
              rows={3}
              placeholder={opts.placeholder || ''}
              className="w-full rounded-lg px-3 py-2 text-sm"
            />
          ) : opts.select ? (
            <select
              value={form[key]}
              onChange={(e) => setForm({ ...form, [key]: e.target.value })}
              className="w-full rounded-lg px-3 py-2 text-sm"
            >
              {opts.options.map((o) => <option key={o} value={o}>{o}</option>)}
            </select>
          ) : (
            <input
              type={type}
              value={form[key]}
              onChange={(e) => setForm({ ...form, [key]: e.target.value })}
              placeholder={opts.placeholder || ''}
              className="w-full rounded-lg px-3 py-2 text-sm"
            />
          )}
          {errors[key] && <p className="text-red-400 text-xs mt-1">{errors[key]}</p>}
        </div>
      );

      return (
        <div className="fade-in max-w-2xl mx-auto">
          <button onClick={onCancel} className="flex items-center gap-1 text-port-400 hover:text-port-200 mb-4 transition text-sm">
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg>
            Back
          </button>
          <div className="glass rounded-xl p-6">
            <h2 className="font-display text-2xl text-port-100 mb-6">{isEdit ? 'Edit Port' : 'Add New Port'}</h2>
            <form onSubmit={handleSubmit} className="grid sm:grid-cols-2 gap-4">
              {field('Port Name', 'name', 'text', { required: true, placeholder: "e.g. Dow's 2017 Vintage" })}
              {field('Producer', 'producer', 'text', { required: true, placeholder: "e.g. Dow's" })}
              {field('Type', 'type', 'text', { select: true, options: PORT_TYPES })}
              <div>
                <label className="block text-sm font-medium text-port-300 mb-1">Year / Age</label>
                <input
                  type="text"
                  value={form.year}
                  onChange={(e) => setForm({ ...form, year: e.target.value })}
                  placeholder="e.g., 2016 or 10 Year Old"
                  className="w-full rounded-lg px-3 py-2 text-sm"
                />
                <p className="text-port-500 text-xs mt-1">Vintage year or age statement</p>
              </div>
              {field('Official Tasting Notes', 'officialNotes', 'text', { textarea: true, full: true, placeholder: 'Enter official tasting notes from producer or reference...' })}
              {field('Purchase Location', 'purchaseLocation', 'text', { placeholder: 'Store or website' })}
              <div className="sm:col-span-2">
                <label className="block text-sm font-medium text-port-300 mb-1">Photo</label>
                <div className="flex items-start gap-4">
                  <button
                    type="button"
                    onClick={() => fileInputRef.current?.click()}
                    className="flex items-center gap-2 px-4 py-2 rounded-lg glass-light text-port-200 hover:bg-white/10 transition text-sm"
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    {form.photo ? 'Change Photo' : 'Upload Photo'}
                  </button>
                  <input
                    ref={fileInputRef}
                    type="file"
                    accept="image/jpeg,image/png,image/webp"
                    className="hidden"
                    onChange={(e) => {
                      const file = e.target.files?.[0];
                      if (!file) return;
                      const reader = new FileReader();
                      reader.onload = async (ev) => {
                        let photo = ev.target.result;
                        if (file.type.startsWith('image/')) {
                          photo = await compressImage(photo);
                        }
                        setForm(f => ({ ...f, photo }));
                      };
                      reader.readAsDataURL(file);
                    }}
                  />
                  {form.photo && (
                    <div className="relative group">
                      <img src={form.photo} alt="Port bottle" className="w-20 h-20 object-cover rounded-lg border border-white/10" />
                      <button
                        type="button"
                        onClick={() => { setForm({ ...form, photo: '' }); if (fileInputRef.current) fileInputRef.current.value = ''; }}
                        className="absolute -top-2 -right-2 w-5 h-5 rounded-full bg-red-800 text-port-100 text-xs flex items-center justify-center opacity-0 group-hover:opacity-100 transition"
                      >&times;</button>
                    </div>
                  )}
                </div>
                <p className="text-port-500 text-xs mt-1">JPG, PNG, or WebP (optional)</p>
              </div>
              <div className="sm:col-span-2 flex gap-3 justify-end pt-2">
                <button type="button" onClick={onCancel} className="px-5 py-2.5 rounded-lg glass-light text-port-200 hover:bg-white/10 transition text-sm">Cancel</button>
                <button type="submit" disabled={saving} className="px-5 py-2.5 rounded-lg bg-port-700 text-port-100 hover:bg-port-600 transition text-sm disabled:opacity-50">
                  {saving ? 'Saving...' : isEdit ? 'Update Port' : 'Add Port'}
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }

    /* ───────────────── Port Detail View ───────────────── */

    function PortDetail({ portId, onBack, onEdit, onDelete, showToast, onNavigateToMeeting, currentUserName }) {
      const [port, setPort] = useState(null);
      const [ratings, setRatings] = useState([]);
      const [portMeetings, setPortMeetings] = useState([]);
      const [loading, setLoading] = useState(true);
      const [memberName, setMemberName] = useState(() => currentUserName || localStorage.getItem('pc_member') || '');
      const [newRating, setNewRating] = useState(0);
      const [newNotes, setNewNotes] = useState('');
      const [submitting, setSubmitting] = useState(false);
      const [ratingErrors, setRatingErrors] = useState({});
      const [showConfirm, setShowConfirm] = useState(false);
      const [ratingFormExpanded, setRatingFormExpanded] = useState(false);

      const load = useCallback(async () => {
        setLoading(true);
        const p = await storage.get(`port:${portId}`);
        const r = await storage.get(`ratings:${portId}`);
        setPort(p);
        setRatings(r?.ratings || []);
        // Load meetings that include this port
        const meetingIds = (await storage.get('meetings:list')) || [];
        const mList = [];
        for (const mid of meetingIds) {
          const m = await storage.get(`meeting:${mid}`);
          if (m && m.portsTasted && m.portsTasted.includes(portId)) mList.push(m);
        }
        setPortMeetings(mList);
        setLoading(false);
      }, [portId]);

      useEffect(() => { load(); }, [load]);

      const avgRating = useMemo(() => {
        if (!ratings.length) return 0;
        return ratings.reduce((s, r) => s + r.rating, 0) / ratings.length;
      }, [ratings]);

      const submitRating = async (e) => {
        e.preventDefault();
        const errs = {};
        if (!memberName.trim()) errs.name = 'Enter your name';
        if (!newRating) errs.rating = 'Select a rating';
        setRatingErrors(errs);
        if (Object.keys(errs).length) return;

        setSubmitting(true);
        localStorage.setItem('pc_member', memberName.trim());
        const updated = ratings.filter((r) => r.memberName !== memberName.trim());
        updated.push({
          memberName: memberName.trim(),
          rating: newRating,
          notes: newNotes.trim(),
          date: new Date().toISOString(),
        });
        const ok = await storage.set(`ratings:${portId}`, { portId, ratings: updated });
        if (ok) {
          setRatings(updated);
          setNewRating(0);
          setNewNotes('');
          setRatingFormExpanded(false);
          showToast('Rating saved!');
        } else {
          showToast('Failed to save rating', 'error');
        }
        setSubmitting(false);
      };

      const handleDelete = async () => {
        const list = (await storage.get('ports:list')) || [];
        await storage.set('ports:list', list.filter((id) => id !== portId));
        await storage.set(`port:${portId}`, null);
        await storage.set(`ratings:${portId}`, null);
        showToast('Port deleted');
        onBack();
      };

      if (loading) return <Spinner />;
      if (!port) return <p className="text-center text-port-400 py-12">Port not found.</p>;

      return (
        <div className="fade-in max-w-2xl mx-auto">
          {showConfirm && (
            <ConfirmDialog
              title="Delete Port"
              message={`Are you sure you want to delete "${port.name}"? This will also remove all ratings.`}
              onConfirm={handleDelete}
              onCancel={() => setShowConfirm(false)}
            />
          )}

          <button onClick={onBack} className="flex items-center gap-1 text-port-400 hover:text-port-200 mb-4 transition text-sm">
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg>
            Back to Garrafeira
          </button>

          {/* Port Info Card */}
          <div className="glass rounded-xl p-6 mb-6">
            <div className="flex flex-wrap items-start justify-between gap-3 mb-4">
              <div>
                <span className="inline-block text-xs font-medium px-2.5 py-1 rounded-full bg-port-800/60 text-port-300 mb-2">{port.type}</span>
                <h2 className="font-display text-2xl sm:text-3xl text-port-100">{port.name}</h2>
                <p className="text-port-300 mt-0.5">{port.producer}{port.year ? ` \u00B7 ${port.year}` : ''}</p>
              </div>
              <div className="text-right">
                <div className="text-3xl font-display text-gold-400">{avgRating ? avgRating.toFixed(1) : '\u2014'}</div>
                <div className="text-xs text-port-400">{ratings.length} rating{ratings.length !== 1 ? 's' : ''}</div>
              </div>
            </div>

            {avgRating > 0 && (
              <div className="mb-4">
                <StarRating rating={Math.round(avgRating)} size="md" />
              </div>
            )}

            {port.photo && (
              <div className="mb-4">
                <img src={port.photo} alt={port.name} className="w-full max-w-xs rounded-lg border border-white/10" />
              </div>
            )}
            {port.officialNotes && (
              <div className="mb-3">
                <h4 className="text-xs font-semibold text-port-400 uppercase tracking-wider mb-1">Official Tasting Notes</h4>
                <p className="text-port-200 text-sm leading-relaxed whitespace-pre-line">{port.officialNotes}</p>
              </div>
            )}
            {port.purchaseLocation && (
              <div className="mb-3">
                <h4 className="text-xs font-semibold text-port-400 uppercase tracking-wider mb-1">Purchase Info</h4>
                <p className="text-port-200 text-sm">{port.purchaseLocation}</p>
              </div>
            )}

            <div className="flex gap-2 mt-5 pt-4 border-t border-white/5">
              <button onClick={() => onEdit(port)} className="flex items-center gap-1.5 text-sm text-port-300 hover:text-port-100 transition">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                Edit
              </button>
              <button onClick={() => setShowConfirm(true)} className="flex items-center gap-1.5 text-sm text-red-400/70 hover:text-red-400 transition ml-4">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                Delete
              </button>
            </div>
          </div>

          {/* Member Ratings */}
          <div className="glass rounded-xl p-6 mb-6">
            <h3 className="font-display text-xl text-port-100 mb-4">Member Ratings</h3>
            {ratings.length === 0 ? (
              <p className="text-port-400 text-sm">No ratings yet. Be the first!</p>
            ) : (
              <div className="space-y-4">
                {ratings.sort((a, b) => new Date(b.date) - new Date(a.date)).map((r, i) => (
                  <div key={i} className="glass-light rounded-lg p-4">
                    <div className="flex items-center justify-between mb-1">
                      <span className="font-medium text-port-100">{r.memberName}</span>
                      <span className="text-xs text-port-400">{new Date(r.date).toLocaleDateString()}</span>
                    </div>
                    <StarRating rating={r.rating} size="sm" />
                    {r.notes && <p className="text-port-300 text-sm mt-2 leading-relaxed">{r.notes}</p>}
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Add/Edit Rating */}
          <div className="glass rounded-xl p-6">
            {(() => {
              const userName = currentUserName || localStorage.getItem('pc_member') || '';
              const userRating = ratings.find(r => r.memberName === userName);
              const hasRated = !!userRating;
              const showForm = !hasRated || ratingFormExpanded;
              return showForm ? (
                <div>
                  <h3 className="font-display text-xl text-port-100 mb-4">{hasRated ? 'Edit Your Rating' : 'Add Your Rating'}</h3>
                  <form onSubmit={submitRating} className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-port-300 mb-1">Your Name<span className="text-port-500 ml-0.5">*</span></label>
                      <input
                        type="text"
                        value={memberName}
                        onChange={(e) => setMemberName(e.target.value)}
                        placeholder="Enter your name"
                        className="w-full rounded-lg px-3 py-2 text-sm"
                      />
                      {ratingErrors.name && <p className="text-red-400 text-xs mt-1">{ratingErrors.name}</p>}
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-port-300 mb-1">Rating<span className="text-port-500 ml-0.5">*</span></label>
                      <StarRating rating={newRating} size="lg" interactive onChange={setNewRating} />
                      {newRating > 0 && <span className="text-sm text-gold-400 ml-1">{newRating}/10</span>}
                      {ratingErrors.rating && <p className="text-red-400 text-xs mt-1">{ratingErrors.rating}</p>}
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-port-300 mb-1">Tasting Notes</label>
                      <textarea
                        value={newNotes}
                        onChange={(e) => setNewNotes(e.target.value)}
                        rows={3}
                        placeholder="Your impressions, flavors, finish..."
                        className="w-full rounded-lg px-3 py-2 text-sm"
                      />
                    </div>
                    <div className="flex gap-2">
                      <button type="submit" disabled={submitting} className="w-full sm:w-auto px-6 py-2.5 rounded-lg bg-gold-600 text-port-950 font-medium hover:bg-gold-500 transition text-sm disabled:opacity-50">
                        {submitting ? 'Saving...' : 'Submit Rating'}
                      </button>
                      {hasRated && (
                        <button type="button" onClick={() => setRatingFormExpanded(false)} className="px-5 py-2.5 rounded-lg glass-light text-port-300 hover:bg-white/10 transition text-sm">Cancel</button>
                      )}
                    </div>
                  </form>
                </div>
              ) : (
                <div>
                  <h3 className="font-display text-xl text-port-100 mb-4">Your Rating</h3>
                  <button
                    onClick={() => setRatingFormExpanded(true)}
                    className="flex items-center gap-2 px-4 py-2 rounded-lg glass-light text-port-200 hover:bg-white/10 transition text-sm"
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                    Edit My Rating
                  </button>
                </div>
              );
            })()}
          </div>

          {/* Tasted At Meetings */}
          {portMeetings.length > 0 && (
            <div className="glass rounded-xl p-6 mt-6">
              <h3 className="font-display text-xl text-port-100 mb-4">Tasted At Meetings</h3>
              <div className="space-y-2">
                {portMeetings.map(m => {
                  const d = new Date(m.date + 'T12:00:00');
                  return (
                    <button key={m.id} onClick={() => onNavigateToMeeting && onNavigateToMeeting(m.id)}
                      className="w-full text-left glass-light rounded-lg p-3 hover:bg-white/10 transition flex items-center justify-between">
                      <span className="text-port-100 text-sm">{d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>
                      <span className="text-port-400 text-sm">{m.location}</span>
                    </button>
                  );
                })}
              </div>
            </div>
          )}
        </div>
      );
    }

    /* ───────────────── Port Card (List Item) ───────────────── */

    function PortCard({ port, avgRating, ratingCount, onClick, onQuickRate }) {
      return (
        <div
          onClick={onClick}
          className="glass rounded-xl p-4 cursor-pointer hover:border-port-500/40 transition group"
        >
          <div className="flex items-start justify-between gap-2">
            <div className="min-w-0">
              <span className="inline-block text-[10px] font-medium px-2 py-0.5 rounded-full bg-port-800/60 text-port-300 mb-1.5">{port.type}</span>
              <h3 className="font-display text-lg text-port-100 group-hover:text-gold-400 transition truncate">{port.name}</h3>
              <p className="text-port-400 text-sm truncate">{port.producer}{port.year ? ` \u00B7 ${port.year}` : ''}</p>
            </div>
            <div className="text-right flex-shrink-0">
              <div className="text-2xl font-display text-gold-400">{avgRating ? avgRating.toFixed(1) : '\u2014'}</div>
              <div className="text-[10px] text-port-400">{ratingCount} rating{ratingCount !== 1 ? 's' : ''}</div>
            </div>
          </div>
          {avgRating > 0 && (
            <div className="mt-2">
              <StarRating rating={Math.round(avgRating)} size="sm" />
            </div>
          )}
        </div>
      );
    }

    /* ───────────────── Port List / Home View ───────────────── */

    function PortList({ onSelect, onAdd, initialPorts, initialRatings }) {
      const [ports, setPorts] = useState(initialPorts || []);
      const [ratingsMap, setRatingsMap] = useState(initialRatings || {});
      const [loading, setLoading] = useState(!initialPorts);
      const [search, setSearch] = useState('');
      const [typeFilter, setTypeFilter] = useState('');
      const [sort, setSort] = useState('date-desc');

      const load = useCallback(async () => {
        setLoading(true);
        const ids = (await storage.get('ports:list')) || [];
        const portData = [];
        const ratData = {};
        for (const id of ids) {
          const p = await storage.get(`port:${id}`);
          if (p) {
            portData.push(p);
            const r = await storage.get(`ratings:${id}`);
            ratData[id] = r?.ratings || [];
          }
        }
        setPorts(portData);
        setRatingsMap(ratData);
        setLoading(false);
      }, []);

      useEffect(() => { if (!initialPorts) load(); }, [load, initialPorts]);

      const getAvg = (id) => {
        const r = ratingsMap[id] || [];
        return r.length ? r.reduce((s, x) => s + x.rating, 0) / r.length : 0;
      };

      const filtered = useMemo(() => {
        let list = [...ports];
        if (search) {
          const q = search.toLowerCase();
          list = list.filter((p) => p.name.toLowerCase().includes(q) || p.producer.toLowerCase().includes(q));
        }
        if (typeFilter) list = list.filter((p) => p.type === typeFilter);

        const [field, dir] = sort.split('-');
        list.sort((a, b) => {
          if (field === 'rating') {
            const diff = getAvg(a.id) - getAvg(b.id);
            return dir === 'desc' ? -diff : diff;
          }
          if (field === 'name') {
            const diff = a.name.localeCompare(b.name);
            return dir === 'desc' ? -diff : diff;
          }
          const diff = new Date(a.dateAdded) - new Date(b.dateAdded);
          return dir === 'desc' ? -diff : diff;
        });
        return list;
      }, [ports, search, typeFilter, sort, ratingsMap]);

      if (loading) return <Spinner />;

      return (
        <div className="fade-in">
          {/* Search / Filter Bar */}
          <div className="flex flex-col sm:flex-row gap-3 mb-6">
            <div className="relative flex-1">
              <svg className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-port-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
              <input
                type="text"
                placeholder="Search Garrafeira..."
                value={search}
                onChange={(e) => setSearch(e.target.value)}
                className="w-full rounded-lg pl-9 pr-3 py-2.5 text-sm"
              />
            </div>
            <select value={typeFilter} onChange={(e) => setTypeFilter(e.target.value)} className="rounded-lg px-3 py-2.5 text-sm min-w-[130px]">
              <option value="">All Types</option>
              {PORT_TYPES.map((t) => <option key={t} value={t}>{t}</option>)}
            </select>
            <select value={sort} onChange={(e) => setSort(e.target.value)} className="rounded-lg px-3 py-2.5 text-sm min-w-[150px]">
              {SORT_OPTIONS.map((o) => <option key={o.value} value={o.value}>{o.label}</option>)}
            </select>
          </div>

          {/* Port Cards Grid */}
          {filtered.length === 0 ? (
            <div className="text-center py-16">
              {ports.length === 0 ? (
                <>
                  <div className="text-5xl mb-4 opacity-30">&#127863;</div>
                  <p className="text-port-400 mb-4">No ports in the Garrafeira yet.</p>
                  <button onClick={onAdd} className="px-5 py-2.5 rounded-lg bg-port-700 text-port-100 hover:bg-port-600 transition text-sm">Add Your First Port</button>
                </>
              ) : (
                <p className="text-port-400">No ports match your search in the Garrafeira.</p>
              )}
            </div>
          ) : (
            <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
              {filtered.map((p) => (
                <PortCard
                  key={p.id}
                  port={p}
                  avgRating={getAvg(p.id)}
                  ratingCount={(ratingsMap[p.id] || []).length}
                  onClick={() => onSelect(p.id)}
                />
              ))}
            </div>
          )}

          {/* Stats Footer */}
          {ports.length > 0 && (
            <div className="mt-8 pt-6 border-t border-white/5 flex flex-wrap gap-6 text-sm text-port-400">
              <span>{ports.length} port{ports.length !== 1 ? 's' : ''} in collection</span>
              <span>{Object.values(ratingsMap).reduce((s, r) => s + r.length, 0)} total ratings</span>
            </div>
          )}
        </div>
      );
    }

    /* ───────────────── Quick Rate Modal ───────────────── */

    function QuickRateModal({ port, onClose, onSaved, currentUserName }) {
      const [memberName, setMemberName] = useState(() => currentUserName || localStorage.getItem('pc_member') || '');
      const [rating, setRating] = useState(0);
      const [notes, setNotes] = useState('');
      const [saving, setSaving] = useState(false);
      const [errors, setErrors] = useState({});

      const handleSubmit = async (e) => {
        e.preventDefault();
        const errs = {};
        if (!memberName.trim()) errs.name = 'Enter your name';
        if (!rating) errs.rating = 'Select a rating';
        setErrors(errs);
        if (Object.keys(errs).length) return;

        setSaving(true);
        localStorage.setItem('pc_member', memberName.trim());
        const existing = await storage.get(`ratings:${port.id}`);
        const arr = existing?.ratings || [];
        const updated = arr.filter((r) => r.memberName !== memberName.trim());
        updated.push({
          memberName: memberName.trim(),
          rating,
          notes: notes.trim(),
          date: new Date().toISOString(),
        });
        const ok = await storage.set(`ratings:${port.id}`, { portId: port.id, ratings: updated });
        setSaving(false);
        if (ok) onSaved();
        else onSaved('Failed to save');
      };

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm fade-in p-4" onClick={onClose}>
          <div className="glass rounded-xl p-6 max-w-md w-full" onClick={(e) => e.stopPropagation()}>
            <h3 className="font-display text-xl text-port-100 mb-1">Quick Rate</h3>
            <p className="text-port-300 text-sm mb-4">{port.name}</p>
            <form onSubmit={handleSubmit} className="space-y-3">
              <div>
                <input type="text" value={memberName} onChange={(e) => setMemberName(e.target.value)} placeholder="Your name" className="w-full rounded-lg px-3 py-2 text-sm" />
                {errors.name && <p className="text-red-400 text-xs mt-1">{errors.name}</p>}
              </div>
              <div>
                <StarRating rating={rating} size="lg" interactive onChange={setRating} />
                {rating > 0 && <span className="text-sm text-gold-400 ml-1">{rating}/10</span>}
                {errors.rating && <p className="text-red-400 text-xs mt-1">{errors.rating}</p>}
              </div>
              <textarea value={notes} onChange={(e) => setNotes(e.target.value)} rows={2} placeholder="Quick notes (optional)" className="w-full rounded-lg px-3 py-2 text-sm" />
              <div className="flex gap-3 justify-end pt-1">
                <button type="button" onClick={onClose} className="px-4 py-2 rounded-lg glass-light text-port-200 hover:bg-white/10 transition text-sm">Cancel</button>
                <button type="submit" disabled={saving} className="px-4 py-2 rounded-lg bg-gold-600 text-port-950 font-medium hover:bg-gold-500 transition text-sm disabled:opacity-50">
                  {saving ? 'Saving...' : 'Rate'}
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }

    /* ───────────────── Meeting Card ───────────────── */

    function MeetingCard({ meeting, onClick }) {
      const yesCount = meeting.attendees?.filter(a => a.rsvp === 'yes').length || 0;
      const maybeCount = meeting.attendees?.filter(a => a.rsvp === 'maybe').length || 0;
      const dateObj = new Date(meeting.date + 'T12:00:00');
      const isUpcoming = meeting.status === 'upcoming';
      const formatted = dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });

      return (
        <div onClick={onClick} className="glass rounded-xl p-4 cursor-pointer hover:border-port-500/40 transition group">
          <div className="flex items-start justify-between gap-2">
            <div className="min-w-0">
              <span className={`inline-block text-[10px] font-medium px-2 py-0.5 rounded-full mb-1.5 ${
                isUpcoming ? 'bg-emerald-900/40 text-emerald-400' : 'bg-port-800/60 text-port-400'
              }`}>{isUpcoming ? 'Upcoming' : 'Completed'}</span>
              <h3 className="font-display text-lg text-port-100 group-hover:text-gold-400 transition">{formatted}</h3>
              <p className="text-port-400 text-sm truncate">{meeting.location}</p>
            </div>
            <div className="text-right flex-shrink-0">
              <div className="text-sm text-port-300">Host: {meeting.host}</div>
              <div className="text-[10px] text-port-400 mt-1">
                {yesCount > 0 && <span className="text-emerald-400">{yesCount} yes</span>}
                {yesCount > 0 && maybeCount > 0 && <span>, </span>}
                {maybeCount > 0 && <span className="text-gold-400">{maybeCount} maybe</span>}
                {yesCount === 0 && maybeCount === 0 && <span>No RSVPs</span>}
              </div>
            </div>
          </div>
          {(meeting.portsTasted?.length > 0 || meeting.attachments?.length > 0) && (
            <div className="mt-2 text-[10px] text-port-500 flex gap-3">
              {meeting.portsTasted?.length > 0 && <span>{meeting.portsTasted.length} port{meeting.portsTasted.length !== 1 ? 's' : ''} tasted</span>}
              {meeting.attachments?.length > 0 && <span>{meeting.attachments.length} file{meeting.attachments.length !== 1 ? 's' : ''}</span>}
            </div>
          )}
        </div>
      );
    }

    /* ───────────────── Meeting List ───────────────── */

    function MeetingList({ onSelect, onAdd }) {
      const [meetings, setMeetings] = useState([]);
      const [loading, setLoading] = useState(true);

      const load = useCallback(async () => {
        setLoading(true);
        const ids = (await storage.get('meetings:list')) || [];
        const data = [];
        for (const id of ids) {
          const m = await storage.get(`meeting:${id}`);
          if (m) data.push(m);
        }
        setMeetings(data);
        setLoading(false);
      }, []);

      useEffect(() => { load(); }, [load]);

      const today = new Date().toISOString().slice(0, 10);
      const upcoming = meetings
        .filter(m => m.status === 'upcoming' || m.date >= today)
        .sort((a, b) => a.date.localeCompare(b.date));
      const past = meetings
        .filter(m => m.status === 'completed' && m.date < today)
        .sort((a, b) => b.date.localeCompare(a.date));

      if (loading) return <Spinner />;

      return (
        <div className="fade-in">
          {meetings.length === 0 ? (
            <div className="text-center py-16">
              <div className="text-5xl mb-4 opacity-30">&#128197;</div>
              <p className="text-port-400 mb-4">No meetings scheduled yet.</p>
              <button onClick={onAdd} className="px-5 py-2.5 rounded-lg bg-port-700 text-port-100 hover:bg-port-600 transition text-sm">Create First Meeting</button>
            </div>
          ) : (
            <>
              {upcoming.length > 0 && (
                <div className="mb-8">
                  <h3 className="text-xs font-semibold text-port-400 uppercase tracking-wider mb-3">Upcoming</h3>
                  <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                    {upcoming.map(m => <MeetingCard key={m.id} meeting={m} onClick={() => onSelect(m.id)} />)}
                  </div>
                </div>
              )}
              {past.length > 0 && (
                <div>
                  <h3 className="text-xs font-semibold text-port-400 uppercase tracking-wider mb-3">Past Meetings</h3>
                  <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                    {past.map(m => <MeetingCard key={m.id} meeting={m} onClick={() => onSelect(m.id)} />)}
                  </div>
                </div>
              )}
              <div className="mt-8 pt-6 border-t border-white/5 flex flex-wrap gap-6 text-sm text-port-400">
                <span>{upcoming.length} upcoming</span>
                <span>{past.length} past meeting{past.length !== 1 ? 's' : ''}</span>
              </div>
            </>
          )}
        </div>
      );
    }

    /* ───────────────── Meeting Form ───────────────── */

    function MeetingForm({ meeting, onSave, onCancel, currentUserName }) {
      const isEdit = !!meeting;
      const [form, setForm] = useState({
        date: meeting?.date || '',
        location: meeting?.location || '',
        host: meeting?.host || currentUserName || localStorage.getItem('pc_member') || '',
        status: meeting?.status || 'upcoming',
        notes: meeting?.notes || '',
      });
      const [errors, setErrors] = useState({});
      const [saving, setSaving] = useState(false);

      const validate = () => {
        const errs = {};
        if (!form.date) errs.date = 'Date is required';
        if (!form.location.trim()) errs.location = 'Location is required';
        if (!form.host.trim()) errs.host = 'Host is required';
        setErrors(errs);
        return Object.keys(errs).length === 0;
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!validate()) return;
        setSaving(true);
        await onSave({ ...form, location: form.location.trim(), host: form.host.trim(), notes: form.notes.trim() });
        setSaving(false);
      };

      const field = (label, key, type = 'text', opts = {}) => (
        <div className={opts.full ? 'sm:col-span-2' : ''}>
          <label className="block text-sm font-medium text-port-300 mb-1">{label}{opts.required && <span className="text-port-500 ml-0.5">*</span>}</label>
          {opts.textarea ? (
            <textarea value={form[key]} onChange={(e) => setForm({ ...form, [key]: e.target.value })} rows={3} placeholder={opts.placeholder || ''} className="w-full rounded-lg px-3 py-2 text-sm" />
          ) : opts.select ? (
            <select value={form[key]} onChange={(e) => setForm({ ...form, [key]: e.target.value })} className="w-full rounded-lg px-3 py-2 text-sm">
              {opts.options.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
            </select>
          ) : (
            <input type={type} value={form[key]} onChange={(e) => setForm({ ...form, [key]: e.target.value })} placeholder={opts.placeholder || ''} className="w-full rounded-lg px-3 py-2 text-sm" />
          )}
          {errors[key] && <p className="text-red-400 text-xs mt-1">{errors[key]}</p>}
        </div>
      );

      return (
        <div className="fade-in max-w-2xl mx-auto">
          <button onClick={onCancel} className="flex items-center gap-1 text-port-400 hover:text-port-200 mb-4 transition text-sm">
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg>
            Back
          </button>
          <div className="glass rounded-xl p-6">
            <h2 className="font-display text-2xl text-port-100 mb-6">{isEdit ? 'Edit Meeting' : 'Create Meeting'}</h2>
            <form onSubmit={handleSubmit} className="grid sm:grid-cols-2 gap-4">
              {field('Date', 'date', 'date', { required: true })}
              {field('Location', 'location', 'text', { required: true, placeholder: "e.g. John's house" })}
              {field('Host', 'host', 'text', { required: true, placeholder: 'Who is hosting?' })}
              {field('Status', 'status', 'text', { select: true, options: [{ value: 'upcoming', label: 'Upcoming' }, { value: 'completed', label: 'Completed' }] })}
              {field('Notes', 'notes', 'text', { textarea: true, full: true, placeholder: 'Details, what to bring, theme...' })}
              <div className="sm:col-span-2 flex gap-3 justify-end pt-2">
                <button type="button" onClick={onCancel} className="px-5 py-2.5 rounded-lg glass-light text-port-200 hover:bg-white/10 transition text-sm">Cancel</button>
                <button type="submit" disabled={saving} className="px-5 py-2.5 rounded-lg bg-port-700 text-port-100 hover:bg-port-600 transition text-sm disabled:opacity-50">
                  {saving ? 'Saving...' : isEdit ? 'Update Meeting' : 'Create Meeting'}
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }

    /* ───────────────── Port Picker Modal ───────────────── */

    function PortPicker({ linkedIds, onSelect, onClose }) {
      const [ports, setPorts] = useState([]);
      const [search, setSearch] = useState('');
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        (async () => {
          const ids = (await storage.get('ports:list')) || [];
          const data = [];
          for (const id of ids) {
            const p = await storage.get(`port:${id}`);
            if (p) data.push(p);
          }
          setPorts(data);
          setLoading(false);
        })();
      }, []);

      const filtered = search
        ? ports.filter(p => p.name.toLowerCase().includes(search.toLowerCase()) || p.producer.toLowerCase().includes(search.toLowerCase()))
        : ports;

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm fade-in p-4" onClick={onClose}>
          <div className="glass rounded-xl p-6 max-w-md w-full max-h-[80vh] flex flex-col" onClick={e => e.stopPropagation()}>
            <h3 className="font-display text-xl text-port-100 mb-3">Add Port to Meeting</h3>
            <input
              type="text" value={search} onChange={e => setSearch(e.target.value)}
              placeholder="Search Garrafeira..." className="w-full rounded-lg px-3 py-2 text-sm mb-3"
            />
            <div className="overflow-y-auto flex-1 space-y-1 min-h-0">
              {loading ? <Spinner /> : filtered.length === 0 ? (
                <p className="text-port-400 text-sm text-center py-4">No ports found.</p>
              ) : filtered.map(p => {
                const linked = linkedIds.includes(p.id);
                return (
                  <button key={p.id} disabled={linked} onClick={() => onSelect(p.id)}
                    className={`w-full text-left rounded-lg p-3 transition text-sm ${linked ? 'opacity-40 cursor-default' : 'glass-light hover:bg-white/10 cursor-pointer'}`}>
                    <span className="text-port-100">{p.name}</span>
                    <span className="text-port-400 ml-2">{p.producer}</span>
                    {linked && <span className="text-port-500 ml-2 text-xs">(linked)</span>}
                  </button>
                );
              })}
            </div>
            <button onClick={onClose} className="mt-3 w-full px-4 py-2 rounded-lg glass-light text-port-200 hover:bg-white/10 transition text-sm">Close</button>
          </div>
        </div>
      );
    }

    /* ───────────────── Meeting Detail View ───────────────── */

    /* ── Upload Limits & Safeguards ── */

    const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB per file
    const MAX_TOTAL_STORAGE = 2.5 * 1024 * 1024 * 1024; // 2.5GB (50% of Firebase free tier)
    const MAX_FILE_COUNT = 500;
    const ACCEPTED_FILE_TYPES = '.pdf,.jpg,.jpeg,.png,.gif,.doc,.docx,.pptx,.txt,.xls,.xlsx';
    const ALLOWED_MIME_TYPES = [
      'image/jpeg', 'image/png', 'image/gif',
      'application/pdf',
      'application/msword',
      'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
      'application/vnd.openxmlformats-officedocument.presentationml.presentation',
      'application/vnd.ms-excel',
      'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
      'text/plain',
    ];

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    async function getStorageStats() {
      try {
        const doc = await db.collection('portCommittee').doc('storage_stats').get();
        return doc.exists ? doc.data() : { totalBytes: 0, fileCount: 0 };
      } catch (e) {
        console.error('Failed to read storage stats:', e);
        return { totalBytes: 0, fileCount: 0 };
      }
    }

    async function updateStorageStats(fileSize, increment) {
      try {
        const stats = await getStorageStats();
        await db.collection('portCommittee').doc('storage_stats').set({
          totalBytes: increment
            ? stats.totalBytes + fileSize
            : Math.max(0, stats.totalBytes - fileSize),
          fileCount: increment
            ? stats.fileCount + 1
            : Math.max(0, stats.fileCount - 1),
          lastUpdated: new Date().toISOString(),
        });
      } catch (e) {
        console.error('Failed to update storage stats:', e);
      }
    }

    async function validateFileUpload(file) {
      if (file.size > MAX_FILE_SIZE) {
        throw new Error(`File too large (${formatFileSize(file.size)}). Maximum size is 5 MB.`);
      }
      if (file.type && !ALLOWED_MIME_TYPES.includes(file.type)) {
        throw new Error('File type not allowed. Allowed: JPG, PNG, GIF, PDF, Word, PowerPoint, TXT.');
      }
      const stats = await getStorageStats();
      if (stats.totalBytes + file.size > MAX_TOTAL_STORAGE) {
        throw new Error('Storage limit reached (2.5 GB). Please delete old files first.');
      }
      if (stats.fileCount >= MAX_FILE_COUNT) {
        throw new Error(`File count limit reached (${MAX_FILE_COUNT} files). Please delete old files first.`);
      }
    }

    function compressImage(dataUrl, maxWidth = 1200, quality = 0.8) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          let w = img.width, h = img.height;
          if (w > maxWidth) { h = Math.round(h * maxWidth / w); w = maxWidth; }
          const canvas = document.createElement('canvas');
          canvas.width = w;
          canvas.height = h;
          canvas.getContext('2d').drawImage(img, 0, 0, w, h);
          resolve(canvas.toDataURL('image/jpeg', quality));
        };
        img.src = dataUrl;
      });
    }

    function compressImageFile(file, maxDim = 1600, quality = 0.8) {
      if (!file.type.startsWith('image/')) return Promise.resolve(file);
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            let w = img.width, h = img.height;
            if (w <= maxDim && h <= maxDim && file.size <= 500 * 1024) {
              resolve(file); // already small enough
              return;
            }
            if (w > maxDim || h > maxDim) {
              if (w > h) { h = Math.round(h * maxDim / w); w = maxDim; }
              else { w = Math.round(w * maxDim / h); h = maxDim; }
            }
            const canvas = document.createElement('canvas');
            canvas.width = w;
            canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            canvas.toBlob((blob) => {
              const compressed = new File([blob], file.name.replace(/\.[^/.]+$/, '.jpg'), { type: 'image/jpeg' });
              console.log(`Compressed ${file.name}: ${formatFileSize(file.size)} → ${formatFileSize(compressed.size)}`);
              resolve(compressed);
            }, 'image/jpeg', quality);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    function FileIcon({ type }) {
      const isImage = type && type.startsWith('image/');
      const isPdf = type && type.includes('pdf');
      if (isImage) return (
        <svg className="w-5 h-5 text-port-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
      );
      if (isPdf) return (
        <svg className="w-5 h-5 text-red-400/70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
      );
      return (
        <svg className="w-5 h-5 text-port-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
      );
    }

    function MeetingDetail({ meetingId, onBack, onEdit, showToast, onNavigateToPort, currentUserName }) {
      const [meeting, setMeeting] = useState(null);
      const [loading, setLoading] = useState(true);
      const [showConfirm, setShowConfirm] = useState(false);
      const [showPortPicker, setShowPortPicker] = useState(false);
      const [linkedPorts, setLinkedPorts] = useState([]);
      // RSVP form
      const [rsvpName, setRsvpName] = useState(() => currentUserName || localStorage.getItem('pc_member') || '');
      const [rsvpStatus, setRsvpStatus] = useState('yes');
      const [rsvpBringing, setRsvpBringing] = useState('');
      const [rsvpErrors, setRsvpErrors] = useState({});
      const [rsvpFormExpanded, setRsvpFormExpanded] = useState(false);
      // Attachments
      const [deleteAttId, setDeleteAttId] = useState(null);
      const [previewAtt, setPreviewAtt] = useState(null);
      const attachInputRef = useRef(null);
      // Photos
      const photoInputRef = useRef(null);
      const [uploadingPhotos, setUploadingPhotos] = useState(false);
      const [previewPhoto, setPreviewPhoto] = useState(null);
      const [deletePhotoId, setDeletePhotoId] = useState(null);
      const [editingCaption, setEditingCaption] = useState(null);
      const [captionText, setCaptionText] = useState('');

      const load = useCallback(async () => {
        setLoading(true);
        const m = await storage.get(`meeting:${meetingId}`);
        setMeeting(m);
        if (m?.portsTasted?.length) {
          const pList = [];
          for (const pid of m.portsTasted) {
            const p = await storage.get(`port:${pid}`);
            if (p) pList.push(p);
          }
          setLinkedPorts(pList);
        }
        setLoading(false);
      }, [meetingId]);

      useEffect(() => { load(); }, [load]);

      useEffect(() => {
        const onKey = (e) => {
          if (e.key === 'Escape') {
            if (previewPhoto) setPreviewPhoto(null);
            else if (previewAtt) setPreviewAtt(null);
          }
        };
        window.addEventListener('keydown', onKey);
        return () => window.removeEventListener('keydown', onKey);
      }, [previewAtt, previewPhoto]);

      const submitRsvp = async (e) => {
        e.preventDefault();
        const errs = {};
        if (!rsvpName.trim()) errs.name = 'Enter your name';
        setRsvpErrors(errs);
        if (Object.keys(errs).length) return;

        localStorage.setItem('pc_member', rsvpName.trim());
        const updated = (meeting.attendees || []).filter(a => a.name !== rsvpName.trim());
        updated.push({ name: rsvpName.trim(), rsvp: rsvpStatus, bringing: rsvpBringing.trim() });
        const newMeeting = { ...meeting, attendees: updated };
        const ok = await storage.set(`meeting:${meetingId}`, newMeeting);
        if (ok) {
          setMeeting(newMeeting);
          setRsvpBringing('');
          setRsvpFormExpanded(false);
          showToast('RSVP saved!');
        } else {
          showToast('Failed to save RSVP', 'error');
        }
      };

      const linkPort = async (portId) => {
        const updatedPorts = [...(meeting.portsTasted || []), portId];
        const newMeeting = { ...meeting, portsTasted: updatedPorts };
        await storage.set(`meeting:${meetingId}`, newMeeting);
        // Update port's datesTasted
        const port = await storage.get(`port:${portId}`);
        if (port) {
          const datesTasted = port.datesTasted || [];
          if (!datesTasted.includes(meeting.date)) {
            datesTasted.push(meeting.date);
            await storage.set(`port:${portId}`, { ...port, datesTasted });
          }
        }
        setMeeting(newMeeting);
        if (port) setLinkedPorts([...linkedPorts, port]);
        setShowPortPicker(false);
        showToast('Port linked!');
      };

      const unlinkPort = async (portId) => {
        const updatedPorts = (meeting.portsTasted || []).filter(id => id !== portId);
        const newMeeting = { ...meeting, portsTasted: updatedPorts };
        await storage.set(`meeting:${meetingId}`, newMeeting);
        // Remove date from port's datesTasted
        const port = await storage.get(`port:${portId}`);
        if (port && port.datesTasted) {
          port.datesTasted = port.datesTasted.filter(d => d !== meeting.date);
          await storage.set(`port:${portId}`, port);
        }
        setMeeting(newMeeting);
        setLinkedPorts(linkedPorts.filter(p => p.id !== portId));
        showToast('Port unlinked');
      };

      const handleDelete = async () => {
        const list = (await storage.get('meetings:list')) || [];
        await storage.set('meetings:list', list.filter(id => id !== meetingId));
        await storage.set(`meeting:${meetingId}`, null);
        showToast('Meeting deleted');
        onBack();
      };

      const handleAttachFile = async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        if (attachInputRef.current) attachInputRef.current.value = '';

        try {
          // Validate
          await validateFileUpload(file);

          // Compress images
          const processed = await compressImageFile(file);

          showToast('Uploading file...');
          const uploaderName = currentUserName || localStorage.getItem('pc_member') || 'Unknown';
          const timestamp = Date.now();
          const storagePath = `meetings/${meetingId}/${timestamp}_${processed.name}`;
          const fileRef = firebaseStorage.ref().child(storagePath);
          await fileRef.put(processed);
          const downloadURL = await fileRef.getDownloadURL();

          const att = {
            id: `att_${timestamp}`,
            name: processed.name,
            type: processed.type,
            size: processed.size,
            url: downloadURL,
            path: storagePath,
            uploadedBy: uploaderName,
            uploadedAt: new Date().toISOString(),
          };
          const attachments = [...(meeting.attachments || []), att];
          const updated = { ...meeting, attachments };
          const ok = await storage.set(`meeting:${meetingId}`, updated);
          if (ok) {
            setMeeting(updated);
            await updateStorageStats(processed.size, true);
            showToast('File attached!');
          } else {
            // Metadata save failed; clean up uploaded file
            try { await firebaseStorage.ref().child(storagePath).delete(); } catch (_) {}
            showToast('Failed to save attachment metadata.', 'error');
          }
        } catch (error) {
          console.error('Upload error:', error);
          showToast(error.message || 'Failed to upload file.', 'error');
        }
      };

      const deleteAttachment = async (attId) => {
        const att = (meeting.attachments || []).find(a => a.id === attId);
        if (att?.path) {
          try {
            await firebaseStorage.ref().child(att.path).delete();
            await updateStorageStats(att.size || 0, false);
          } catch (error) {
            console.error('Failed to delete file from storage:', error);
          }
        }
        const attachments = (meeting.attachments || []).filter(a => a.id !== attId);
        const updated = { ...meeting, attachments };
        await storage.set(`meeting:${meetingId}`, updated);
        setMeeting(updated);
        setDeleteAttId(null);
        showToast('Attachment removed');
      };

      const handlePhotoUpload = async (e) => {
        const files = Array.from(e.target.files || []);
        if (!files.length) return;
        if (photoInputRef.current) photoInputRef.current.value = '';

        setUploadingPhotos(true);
        const uploaderName = currentUserName || localStorage.getItem('pc_member') || 'Unknown';
        let currentMeeting = meeting;

        try {
          for (const file of files) {
            if (!file.type.startsWith('image/')) continue;
            const processed = await compressImageFile(file);
            const timestamp = Date.now();
            const storagePath = `meetings/${meetingId}/photos/${timestamp}_${processed.name}`;
            const fileRef = firebaseStorage.ref().child(storagePath);
            await fileRef.put(processed);
            const downloadURL = await fileRef.getDownloadURL();

            const photo = {
              id: `photo_${timestamp}`,
              url: downloadURL,
              caption: '',
              size: processed.size,
              uploadedBy: uploaderName,
              uploadedAt: new Date().toISOString(),
              path: storagePath,
            };
            const photos = [...(currentMeeting.photos || []), photo];
            currentMeeting = { ...currentMeeting, photos };
            await storage.set(`meeting:${meetingId}`, currentMeeting);
            await updateStorageStats(processed.size, true);
          }
          setMeeting(currentMeeting);
          showToast(files.length > 1 ? `${files.length} photos added!` : 'Photo added!');
        } catch (error) {
          console.error('Photo upload error:', error);
          showToast(error.message || 'Failed to upload photo.', 'error');
        } finally {
          setUploadingPhotos(false);
        }
      };

      const deletePhoto = async (photoId) => {
        const photo = (meeting.photos || []).find(p => p.id === photoId);
        if (photo?.path) {
          try {
            await firebaseStorage.ref().child(photo.path).delete();
            await updateStorageStats(photo.size || 0, false);
          } catch (error) {
            console.error('Failed to delete photo from storage:', error);
          }
        }
        const photos = (meeting.photos || []).filter(p => p.id !== photoId);
        const updated = { ...meeting, photos };
        await storage.set(`meeting:${meetingId}`, updated);
        setMeeting(updated);
        setDeletePhotoId(null);
        if (previewPhoto?.id === photoId) setPreviewPhoto(null);
        showToast('Photo removed');
      };

      const saveCaption = async (photoId, caption) => {
        const photos = (meeting.photos || []).map(p =>
          p.id === photoId ? { ...p, caption } : p
        );
        const updated = { ...meeting, photos };
        const ok = await storage.set(`meeting:${meetingId}`, updated);
        if (ok) {
          setMeeting(updated);
          setEditingCaption(null);
          showToast('Caption saved');
        } else {
          showToast('Failed to save caption', 'error');
        }
      };

      const downloadAttachment = async (att) => {
        const src = att.url || att.data;
        try {
          const response = await fetch(src);
          const blob = await response.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = att.name;
          a.click();
          URL.revokeObjectURL(url);
        } catch (error) {
          window.open(src, '_blank');
        }
      };

      if (loading) return <Spinner />;
      if (!meeting) return <p className="text-center text-port-400 py-12">Meeting not found.</p>;

      const dateObj = new Date(meeting.date + 'T12:00:00');
      const formatted = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
      const isUpcoming = meeting.status === 'upcoming';
      const attendees = meeting.attendees || [];

      return (
        <div className="fade-in max-w-2xl mx-auto">
          {showConfirm && (
            <ConfirmDialog
              title="Delete Meeting"
              message={`Are you sure you want to delete this meeting on ${formatted}?`}
              onConfirm={handleDelete}
              onCancel={() => setShowConfirm(false)}
            />
          )}
          {showPortPicker && (
            <PortPicker
              linkedIds={meeting.portsTasted || []}
              onSelect={linkPort}
              onClose={() => setShowPortPicker(false)}
            />
          )}
          {deleteAttId && (
            <ConfirmDialog
              title="Delete Attachment"
              message="Are you sure you want to remove this file?"
              onConfirm={() => deleteAttachment(deleteAttId)}
              onCancel={() => setDeleteAttId(null)}
            />
          )}
          {deletePhotoId && (
            <ConfirmDialog
              title="Delete Photo"
              message="Are you sure you want to remove this photo?"
              onConfirm={() => deletePhoto(deletePhotoId)}
              onCancel={() => setDeletePhotoId(null)}
            />
          )}
          {previewAtt && (() => {
            const src = previewAtt.url || previewAtt.data;
            const isImg = previewAtt.type && previewAtt.type.startsWith('image/');
            const isPdf = previewAtt.type && previewAtt.type.includes('pdf');
            return (
              <div className="fixed inset-0 z-50 flex flex-col bg-black/85 backdrop-blur-sm fade-in" onClick={() => setPreviewAtt(null)}>
                {/* Header */}
                <div className="flex items-center justify-between px-4 py-3 bg-black/40 border-b border-white/5" onClick={e => e.stopPropagation()}>
                  <div className="flex items-center gap-2 min-w-0">
                    <FileIcon type={previewAtt.type} />
                    <span className="text-port-100 text-sm font-medium truncate">{previewAtt.name}</span>
                    <span className="text-port-500 text-xs flex-shrink-0">{formatFileSize(previewAtt.size)}</span>
                  </div>
                  <div className="flex items-center gap-2 flex-shrink-0">
                    <button onClick={() => downloadAttachment(previewAtt)} className="px-3 py-1.5 rounded-lg glass-light text-port-200 hover:bg-white/10 transition text-sm">Download</button>
                    <button onClick={() => setPreviewAtt(null)} className="p-1.5 rounded-lg glass-light text-port-200 hover:bg-white/10 transition" title="Close">
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                  </div>
                </div>
                {/* Content */}
                <div className="flex-1 flex items-center justify-center overflow-auto p-4" onClick={e => { if (e.target === e.currentTarget) setPreviewAtt(null); }}>
                  {isImg && (
                    <img src={src} alt={previewAtt.name} className="max-w-full max-h-full object-contain rounded-lg" style={{ maxHeight: 'calc(100vh - 80px)' }} onClick={e => e.stopPropagation()} />
                  )}
                  {isPdf && (
                    <iframe src={src} title={previewAtt.name} className="w-full rounded-lg bg-white" style={{ maxWidth: '900px', height: 'calc(100vh - 80px)' }} onClick={e => e.stopPropagation()} />
                  )}
                  {!isImg && !isPdf && (
                    <div className="glass rounded-xl p-8 text-center" onClick={e => e.stopPropagation()}>
                      <FileIcon type={previewAtt.type} />
                      <p className="text-port-300 mt-3 mb-4">Preview not available for this file type.</p>
                      <button onClick={() => downloadAttachment(previewAtt)} className="px-5 py-2.5 rounded-lg bg-port-700 text-port-100 hover:bg-port-600 transition text-sm">Download File</button>
                    </div>
                  )}
                </div>
              </div>
            );
          })()}

          <button onClick={onBack} className="flex items-center gap-1 text-port-400 hover:text-port-200 mb-4 transition text-sm">
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg>
            Back to meetings
          </button>

          {/* Meeting Info */}
          <div className="glass rounded-xl p-6 mb-6">
            <div className="flex flex-wrap items-start justify-between gap-3 mb-4">
              <div>
                <span className={`inline-block text-xs font-medium px-2.5 py-1 rounded-full mb-2 ${
                  isUpcoming ? 'bg-emerald-900/40 text-emerald-400' : 'bg-port-800/60 text-port-300'
                }`}>{isUpcoming ? 'Upcoming' : 'Completed'}</span>
                <h2 className="font-display text-2xl sm:text-3xl text-port-100">{formatted}</h2>
                <p className="text-port-300 mt-0.5">{meeting.location} &middot; Hosted by {meeting.host}</p>
              </div>
            </div>
            {meeting.notes && (
              <div className="mb-3">
                <h4 className="text-xs font-semibold text-port-400 uppercase tracking-wider mb-1">Notes</h4>
                <p className="text-port-200 text-sm leading-relaxed">{meeting.notes}</p>
              </div>
            )}
            <div className="flex gap-2 mt-5 pt-4 border-t border-white/5">
              <button onClick={() => onEdit(meeting)} className="flex items-center gap-1.5 text-sm text-port-300 hover:text-port-100 transition">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                Edit
              </button>
              <button onClick={() => setShowConfirm(true)} className="flex items-center gap-1.5 text-sm text-red-400/70 hover:text-red-400 transition ml-4">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                Delete
              </button>
            </div>
          </div>

          {/* RSVPs */}
          <div className="glass rounded-xl p-6 mb-6">
            <h3 className="font-display text-xl text-port-100 mb-4">RSVPs ({attendees.length})</h3>
            {attendees.length > 0 && (
              <div className="space-y-2 mb-6">
                {attendees.map((a, i) => (
                  <div key={i} className="glass-light rounded-lg p-3 flex items-center justify-between gap-2">
                    <div className="min-w-0">
                      <span className="text-port-100 text-sm font-medium">{a.name}</span>
                      {a.bringing && <span className="text-port-400 text-xs ml-2">Bringing: {a.bringing}</span>}
                    </div>
                    <span className={`text-xs font-medium px-2 py-0.5 rounded-full flex-shrink-0 ${
                      a.rsvp === 'yes' ? 'bg-emerald-900/40 text-emerald-400' :
                      a.rsvp === 'maybe' ? 'bg-yellow-900/40 text-gold-400' :
                      'bg-red-900/40 text-red-400'
                    }`}>{a.rsvp}</span>
                  </div>
                ))}
              </div>
            )}
            {(() => {
              const userRsvp = attendees.find(a => a.name === (currentUserName || localStorage.getItem('pc_member') || ''));
              const hasRsvped = !!userRsvp;
              const showForm = !hasRsvped || rsvpFormExpanded;
              return showForm ? (
                <div>
                  <h4 className="text-sm font-medium text-port-300 mb-3">{hasRsvped ? 'Edit Your RSVP' : 'Add Your RSVP'}</h4>
                  <form onSubmit={submitRsvp} className="space-y-3">
                    <div>
                      <input type="text" value={rsvpName} onChange={e => setRsvpName(e.target.value)} placeholder="Your name" className="w-full rounded-lg px-3 py-2 text-sm" />
                      {rsvpErrors.name && <p className="text-red-400 text-xs mt-1">{rsvpErrors.name}</p>}
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-port-300 mb-2">Attending?</label>
                      <div className="flex gap-2">
                        {[{ v: 'yes', l: 'Yes', c: 'emerald' }, { v: 'maybe', l: 'Maybe', c: 'gold' }, { v: 'no', l: 'No', c: 'red' }].map(opt => (
                          <button key={opt.v} type="button" onClick={() => setRsvpStatus(opt.v)}
                            className={`px-4 py-1.5 rounded-full text-sm font-medium transition ${
                              rsvpStatus === opt.v
                                ? opt.c === 'emerald' ? 'bg-emerald-900/60 text-emerald-400 border border-emerald-500/30'
                                : opt.c === 'gold' ? 'bg-yellow-900/60 text-gold-400 border border-gold-500/30'
                                : 'bg-red-900/60 text-red-400 border border-red-500/30'
                                : 'glass-light text-port-300 border border-transparent hover:bg-white/5'
                            }`}>{opt.l}</button>
                        ))}
                      </div>
                    </div>
                    <div>
                      <input type="text" value={rsvpBringing} onChange={e => setRsvpBringing(e.target.value)} placeholder="What are you bringing? (optional)" className="w-full rounded-lg px-3 py-2 text-sm" />
                    </div>
                    <div className="flex gap-2">
                      <button type="submit" className="px-5 py-2.5 rounded-lg bg-gold-600 text-port-950 font-medium hover:bg-gold-500 transition text-sm">Save RSVP</button>
                      {hasRsvped && (
                        <button type="button" onClick={() => setRsvpFormExpanded(false)} className="px-5 py-2.5 rounded-lg glass-light text-port-300 hover:bg-white/10 transition text-sm">Cancel</button>
                      )}
                    </div>
                  </form>
                </div>
              ) : (
                <button
                  onClick={() => setRsvpFormExpanded(true)}
                  className="flex items-center gap-2 px-4 py-2 rounded-lg glass-light text-port-200 hover:bg-white/10 transition text-sm"
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                  Edit My RSVP
                </button>
              );
            })()}
          </div>

          {/* Ports Tasted */}
          <div className="glass rounded-xl p-6">
            <div className="flex items-center justify-between mb-4">
              <h3 className="font-display text-xl text-port-100">Ports Tasted</h3>
              <button onClick={() => setShowPortPicker(true)} className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg glass-light text-port-200 hover:bg-white/10 transition text-sm">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>
                Add Port
              </button>
            </div>
            {linkedPorts.length === 0 ? (
              <p className="text-port-400 text-sm">No ports linked to this meeting yet.</p>
            ) : (
              <div className="space-y-2">
                {linkedPorts.map(p => (
                  <div key={p.id} className="glass-light rounded-lg p-3 flex items-center justify-between gap-2">
                    <button onClick={() => onNavigateToPort(p.id)} className="text-left min-w-0 hover:text-gold-400 transition">
                      <span className="text-port-100 text-sm font-medium">{p.name}</span>
                      <span className="text-port-400 text-xs ml-2">{p.producer}{p.year ? ` \u00B7 ${p.year}` : ''}</span>
                    </button>
                    <button onClick={() => unlinkPort(p.id)} className="text-port-500 hover:text-red-400 transition flex-shrink-0" title="Unlink port">
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Attachments */}
          <div className="glass rounded-xl p-6 mt-6">
            <div className="flex items-center justify-between mb-4">
              <h3 className="font-display text-xl text-port-100">
                Attachments{(meeting.attachments || []).length > 0 && <span className="text-port-400 text-sm font-sans ml-2">({meeting.attachments.length})</span>}
              </h3>
              <button onClick={() => attachInputRef.current?.click()} className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg glass-light text-port-200 hover:bg-white/10 transition text-sm">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" /></svg>
                Attach File
              </button>
              <input ref={attachInputRef} type="file" accept={ACCEPTED_FILE_TYPES} className="hidden" onChange={handleAttachFile} />
            </div>
            {(meeting.attachments || []).length === 0 ? (
              <p className="text-port-400 text-sm">No files attached to this meeting yet.</p>
            ) : (
              <div className="space-y-2">
                {meeting.attachments.map(att => {
                  const isImage = att.type && att.type.startsWith('image/');
                  const isPdf = att.type && att.type.includes('pdf');
                  const canPreview = isImage || isPdf;
                  return (
                    <div key={att.id} className="glass-light rounded-lg p-3">
                      <div className="flex items-center gap-3">
                        {isImage ? (
                          <button onClick={() => setPreviewAtt(att)} className="flex-shrink-0">
                            <img src={att.url || att.data} alt={att.name} className="w-12 h-12 object-cover rounded border border-white/10" />
                          </button>
                        ) : (
                          <button onClick={() => canPreview ? setPreviewAtt(att) : downloadAttachment(att)} className="flex-shrink-0 w-12 h-12 rounded border border-white/10 flex items-center justify-center bg-white/[0.02] hover:bg-white/[0.06] transition cursor-pointer">
                            <FileIcon type={att.type} />
                          </button>
                        )}
                        <div className="min-w-0 flex-1">
                          <p className="text-port-100 text-sm font-medium truncate">{att.name}</p>
                          <p className="text-port-500 text-xs">{formatFileSize(att.size)} &middot; {att.uploadedBy} &middot; {new Date(att.uploadedAt).toLocaleDateString()}</p>
                        </div>
                        <div className="flex gap-1 flex-shrink-0">
                          {canPreview && (
                            <button onClick={() => setPreviewAtt(att)} className="p-1.5 rounded-lg hover:bg-white/10 transition text-port-400 hover:text-port-200" title="Preview">
                              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                            </button>
                          )}
                          <button onClick={() => downloadAttachment(att)} className="p-1.5 rounded-lg hover:bg-white/10 transition text-port-400 hover:text-port-200" title="Download">
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                          </button>
                          <button onClick={() => setDeleteAttId(att.id)} className="p-1.5 rounded-lg hover:bg-white/10 transition text-port-500 hover:text-red-400" title="Delete">
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                          </button>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>

          {/* Photo Album */}
          <div className="glass rounded-xl p-6 mt-6">
            <div className="flex items-center justify-between mb-4">
              <h3 className="font-display text-xl text-port-100">
                Photo Album{(meeting.photos || []).length > 0 && <span className="text-port-400 text-sm font-sans ml-2">({meeting.photos.length})</span>}
              </h3>
              <button
                onClick={() => photoInputRef.current?.click()}
                disabled={uploadingPhotos}
                className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg glass-light text-port-200 hover:bg-white/10 transition text-sm disabled:opacity-50"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                {uploadingPhotos ? 'Uploading...' : 'Add Photos'}
              </button>
              <input ref={photoInputRef} type="file" accept="image/jpeg,image/png,image/webp" multiple className="hidden" onChange={handlePhotoUpload} />
            </div>
            {(meeting.photos || []).length === 0 ? (
              <p className="text-port-400 text-sm italic text-center py-4">No photos yet. Capture memories from this tasting.</p>
            ) : (
              <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                {meeting.photos.map(photo => (
                  <div
                    key={photo.id}
                    className="relative group cursor-pointer rounded-lg overflow-hidden border border-white/10"
                    style={{ aspectRatio: '4/3' }}
                    onClick={() => { setPreviewPhoto(photo); setEditingCaption(null); }}
                  >
                    <img
                      src={photo.url}
                      alt={photo.caption || 'Meeting photo'}
                      className="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                    />
                    {/* Caption overlay */}
                    {photo.caption && (
                      <div className="absolute bottom-0 left-0 right-0 px-2.5 py-1.5" style={{ background: 'linear-gradient(transparent, rgba(0,0,0,0.75))' }}>
                        <p className="text-white text-xs italic truncate">{photo.caption}</p>
                      </div>
                    )}
                    {/* Delete button */}
                    <button
                      onClick={(e) => { e.stopPropagation(); setDeletePhotoId(photo.id); }}
                      className="absolute top-1.5 right-1.5 w-6 h-6 rounded-full flex items-center justify-center text-white text-xs opacity-0 group-hover:opacity-80 transition"
                      style={{ background: 'rgba(0,0,0,0.6)' }}
                    >&times;</button>
                    {/* Uploader tag */}
                    <div className="absolute top-1.5 left-1.5 opacity-0 group-hover:opacity-80 transition">
                      <span className="text-white text-xs px-1.5 py-0.5 rounded" style={{ background: 'rgba(0,0,0,0.5)', fontSize: '0.65rem' }}>{photo.uploadedBy}</span>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Photo Preview Modal */}
          {previewPhoto && (
            <div className="fixed inset-0 z-50 flex flex-col bg-black/90 backdrop-blur-sm fade-in" onClick={() => setPreviewPhoto(null)}>
              {/* Header */}
              <div className="flex items-center justify-between px-4 py-3 bg-black/40 border-b border-white/5" onClick={e => e.stopPropagation()}>
                <div className="flex items-center gap-2 min-w-0">
                  <svg className="w-5 h-5 text-port-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                  <span className="text-port-300 text-sm">{previewPhoto.uploadedBy} &middot; {new Date(previewPhoto.uploadedAt).toLocaleDateString()}</span>
                </div>
                <div className="flex items-center gap-2 flex-shrink-0">
                  <button onClick={(e) => { e.stopPropagation(); setDeletePhotoId(previewPhoto.id); }} className="p-1.5 rounded-lg glass-light text-port-400 hover:text-red-400 transition" title="Delete">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                  </button>
                  <button onClick={() => setPreviewPhoto(null)} className="p-1.5 rounded-lg glass-light text-port-200 hover:bg-white/10 transition" title="Close">
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                  </button>
                </div>
              </div>
              {/* Photo */}
              <div className="flex-1 flex items-center justify-center overflow-auto p-4" onClick={e => { if (e.target === e.currentTarget) setPreviewPhoto(null); }}>
                <img src={previewPhoto.url} alt={previewPhoto.caption || 'Meeting photo'} className="max-w-full max-h-full object-contain rounded-lg" style={{ maxHeight: 'calc(100vh - 140px)' }} onClick={e => e.stopPropagation()} />
              </div>
              {/* Caption */}
              <div className="px-4 py-3 bg-black/40 border-t border-white/5" onClick={e => e.stopPropagation()}>
                {editingCaption === previewPhoto.id ? (
                  <div className="flex gap-2">
                    <input
                      type="text"
                      value={captionText}
                      onChange={e => setCaptionText(e.target.value)}
                      placeholder="Add a caption..."
                      className="flex-1 rounded-lg px-3 py-2 text-sm"
                      autoFocus
                      onKeyDown={e => { if (e.key === 'Enter') saveCaption(previewPhoto.id, captionText); if (e.key === 'Escape') setEditingCaption(null); }}
                    />
                    <button onClick={() => saveCaption(previewPhoto.id, captionText)} className="px-4 py-2 rounded-lg bg-gold-600 text-port-950 font-medium hover:bg-gold-500 transition text-sm">Save</button>
                    <button onClick={() => setEditingCaption(null)} className="px-4 py-2 rounded-lg glass-light text-port-300 hover:bg-white/10 transition text-sm">Cancel</button>
                  </div>
                ) : (
                  <button
                    onClick={() => { setEditingCaption(previewPhoto.id); setCaptionText(previewPhoto.caption || ''); }}
                    className="text-left w-full text-sm italic transition hover:text-port-200"
                    style={{ color: previewPhoto.caption ? 'rgba(245,208,224,0.8)' : 'rgba(245,208,224,0.35)' }}
                  >
                    {previewPhoto.caption || 'Click to add caption...'}
                  </button>
                )}
              </div>
            </div>
          )}
        </div>
      );
    }

    /* ───────────────── Phone Login Screen ───────────────── */

    function PhoneLoginScreen({ onLoginSuccess }) {
      const [step, setStep] = useState('phone'); // 'phone' | 'code' | 'name'
      const [phoneNumber, setPhoneNumber] = useState('');
      const [verificationCode, setVerificationCode] = useState('');
      const [userName, setUserName] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);
      const [confirmationResult, setConfirmationResult] = useState(null);

      // If already authenticated (e.g. page refreshed during name step), jump to name
      useEffect(() => {
        if (auth.currentUser) setStep('name');
      }, []);

      const sendCode = async () => {
        setError('');
        setLoading(true);
        try {
          const digits = phoneNumber.replace(/\D/g, '');
          if (!digits.startsWith('07')) throw new Error('UK mobile numbers should start with 07');
          if (digits.length !== 11) throw new Error('Please enter a valid 11-digit UK mobile number (e.g., 07123 456789)');
          const normalized = '+44' + digits.substring(1);
          if (!isPhoneApproved(normalized)) throw new Error('This phone number is not authorized. Please contact an administrator.');

          // Create fresh invisible reCAPTCHA verifier
          if (window.recaptchaVerifier) {
            try { window.recaptchaVerifier.clear(); } catch (_) {}
          }
          window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { size: 'invisible' });

          const confirmation = await auth.signInWithPhoneNumber(normalized, window.recaptchaVerifier);
          setConfirmationResult(confirmation);
          setStep('code');
        } catch (err) {
          console.error('Error sending code:', err);
          setError(err.message || 'Failed to send verification code.');
          if (window.recaptchaVerifier) {
            try { window.recaptchaVerifier.clear(); } catch (_) {}
            window.recaptchaVerifier = null;
          }
        } finally {
          setLoading(false);
        }
      };

      const verifyCode = async () => {
        setError('');
        setLoading(true);
        try {
          const result = await confirmationResult.confirm(verificationCode);
          const profile = await getUserProfile(result.user.uid);
          if (profile) {
            await updateLastLogin(result.user.uid);
            onLoginSuccess(profile.name);
          } else {
            setStep('name');
          }
        } catch (err) {
          console.error('Error verifying code:', err);
          setError('Invalid verification code. Please try again.');
        } finally {
          setLoading(false);
        }
      };

      const saveName = async () => {
        if (!userName.trim()) { setError('Please enter your name'); return; }
        setLoading(true);
        try {
          await saveUserProfile(auth.currentUser.uid, userName.trim());
          onLoginSuccess(userName.trim());
        } catch (err) {
          console.error('Error saving profile:', err);
          setError('Failed to save profile. Please try again.');
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="min-h-screen flex items-center justify-center p-4" style={{ background: 'linear-gradient(135deg, #1a0505 0%, #2d0a0a 100%)' }}>
          <div className="glass rounded-2xl p-8 max-w-sm w-full fade-in">
            <h1 className="font-display text-3xl text-port-100 text-center mb-1">Port Committee</h1>
            <p className="text-port-400 text-center text-sm mb-8">
              {step === 'phone' && 'Sign in with your phone number'}
              {step === 'code' && 'Enter verification code'}
              {step === 'name' && 'Welcome! What should we call you?'}
            </p>

            {error && (
              <div className="rounded-lg bg-red-900/30 border border-red-500/20 text-red-300 px-4 py-3 text-sm mb-4">
                {error}
              </div>
            )}

            {step === 'phone' && (
              <>
                <div className="mb-4">
                  <label className="block text-sm font-medium text-port-300 mb-1">UK Mobile Number</label>
                  <input
                    type="tel"
                    placeholder="07123 456789"
                    value={phoneNumber}
                    onChange={(e) => {
                      let digits = e.target.value.replace(/\D/g, '');
                      if (digits.length > 11) digits = digits.substring(0, 11);
                      setPhoneNumber(digits);
                    }}
                    className="w-full rounded-lg px-3 py-2.5 text-sm"
                    disabled={loading}
                    onKeyDown={(e) => e.key === 'Enter' && phoneNumber && sendCode()}
                  />
                  <p className="text-port-500 text-xs mt-1.5">Enter your 11-digit UK mobile (e.g., 07123 456789)</p>
                </div>
                <div id="recaptcha-container"></div>
                <button
                  onClick={sendCode}
                  disabled={loading || !phoneNumber}
                  className="w-full py-2.5 rounded-lg bg-port-700 text-port-100 hover:bg-port-600 transition text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {loading ? 'Sending...' : 'Send Verification Code'}
                </button>
              </>
            )}

            {step === 'code' && (
              <>
                <p className="text-port-400 text-xs mb-4">
                  A 6-digit code was sent to {phoneNumber}
                </p>
                <div className="mb-4">
                  <input
                    type="text"
                    inputMode="numeric"
                    maxLength={6}
                    placeholder="000000"
                    value={verificationCode}
                    onChange={(e) => setVerificationCode(e.target.value.replace(/\D/g, ''))}
                    className="w-full rounded-lg px-3 py-3 text-lg text-center tracking-[0.4em]"
                    disabled={loading}
                    autoFocus
                    onKeyDown={(e) => e.key === 'Enter' && verificationCode.length === 6 && verifyCode()}
                  />
                </div>
                <button
                  onClick={verifyCode}
                  disabled={loading || verificationCode.length !== 6}
                  className="w-full py-2.5 rounded-lg bg-port-700 text-port-100 hover:bg-port-600 transition text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed mb-3"
                >
                  {loading ? 'Verifying...' : 'Verify Code'}
                </button>
                <button
                  onClick={() => { setStep('phone'); setVerificationCode(''); setError(''); }}
                  className="w-full py-2.5 rounded-lg glass-light text-port-300 hover:bg-white/10 transition text-sm"
                >
                  Change Phone Number
                </button>
              </>
            )}

            {step === 'name' && (
              <>
                <p className="text-port-400 text-xs mb-4">
                  This name will appear on your ratings and uploads.
                </p>
                <div className="mb-4">
                  <label className="block text-sm font-medium text-port-300 mb-1">Your Name</label>
                  <input
                    type="text"
                    placeholder="e.g., Gareth"
                    value={userName}
                    onChange={(e) => setUserName(e.target.value)}
                    className="w-full rounded-lg px-3 py-2.5 text-sm"
                    disabled={loading}
                    autoFocus
                    onKeyDown={(e) => e.key === 'Enter' && userName.trim() && saveName()}
                  />
                </div>
                <button
                  onClick={saveName}
                  disabled={loading || !userName.trim()}
                  className="w-full py-2.5 rounded-lg bg-port-700 text-port-100 hover:bg-port-600 transition text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {loading ? 'Saving...' : 'Continue'}
                </button>
              </>
            )}
          </div>
        </div>
      );
    }

    /* ───────────────── Landing Page ───────────────── */

    const SUBHEADINGS = [
      "Serious about Port. Not serious about much else.",
      "Committee meetings mandatory. Pants optional.",
      "Est. 2024. Pretending we know what we're doing since 2024.",
      "One bottle, many opinions, zero regrets.",
      "Where good Ports meet questionable decisions.",
      "Tasting notes and mild chaos.",
      "Members only. (We accept everyone.)",
      "An elite society of people who just really like Port.",
      "By invitation only. (Just ask.)",
      "What's in the glass matters. What's on the agenda doesn't.",
      "Curated selections. Unfiltered conversations.",
      "The only committee where attendance is never mandatory.",
      "We take Port seriously. Ourselves, less so.",
      "Expert-level enthusiasm. Amateur-level expertise.",
      "Sommelier aspirations. Enthusiast budgets.",
      "Some committees build futures. We just build a really good evening.",
      "In Port we trust. Everything else is up for debate.",
      "The only committee where filibustering means finishing the bottle.",
      "Self-appointed experts since 2024.",
      "Our qualifications? Enthusiasm and a decent palate.",
      "Good Ports. Better company. Questionable playlist choices.",
      "Where the tasting notes get poetic and the decisions get collective.",
      "Decanting democracy, one bottle at a time.",
      "Minutes from last meeting: we drank the evidence.",
      "Agenda item #1: open bottle. Agenda item #2: see item #1.",
      "Quorum requires at least one person and one corkscrew.",
      "Small pours, big opinions.",
      "Technically a committee. Actually just friends with a spreadsheet.",
      "We came for the Port. We stayed for the arguments.",
      "Refresh for a different excuse to open a bottle.",
      "This text changes. Your taste in Port shouldn't.",
      "Tannin analysis: optional. Having opinions: mandatory.",
      "Vintage matters. So does the cheese selection.",
      "We don't always finish the bottle, but we always finish the conversation.",
      "Governing body of good taste. Subcommittee of great nights.",
      "Elected unanimously. Because we were the only ones voting.",
      "Where 7pm becomes 'just one more' becomes midnight.",
      "Scheduled meetings. Unscheduled revelations.",
      "Port. People. Done.",
      "Less meeting, more tasting.",
      "Committee: yes. Commitment: flexible.",
      "High-stakes decisions about low-stakes evenings.",
      "Critical infrastructure for your social calendar.",
      "The most important committee you'll never hear about in the news.",
      "Organized enough to have a name. Relaxed enough to forget it.",
      "Structured tastings. Unstructured everything else.",
      "We have a spreadsheet. We rarely consult it.",
      "Good bottles, better people, best stories.",
      "Small group. Big glasses. Huge fun.",
      "You've found us. The Port is already open.",
      "Secret handshake: knowing the difference between Tawny and Ruby.",
      "We don't talk about Port Committee. (We just drink at it.)",
      "Disrupting the Port space. Pivoting to enjoyment.",
      "Agile methodology applied to drinking slowly.",
      "We could've just made a group chat. We made this instead.",
      "The formality is fake. The Port is real.",
      "Committee structure: unnecessary. Fun structure: essential.",
      "None of these matter. Click something. Drink something.",
      "This whole page is an elaborate excuse to not drink alone.",
      "Overthinking Port since 2024.",
      "Taking something simple and making it slightly complicated. That's us.",
      "Hey. Yes, you. Open something nice tonight.",
      "We're all just text on a screen, man. Pour something.",
      "Congratulations. You've found the Port Committee.",
    ];

    const LANDING_CONTOURS = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 900" preserveAspectRatio="xMidYMid slice"><defs><style>path{fill:none;stroke:#f2ece4;stroke-linecap:round}</style></defs><g opacity="0.07"><path d="M-20 80 Q150 40 300 90 T600 70 T900 100 T1220 60" stroke-width="1.2"/><path d="M-20 130 Q180 95 350 140 T650 115 T950 150 T1220 110" stroke-width="1"/><path d="M-20 185 Q120 155 280 190 T580 170 T880 200 T1220 165" stroke-width="1.3"/><path d="M-20 240 Q200 210 380 245 T700 225 T980 255 T1220 220" stroke-width="0.8"/><path d="M-20 295 Q160 270 320 300 T640 280 T940 310 T1220 275" stroke-width="1.1"/><path d="M-20 350 Q140 325 310 355 T620 340 T920 365 T1220 335" stroke-width="1"/><path d="M-20 410 Q190 385 370 415 T680 395 T960 420 T1220 390" stroke-width="1.2"/><path d="M-20 465 Q130 445 290 470 T590 455 T890 475 T1220 450" stroke-width="0.9"/><path d="M-20 520 Q170 500 340 525 T660 510 T940 535 T1220 505" stroke-width="1.1"/><path d="M-20 580 Q210 560 400 585 T720 565 T1000 590 T1220 565" stroke-width="1"/><path d="M-20 635 Q150 620 310 640 T610 625 T910 645 T1220 620" stroke-width="1.3"/><path d="M-20 690 Q180 675 360 695 T670 680 T960 700 T1220 680" stroke-width="0.8"/><path d="M-20 750 Q140 735 300 755 T600 740 T900 760 T1220 740" stroke-width="1"/><path d="M-20 810 Q200 795 380 815 T700 800 T980 820 T1220 800" stroke-width="1.1"/><path d="M-20 865 Q160 855 330 870 T640 860 T940 875 T1220 855" stroke-width="0.9"/><path d="M-20 200 Q100 230 250 180 T500 220 T750 170 T1000 210 T1220 190" stroke-width="2" opacity="0.7"/><path d="M-20 210 Q110 240 260 195 T510 235 T760 185 T1010 225 T1220 200" stroke-width="1.5" opacity="0.5"/></g></svg>`;

    function LandingPage({ onEnter }) {
      const [exiting, setExiting] = useState(false);
      const [subheading] = useState(() => SUBHEADINGS[Math.floor(Math.random() * SUBHEADINGS.length)]);

      const handleEnter = () => {
        setExiting(true);
        setTimeout(onEnter, 800);
      };

      const contourBg = `url("data:image/svg+xml,${encodeURIComponent(LANDING_CONTOURS)}")`;

      return (
        <div className={`landing ${exiting ? 'exit' : ''}`}>
          <div
            className="landing-contours"
            style={{
              background: contourBg,
              backgroundSize: 'cover',
              backgroundPosition: 'center',
            }}
          />
          <div style={{ position: 'relative', textAlign: 'center', padding: '0 2rem', maxWidth: '520px' }}>
            <h1
              className="landing-headline"
              style={{
                fontFamily: "'Playfair Display', serif",
                fontSize: 'clamp(2.4rem, 8vw, 4rem)',
                fontWeight: 600,
                color: '#f2ece4',
                lineHeight: 1.1,
                marginBottom: '1.2rem',
              }}
            >
              Port Committee
            </h1>
            <p
              className="landing-sub"
              style={{
                fontFamily: "'Inter', sans-serif",
                fontSize: 'clamp(0.85rem, 2.5vw, 1.05rem)',
                fontWeight: 300,
                color: 'rgba(242, 236, 228, 0.55)',
                letterSpacing: '0.12em',
                lineHeight: 1.7,
                marginBottom: '3.5rem',
              }}
            >
              {subheading}
            </p>
            <div className="landing-btn">
              <button className="landing-enter" onClick={handleEnter}>
                Enter
              </button>
            </div>
          </div>
        </div>
      );
    }

    /* ───────────────── Dashboard ───────────────── */

    function StorageUsage() {
      const [stats, setStats] = useState(null);
      useEffect(() => { getStorageStats().then(setStats); }, []);
      if (!stats || (stats.totalBytes === 0 && stats.fileCount === 0)) return null;
      const pct = ((stats.totalBytes / MAX_TOTAL_STORAGE) * 100).toFixed(1);
      const usedMB = (stats.totalBytes / (1024 * 1024)).toFixed(1);
      const limitGB = (MAX_TOTAL_STORAGE / (1024 * 1024 * 1024)).toFixed(1);
      return (
        <div className="mt-8 text-center text-port-500 text-xs" style={{ opacity: 0.7 }}>
          <p>Storage: {usedMB} MB / {limitGB} GB ({pct}%) &middot; {stats.fileCount} / {MAX_FILE_COUNT} files</p>
        </div>
      );
    }

    // Track whether video has been seen this session (persists across re-renders)
    const _dashboardVideoSeen = { current: false };

    function Dashboard({ onSelectSection, currentUserName, onLogout }) {
      const videoRef = useRef(null);
      const [videoPhase, setVideoPhase] = useState(() => _dashboardVideoSeen.current ? 'complete' : 'loading');
      const [showContent, setShowContent] = useState(_dashboardVideoSeen.current);
      const [videoLoaded, setVideoLoaded] = useState(false);

      useEffect(() => {
        if (_dashboardVideoSeen.current) return;

        if (!videoLoaded) return;

        // Video loaded — start the sequence
        setVideoPhase('fade-in');

        // 0.5s: fully visible
        const t1 = setTimeout(() => setVideoPhase('playing'), 500);
        // 3s: start fading to watermark, reveal content
        const t2 = setTimeout(() => {
          setVideoPhase('fade-out');
          setShowContent(true);
        }, 3000);
        // 4s: settle at watermark opacity
        const t3 = setTimeout(() => {
          setVideoPhase('complete');
          _dashboardVideoSeen.current = true;
        }, 4000);

        return () => { clearTimeout(t1); clearTimeout(t2); clearTimeout(t3); };
      }, [videoLoaded]);

      // Fallback: if video fails to load within 3s, skip to content
      useEffect(() => {
        if (_dashboardVideoSeen.current) return;
        const fallback = setTimeout(() => {
          if (!videoLoaded) {
            setVideoPhase('complete');
            setShowContent(true);
            _dashboardVideoSeen.current = true;
          }
        }, 3000);
        return () => clearTimeout(fallback);
      }, [videoLoaded]);

      const videoOpacity = { loading: 0, 'fade-in': 0, playing: 1, 'fade-out': 0.08, complete: 0.08 }[videoPhase] ?? 0.08;
      const videoTransition = videoPhase === 'fade-in' ? 'opacity 0.5s ease-in' : videoPhase === 'fade-out' ? 'opacity 1s ease-out' : 'none';

      const VIDEO_URL = 'https://firebasestorage.googleapis.com/v0/b/port-committee.firebasestorage.app/o/Assets%2F20260206_1128_New%20Video_storyboard_01kgsbbsgmfhfvg4remrrd3xq4%20(1).mp4?alt=media&token=1ac8e5ca-c014-46ce-8d7c-88e45e875f9f';

      const sections = [
        {
          key: 'meetings',
          title: 'Meetings',
          description: 'Schedule & coordinate tastings',
          icon: (
            <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
          ),
        },
        {
          key: 'garrafeira',
          title: 'Garrafeira',
          description: 'Our vintage cellar',
          icon: (
            <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M12 3v2m0 0c-1 0-2.5.5-2.5 2v1.5c0 .5-.5 1.5-1.5 2v1c0 .5.2 1 .5 1.5L10 15v4a2 2 0 002 2v0a2 2 0 002-2v-4l1.5-2c.3-.5.5-1 .5-1.5v-1c-1-.5-1.5-1.5-1.5-2V7c0-1.5-1.5-2-2.5-2z" />
            </svg>
          ),
        },
        {
          key: 'library',
          title: 'Library',
          description: 'References & resources',
          icon: (
            <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
            </svg>
          ),
        },
      ];

      return (
        <div style={{ position: 'relative', minHeight: '100vh', overflow: 'hidden' }}>
          {/* Video Background */}
          <video
            ref={videoRef}
            autoPlay
            muted
            playsInline
            onLoadedData={() => setVideoLoaded(true)}
            style={{
              position: 'fixed',
              top: '50%',
              left: '50%',
              minWidth: '100%',
              minHeight: '100%',
              width: 'auto',
              height: 'auto',
              transform: 'translate(-50%, -50%)',
              objectFit: 'cover',
              zIndex: 0,
              opacity: videoLoaded ? videoOpacity : 0,
              transition: videoTransition,
              pointerEvents: 'none',
            }}
          >
            <source src={VIDEO_URL} type="video/mp4" />
          </video>

          {/* Dark overlay for readability */}
          <div style={{
            position: 'fixed',
            inset: 0,
            background: 'rgba(26, 5, 5, 0.35)',
            zIndex: 1,
            pointerEvents: 'none',
          }} />

          {/* Dashboard Content */}
          <div className={`dashboard-view ${showContent ? 'dashboard-content-visible' : ''}`} style={{ position: 'relative', zIndex: 2 }}>
            <div className="dashboard-title" style={{ textAlign: 'center', marginBottom: '3rem' }}>
              <h1 className="font-display text-port-100" style={{ fontSize: 'clamp(1.8rem, 5vw, 2.5rem)', marginBottom: '0.5rem' }}>Port Committee</h1>
              <p className="text-port-400" style={{ fontSize: '0.85rem', letterSpacing: '0.15em', textTransform: 'uppercase' }}>Select a section</p>
            </div>
            <div className="flex flex-col gap-4 w-full items-center">
              {sections.map((s, i) => (
                <button
                  key={s.key}
                  onClick={() => onSelectSection(s.key)}
                  className={`dashboard-card dashboard-card-${i} flex items-center gap-4 text-left`}
                >
                  <div className="text-gold-400 flex-shrink-0">{s.icon}</div>
                  <div>
                    <h2 className="font-display text-lg text-port-100">{s.title}</h2>
                    <p className="text-port-400 text-sm">{s.description}</p>
                  </div>
                </button>
              ))}
            </div>
            <StorageUsage />
            {currentUserName && (
              <div className="mt-6 text-center">
                <p className="text-port-500 text-xs mb-2">Signed in as <span className="text-port-300">{currentUserName}</span></p>
                <button onClick={onLogout} className="text-port-500 text-xs hover:text-port-300 transition underline underline-offset-2">
                  Sign out
                </button>
              </div>
            )}
          </div>
        </div>
      );
    }

    /* ───────────────── Library Section ───────────────── */

    const LIBRARY_CATEGORIES = [
      'Vintage Charts',
      'Presentations',
      'Tasting Guides',
      'Port Producers Info',
      'Reference Books',
      'Other',
    ];

    const LIBRARY_CATEGORY_ICONS = {
      'Vintage Charts': '\uD83C\uDF77',
      'Presentations': '\uD83D\uDCCA',
      'Tasting Guides': '\uD83D\uDCD6',
      'Port Producers Info': '\uD83C\uDFED',
      'Reference Books': '\uD83D\uDCDA',
      'Other': '\uD83D\uDCDD',
    };

    function LibraryUploadForm({ onSave, onCancel, currentUserName }) {
      const [file, setFile] = useState(null);
      const [name, setName] = useState('');
      const [description, setDescription] = useState('');
      const [category, setCategory] = useState('Other');
      const [tags, setTags] = useState('');
      const [uploaderName, setUploaderName] = useState(() => currentUserName || localStorage.getItem('pc_member') || '');
      const [saving, setSaving] = useState(false);
      const [errors, setErrors] = useState({});
      const fileInputRef = useRef(null);

      const handleFileChange = (e) => {
        const f = e.target.files?.[0];
        if (!f) return;
        setFile(f);
        if (!name) setName(f.name.replace(/\.[^/.]+$/, ''));
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        const errs = {};
        if (!file) errs.file = 'Please select a file';
        if (!name.trim()) errs.name = 'Name is required';
        if (!uploaderName.trim()) errs.uploaderName = 'Your name is required';
        setErrors(errs);
        if (Object.keys(errs).length) return;

        setSaving(true);
        localStorage.setItem('pc_member', uploaderName.trim());
        await onSave({
          file,
          name: name.trim(),
          description: description.trim(),
          category,
          tags: tags.split(',').map(t => t.trim()).filter(Boolean),
          uploaderName: uploaderName.trim(),
        });
        setSaving(false);
      };

      return (
        <form onSubmit={handleSubmit} className="fade-in glass rounded-xl p-6 max-w-lg mx-auto">
          <h2 className="font-display text-2xl text-port-100 mb-6">Upload Document</h2>

          {/* File picker */}
          <div className="mb-4">
            <label className="block text-sm font-medium text-port-300 mb-1">File <span className="text-port-500 ml-0.5">*</span></label>
            <button type="button" onClick={() => fileInputRef.current?.click()}
              className="w-full text-left rounded-lg px-4 py-3 glass-light text-port-200 hover:bg-white/10 transition text-sm border border-dashed border-white/10">
              {file ? (
                <span className="flex items-center gap-2">
                  <FileIcon type={file.type} />
                  <span className="truncate">{file.name}</span>
                  <span className="text-port-500 flex-shrink-0">({formatFileSize(file.size)})</span>
                </span>
              ) : 'Choose file...'}
            </button>
            <input ref={fileInputRef} type="file" accept={ACCEPTED_FILE_TYPES} className="hidden" onChange={handleFileChange} />
            {errors.file && <p className="text-red-400 text-xs mt-1">{errors.file}</p>}
          </div>

          {/* Name */}
          <div className="mb-4">
            <label className="block text-sm font-medium text-port-300 mb-1">Document Name <span className="text-port-500 ml-0.5">*</span></label>
            <input type="text" value={name} onChange={e => setName(e.target.value)} placeholder="e.g. Vintage Chart 2020-2024" className="w-full rounded-lg px-3 py-2 text-sm" />
            {errors.name && <p className="text-red-400 text-xs mt-1">{errors.name}</p>}
          </div>

          {/* Description */}
          <div className="mb-4">
            <label className="block text-sm font-medium text-port-300 mb-1">Description</label>
            <textarea value={description} onChange={e => setDescription(e.target.value)} rows={2} placeholder="Brief description..." className="w-full rounded-lg px-3 py-2 text-sm" />
          </div>

          {/* Category */}
          <div className="mb-4">
            <label className="block text-sm font-medium text-port-300 mb-1">Category</label>
            <select value={category} onChange={e => setCategory(e.target.value)} className="w-full rounded-lg px-3 py-2 text-sm">
              {LIBRARY_CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}
            </select>
          </div>

          {/* Tags */}
          <div className="mb-4">
            <label className="block text-sm font-medium text-port-300 mb-1">Tags</label>
            <input type="text" value={tags} onChange={e => setTags(e.target.value)} placeholder="e.g. tawny, douro, 2020" className="w-full rounded-lg px-3 py-2 text-sm" />
          </div>

          {/* Uploader name */}
          <div className="mb-6">
            <label className="block text-sm font-medium text-port-300 mb-1">Your Name <span className="text-port-500 ml-0.5">*</span></label>
            <input type="text" value={uploaderName} onChange={e => setUploaderName(e.target.value)} placeholder="Name" className="w-full rounded-lg px-3 py-2 text-sm" />
            {errors.uploaderName && <p className="text-red-400 text-xs mt-1">{errors.uploaderName}</p>}
          </div>

          <div className="flex gap-3 justify-end">
            <button type="button" onClick={onCancel} className="px-4 py-2 rounded-lg glass-light text-port-200 hover:bg-white/10 transition text-sm">Cancel</button>
            <button type="submit" disabled={saving} className="px-5 py-2 rounded-lg bg-port-700 text-port-100 hover:bg-port-600 transition text-sm disabled:opacity-50">
              {saving ? 'Uploading...' : 'Upload'}
            </button>
          </div>
        </form>
      );
    }

    function LibraryCard({ doc, onPreview, onDownload, onDelete }) {
      const f = doc.file || {};
      const isImage = f.type && f.type.startsWith('image/');
      const isPdf = f.type && f.type.includes('pdf');
      const canPreview = isImage || isPdf;
      const catIcon = LIBRARY_CATEGORY_ICONS[doc.category] || '\uD83D\uDCDD';

      return (
        <div className="glass rounded-xl p-4 fade-in">
          <div className="flex items-start gap-3">
            <div className="flex-shrink-0 w-10 h-10 rounded-lg border border-white/10 flex items-center justify-center bg-white/[0.02] text-lg">
              {catIcon}
            </div>
            <div className="min-w-0 flex-1">
              <h3 className="text-port-100 font-medium text-sm truncate">{doc.name}</h3>
              <div className="flex flex-wrap items-center gap-x-2 gap-y-0.5 mt-0.5">
                <span className="text-[10px] font-medium px-1.5 py-0.5 rounded-full bg-port-800/60 text-port-400">{doc.category}</span>
                <span className="text-port-500 text-xs">{f.name?.split('.').pop()?.toUpperCase()}</span>
                <span className="text-port-500 text-xs">{formatFileSize(f.size)}</span>
              </div>
              {doc.description && <p className="text-port-400 text-xs mt-1 line-clamp-2">{doc.description}</p>}
              <p className="text-port-500 text-[10px] mt-1">{doc.uploadedBy} &middot; {new Date(doc.uploadedAt).toLocaleDateString()}</p>
              {doc.tags?.length > 0 && (
                <div className="flex flex-wrap gap-1 mt-1.5">
                  {doc.tags.map(t => <span key={t} className="text-[10px] px-1.5 py-0.5 rounded-full bg-white/5 text-port-400">{t}</span>)}
                </div>
              )}
            </div>
            <div className="flex gap-1 flex-shrink-0">
              {canPreview && (
                <button onClick={() => onPreview(doc)} className="p-1.5 rounded-lg hover:bg-white/10 transition text-port-400 hover:text-port-200" title="Preview">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                </button>
              )}
              <button onClick={() => onDownload(doc)} className="p-1.5 rounded-lg hover:bg-white/10 transition text-port-400 hover:text-port-200" title="Download">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
              </button>
              <button onClick={() => onDelete(doc)} className="p-1.5 rounded-lg hover:bg-white/10 transition text-port-500 hover:text-red-400" title="Delete">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
              </button>
            </div>
          </div>
        </div>
      );
    }

    function LibrarySection({ onBack, currentUserName }) {
      const [docs, setDocs] = useState([]);
      const [loading, setLoading] = useState(true);
      const [view, setView] = useState('list'); // list | upload
      const [search, setSearch] = useState('');
      const [catFilter, setCatFilter] = useState('');
      const [sort, setSort] = useState('date-desc');
      const [toast, setToast] = useState(null);
      const [previewDoc, setPreviewDoc] = useState(null);
      const [deleteDoc, setDeleteDoc] = useState(null);

      const showToast = useCallback((message, type = 'success') => setToast({ message, type }), []);

      const load = useCallback(async () => {
        setLoading(true);
        const ids = (await storage.get('library:list')) || [];
        const items = [];
        for (const id of ids) {
          const d = await storage.get(`library:${id}`);
          if (d) items.push(d);
        }
        setDocs(items);
        setLoading(false);
      }, []);

      useEffect(() => { load(); }, [load]);

      useEffect(() => {
        const onKey = (e) => { if (e.key === 'Escape' && previewDoc) setPreviewDoc(null); };
        window.addEventListener('keydown', onKey);
        return () => window.removeEventListener('keydown', onKey);
      }, [previewDoc]);

      const handleUpload = async ({ file, name, description, category, tags, uploaderName }) => {
        try {
          await validateFileUpload(file);
          const processed = await compressImageFile(file);
          showToast('Uploading...');

          const id = `lib_${Date.now()}`;
          const storagePath = `library/${id}/${Date.now()}_${processed.name}`;
          const fileRef = firebaseStorage.ref().child(storagePath);
          await fileRef.put(processed);
          const downloadURL = await fileRef.getDownloadURL();

          const doc = {
            id,
            name,
            description,
            category,
            tags,
            file: { name: processed.name, type: processed.type, size: processed.size, url: downloadURL, path: storagePath },
            uploadedBy: uploaderName,
            uploadedAt: new Date().toISOString(),
          };

          const ok1 = await storage.set(`library:${id}`, doc);
          const ids = (await storage.get('library:list')) || [];
          ids.push(id);
          const ok2 = await storage.set('library:list', ids);

          if (ok1 && ok2) {
            await updateStorageStats(processed.size, true);
            setDocs(prev => [...prev, doc]);
            setView('list');
            showToast('Document uploaded!');
          } else {
            try { await firebaseStorage.ref().child(storagePath).delete(); } catch (_) {}
            showToast('Failed to save document.', 'error');
          }
        } catch (error) {
          console.error('Library upload error:', error);
          showToast(error.message || 'Upload failed.', 'error');
        }
      };

      const handleDelete = async (doc) => {
        if (doc.file?.path) {
          try {
            await firebaseStorage.ref().child(doc.file.path).delete();
            await updateStorageStats(doc.file.size || 0, false);
          } catch (e) { console.error('File delete error:', e); }
        }
        const ids = ((await storage.get('library:list')) || []).filter(id => id !== doc.id);
        await storage.set('library:list', ids);
        await storage.set(`library:${doc.id}`, null);
        setDocs(prev => prev.filter(d => d.id !== doc.id));
        setDeleteDoc(null);
        showToast('Document deleted');
      };

      const downloadDoc = async (doc) => {
        const src = doc.file?.url;
        if (!src) return;
        try {
          const response = await fetch(src);
          const blob = await response.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = doc.file.name || doc.name;
          a.click();
          URL.revokeObjectURL(url);
        } catch (e) {
          window.open(src, '_blank');
        }
      };

      const filtered = useMemo(() => {
        let list = [...docs];
        if (search) {
          const q = search.toLowerCase();
          list = list.filter(d =>
            d.name.toLowerCase().includes(q) ||
            (d.description || '').toLowerCase().includes(q) ||
            (d.tags || []).some(t => t.toLowerCase().includes(q))
          );
        }
        if (catFilter) list = list.filter(d => d.category === catFilter);
        const [field, dir] = sort.split('-');
        list.sort((a, b) => {
          if (field === 'name') return dir === 'asc' ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name);
          if (field === 'size') return dir === 'desc' ? (b.file?.size || 0) - (a.file?.size || 0) : (a.file?.size || 0) - (b.file?.size || 0);
          const da = new Date(a.uploadedAt), db = new Date(b.uploadedAt);
          return dir === 'desc' ? db - da : da - db;
        });
        return list;
      }, [docs, search, catFilter, sort]);

      return (
        <div className="section-enter min-h-screen">
          {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}

          {deleteDoc && (
            <ConfirmDialog
              title="Delete Document"
              message={`Delete "${deleteDoc.name}"? The file will be permanently removed.`}
              onConfirm={() => handleDelete(deleteDoc)}
              onCancel={() => setDeleteDoc(null)}
            />
          )}

          {/* Preview modal */}
          {previewDoc && (() => {
            const src = previewDoc.file?.url;
            const isImg = previewDoc.file?.type?.startsWith('image/');
            const isPdf = previewDoc.file?.type?.includes('pdf');
            return (
              <div className="fixed inset-0 z-50 flex flex-col bg-black/85 backdrop-blur-sm fade-in" onClick={() => setPreviewDoc(null)}>
                <div className="flex items-center justify-between px-4 py-3 bg-black/40 border-b border-white/5" onClick={e => e.stopPropagation()}>
                  <div className="flex items-center gap-2 min-w-0">
                    <FileIcon type={previewDoc.file?.type} />
                    <span className="text-port-100 text-sm font-medium truncate">{previewDoc.name}</span>
                    <span className="text-port-500 text-xs flex-shrink-0">{formatFileSize(previewDoc.file?.size)}</span>
                  </div>
                  <div className="flex items-center gap-2 flex-shrink-0">
                    <button onClick={() => downloadDoc(previewDoc)} className="px-3 py-1.5 rounded-lg glass-light text-port-200 hover:bg-white/10 transition text-sm">Download</button>
                    <button onClick={() => setPreviewDoc(null)} className="p-1.5 rounded-lg glass-light text-port-200 hover:bg-white/10 transition" title="Close">
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                  </div>
                </div>
                <div className="flex-1 flex items-center justify-center overflow-auto p-4" onClick={e => { if (e.target === e.currentTarget) setPreviewDoc(null); }}>
                  {isImg && <img src={src} alt={previewDoc.name} className="max-w-full max-h-full object-contain rounded-lg" style={{ maxHeight: 'calc(100vh - 80px)' }} onClick={e => e.stopPropagation()} />}
                  {isPdf && <iframe src={src} title={previewDoc.name} className="w-full rounded-lg bg-white" style={{ maxWidth: '900px', height: 'calc(100vh - 80px)' }} onClick={e => e.stopPropagation()} />}
                  {!isImg && !isPdf && (
                    <div className="glass rounded-xl p-8 text-center" onClick={e => e.stopPropagation()}>
                      <FileIcon type={previewDoc.file?.type} />
                      <p className="text-port-300 mt-3 mb-4">Preview not available for this file type.</p>
                      <button onClick={() => downloadDoc(previewDoc)} className="px-5 py-2.5 rounded-lg bg-port-700 text-port-100 hover:bg-port-600 transition text-sm">Download File</button>
                    </div>
                  )}
                </div>
              </div>
            );
          })()}

          {/* Header */}
          <header className="border-b border-white/5">
            <div className="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <button onClick={onBack} className="p-2 rounded-lg glass-light text-port-300 hover:text-port-100 transition" title="Back to menu">
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                  </svg>
                </button>
                <h1 className="font-display text-xl text-port-100">Library</h1>
              </div>
              {view === 'list' && (
                <button onClick={() => setView('upload')} className="flex items-center gap-1.5 px-4 py-2 rounded-lg bg-port-700 text-port-100 hover:bg-port-600 transition text-sm">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>
                  Upload
                </button>
              )}
            </div>
          </header>

          <main className="max-w-5xl mx-auto px-4 py-6">
            {view === 'upload' && (
              <LibraryUploadForm onSave={handleUpload} onCancel={() => setView('list')} currentUserName={currentUserName} />
            )}

            {view === 'list' && (
              <div className="fade-in">
                {/* Search / Filter */}
                {docs.length > 0 && (
                  <div className="flex flex-col sm:flex-row gap-3 mb-6">
                    <div className="relative flex-1">
                      <svg className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-port-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                      </svg>
                      <input type="text" placeholder="Search library..." value={search} onChange={e => setSearch(e.target.value)} className="w-full rounded-lg pl-9 pr-3 py-2.5 text-sm" />
                    </div>
                    <select value={catFilter} onChange={e => setCatFilter(e.target.value)} className="rounded-lg px-3 py-2.5 text-sm min-w-[150px]">
                      <option value="">All Categories</option>
                      {LIBRARY_CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}
                    </select>
                    <select value={sort} onChange={e => setSort(e.target.value)} className="rounded-lg px-3 py-2.5 text-sm min-w-[150px]">
                      <option value="date-desc">Newest First</option>
                      <option value="date-asc">Oldest First</option>
                      <option value="name-asc">Name A-Z</option>
                      <option value="name-desc">Name Z-A</option>
                      <option value="size-desc">Largest First</option>
                      <option value="size-asc">Smallest First</option>
                    </select>
                  </div>
                )}

                {loading ? <Spinner /> : filtered.length === 0 ? (
                  <div className="text-center py-16">
                    {docs.length === 0 ? (
                      <>
                        <svg className="w-14 h-14 mx-auto mb-4 text-port-400 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                        <p className="text-port-400 mb-4">No documents in the library yet.</p>
                        <button onClick={() => setView('upload')} className="px-5 py-2.5 rounded-lg bg-port-700 text-port-100 hover:bg-port-600 transition text-sm">Upload Your First Document</button>
                      </>
                    ) : (
                      <p className="text-port-400">No documents match your search.</p>
                    )}
                  </div>
                ) : (
                  <div className="grid gap-3">
                    {filtered.map(doc => (
                      <LibraryCard
                        key={doc.id}
                        doc={doc}
                        onPreview={setPreviewDoc}
                        onDownload={downloadDoc}
                        onDelete={setDeleteDoc}
                      />
                    ))}
                  </div>
                )}
              </div>
            )}
          </main>

          <footer className="max-w-5xl mx-auto px-4 py-4 text-center">
            <p className="text-port-500 text-xs">Cloud storage &mdash; documents are shared across all Port Committee members.</p>
          </footer>
        </div>
      );
    }

    /* ───────────────── Export / Import ───────────────── */

    async function exportData() {
      const portIds = (await storage.get('ports:list')) || [];
      const meetingIds = (await storage.get('meetings:list')) || [];
      const libraryIds = (await storage.get('library:list')) || [];

      const [ports, ratings, meetings, libraryDocs] = await Promise.all([
        storage.getMulti(portIds.map(id => `port:${id}`)),
        storage.getMulti(portIds.map(id => `ratings:${id}`)),
        storage.getMulti(meetingIds.map(id => `meeting:${id}`)),
        storage.getMulti(libraryIds.map(id => `library:${id}`)),
      ]);

      const data = {
        exportDate: new Date().toISOString(),
        ports: ports.filter(Boolean),
        ratings: ratings.filter(Boolean),
        meetings: meetings.filter(Boolean),
        library: libraryDocs.filter(Boolean),
      };

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `port-committee-backup-${new Date().toISOString().slice(0, 10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    async function importData(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const data = JSON.parse(e.target.result);
            const portIds = [];
            for (const port of (data.ports || [])) {
              await storage.set(`port:${port.id}`, port);
              portIds.push(port.id);
            }
            await storage.set('ports:list', portIds);
            for (const rating of (data.ratings || [])) {
              await storage.set(`ratings:${rating.portId}`, rating);
            }
            const meetingIds = [];
            for (const meeting of (data.meetings || [])) {
              await storage.set(`meeting:${meeting.id}`, meeting);
              meetingIds.push(meeting.id);
            }
            await storage.set('meetings:list', meetingIds);
            resolve(data);
          } catch (err) {
            reject(err);
          }
        };
        reader.onerror = reject;
        reader.readAsText(file);
      });
    }

    /* ───────────────── Migration Helper ───────────────── */

    async function migrateLocalStorageToFirebase() {
      console.log('Starting migration from localStorage to Firebase...');
      const keys = Object.keys(localStorage).filter(k => k !== 'pc_member');
      let migrated = 0;

      for (const key of keys) {
        try {
          const value = JSON.parse(localStorage.getItem(key));

          // If this is a meeting with base64 attachments, upload them to Firebase Storage
          if (key.startsWith('meeting:') && value?.attachments) {
            for (let i = 0; i < value.attachments.length; i++) {
              const att = value.attachments[i];
              if (att.data && !att.url) {
                try {
                  const response = await fetch(att.data);
                  const blob = await response.blob();
                  const storagePath = `meetings/${value.id}/${att.id}_${att.name}`;
                  const fileRef = firebaseStorage.ref().child(storagePath);
                  await fileRef.put(blob);
                  const downloadURL = await fileRef.getDownloadURL();
                  value.attachments[i] = { ...att, url: downloadURL, path: storagePath };
                  delete value.attachments[i].data;
                  console.log(`  Uploaded attachment: ${att.name}`);
                } catch (err) {
                  console.error(`  Failed to upload attachment ${att.name}:`, err);
                }
              }
            }
          }

          await storage.set(key, value);
          migrated++;
          console.log(`Migrated: ${key}`);
        } catch (error) {
          console.error(`Failed to migrate ${key}:`, error);
        }
      }

      console.log(`Migration complete! ${migrated} items migrated to Firebase.`);
      console.log('You can verify data in Firebase Console, then clear localStorage if desired.');
    }

    // To run migration, open browser console and call: migrateLocalStorageToFirebase()

    /* ───────────────── Main App ───────────────── */

    function App({ section, onBack, initialNav, onNavigateToSection, currentUserName }) {
      // Port views
      const [view, setView] = useState(initialNav?.type === 'port' ? 'detail' : 'list');
      const [selectedPort, setSelectedPort] = useState(initialNav?.type === 'port' ? initialNav.id : null);
      const [editPort, setEditPort] = useState(null);
      // Meeting views
      const [meetingView, setMeetingView] = useState(initialNav?.type === 'meeting' ? 'detail' : 'list');
      const [selectedMeeting, setSelectedMeeting] = useState(initialNav?.type === 'meeting' ? initialNav.id : null);
      const [editMeeting, setEditMeeting] = useState(null);
      // Shared
      const [toast, setToast] = useState(null);
      const [quickRate, setQuickRate] = useState(null);

      // Garrafeira entrance video
      const isPortsSection = section === 'garrafeira';
      const skipEntrance = !isPortsSection || !!initialNav;
      const garrafeiraVideoRef = useRef(null);
      const [gPhase, setGPhase] = useState(skipEntrance ? 'content' : 'entrance'); // 'entrance' | 'content'
      const [gVideoPhase, setGVideoPhase] = useState('loading');
      const [gVideoLoaded, setGVideoLoaded] = useState(false);
      const [gContentOpacity, setGContentOpacity] = useState(skipEntrance ? 1 : 0);

      // Pre-load port data during entrance video
      const [preloadedPorts, setPreloadedPorts] = useState(null);
      const [preloadedRatings, setPreloadedRatings] = useState(null);
      useEffect(() => {
        if (!isPortsSection) return;
        (async () => {
          const ids = (await storage.get('ports:list')) || [];
          const portData = [];
          const ratData = {};
          for (const id of ids) {
            const p = await storage.get(`port:${id}`);
            if (p) {
              portData.push(p);
              const r = await storage.get(`ratings:${id}`);
              ratData[id] = r?.ratings || [];
            }
          }
          setPreloadedPorts(portData);
          setPreloadedRatings(ratData);
        })();
      }, [isPortsSection]);

      const showToast = useCallback((message, type = 'success') => {
        setToast({ message, type });
      }, []);

      // Garrafeira entrance video sequence
      useEffect(() => {
        if (skipEntrance || !gVideoLoaded) return;
        setGVideoPhase('fade-in');
        const t1 = setTimeout(() => setGVideoPhase('playing'), 500);
        const tSlow = setTimeout(() => {
          if (garrafeiraVideoRef.current) garrafeiraVideoRef.current.playbackRate = 0.8;
        }, 750);
        const t2 = setTimeout(() => setGVideoPhase('fade-out'), 1250);
        const t3 = setTimeout(() => setGVideoPhase('complete'), 2250);
        return () => { clearTimeout(t1); clearTimeout(tSlow); clearTimeout(t2); clearTimeout(t3); };
      }, [gVideoLoaded, skipEntrance]);

      // Fallback: skip entrance if video doesn't load within 3s
      useEffect(() => {
        if (skipEntrance) return;
        const fallback = setTimeout(() => {
          if (!gVideoLoaded) {
            setGVideoPhase('complete');
          }
        }, 3000);
        return () => clearTimeout(fallback);
      }, [gVideoLoaded, skipEntrance]);

      // Transition to content when video done AND data loaded
      useEffect(() => {
        if (gPhase !== 'entrance') return;
        if (gVideoPhase === 'complete' && preloadedPorts !== null) {
          setGPhase('content');
        }
      }, [gPhase, gVideoPhase, preloadedPorts]);

      // Fade in content after it mounts
      useEffect(() => {
        if (gPhase !== 'content' || skipEntrance) return;
        const raf = requestAnimationFrame(() => setGContentOpacity(1));
        return () => cancelAnimationFrame(raf);
      }, [gPhase, skipEntrance]);

      const sectionTitle = isPortsSection ? 'Garrafeira' : 'Meetings';
      const isMeetingsSection = section === 'meetings';

      const handleAddPort = async (data) => {
        const id = `port_${Date.now()}`;
        const port = {
          id,
          ...data,
          dateAdded: new Date().toISOString(),
          datesTasted: [],
        };
        const ok1 = await storage.set(`port:${id}`, port);
        const ids = (await storage.get('ports:list')) || [];
        ids.push(id);
        const ok2 = await storage.set('ports:list', ids);
        if (ok1 && ok2) {
          showToast('Port added successfully!');
          setView('list');
        } else {
          showToast('Failed to save port', 'error');
        }
      };

      const handleEditPort = async (data) => {
        const updated = { ...editPort, ...data };
        const ok = await storage.set(`port:${editPort.id}`, updated);
        if (ok) {
          showToast('Port updated!');
          setSelectedPort(editPort.id);
          setView('detail');
          setEditPort(null);
        } else {
          showToast('Failed to update port', 'error');
        }
      };

      const handleAddMeeting = async (data) => {
        const id = `meeting_${Date.now()}`;
        const meeting = {
          id,
          ...data,
          attendees: [],
          portsTasted: [],
          dateCreated: new Date().toISOString(),
        };
        const ok1 = await storage.set(`meeting:${id}`, meeting);
        const ids = (await storage.get('meetings:list')) || [];
        ids.push(id);
        const ok2 = await storage.set('meetings:list', ids);
        if (ok1 && ok2) {
          showToast('Meeting created!');
          setMeetingView('list');
        } else {
          showToast('Failed to save meeting', 'error');
        }
      };

      const handleEditMeeting = async (data) => {
        const updated = { ...editMeeting, ...data, attendees: editMeeting.attendees, portsTasted: editMeeting.portsTasted };
        const ok = await storage.set(`meeting:${editMeeting.id}`, updated);
        if (ok) {
          showToast('Meeting updated!');
          setSelectedMeeting(editMeeting.id);
          setMeetingView('detail');
          setEditMeeting(null);
        } else {
          showToast('Failed to update meeting', 'error');
        }
      };

      const GARRAFEIRA_VIDEO_URL = 'https://firebasestorage.googleapis.com/v0/b/port-committee.firebasestorage.app/o/Assets%2Fgarrafeira-entrance.mp4?alt=media&token=f5d0abdd-18d5-4fa7-99a1-8e65b3d20be0';

      // ── Garrafeira entrance: completely separate early return ──
      if (isPortsSection && gPhase === 'entrance') {
        const eOpacity = { loading: 0, 'fade-in': 0, playing: 1, 'fade-out': 0.1, complete: 0.1 }[gVideoPhase] ?? 0;
        const eTransition = gVideoPhase === 'fade-in' ? 'opacity 0.5s ease-in' : gVideoPhase === 'fade-out' ? 'opacity 1s ease-out' : 'none';
        return (
          <div style={{ position: 'fixed', inset: 0, background: 'linear-gradient(135deg, #1a0505 0%, #2d0a0a 100%)', zIndex: 9999 }}>
            <video
              ref={garrafeiraVideoRef}
              autoPlay
              muted
              playsInline
              onLoadedData={() => setGVideoLoaded(true)}
              style={{
                position: 'fixed',
                top: '50%',
                left: '50%',
                minWidth: '100%',
                minHeight: '100%',
                width: 'auto',
                height: 'auto',
                transform: 'translate(-50%, -50%)',
                objectFit: 'cover',
                zIndex: 1,
                opacity: gVideoLoaded ? eOpacity : 0,
                transition: eTransition,
                pointerEvents: 'none',
              }}
            >
              <source src={GARRAFEIRA_VIDEO_URL} type="video/mp4" />
            </video>
          </div>
        );
      }

      // ── Main content (garrafeira after entrance, or meetings) ──
      return (
        <div className={isPortsSection ? 'min-h-screen' : 'min-h-screen section-enter'} style={isPortsSection ? { position: 'relative', overflow: 'hidden' } : undefined}>
          {/* Garrafeira watermark video background */}
          {isPortsSection && (
            <video
              autoPlay
              muted
              playsInline
              style={{
                position: 'fixed',
                top: '50%',
                left: '50%',
                minWidth: '100%',
                minHeight: '100%',
                width: 'auto',
                height: 'auto',
                transform: 'translate(-50%, -50%)',
                objectFit: 'cover',
                zIndex: 0,
                opacity: 0.1,
                pointerEvents: 'none',
              }}
            >
              <source src={GARRAFEIRA_VIDEO_URL} type="video/mp4" />
            </video>
          )}
          {isPortsSection && (
            <div style={{
              position: 'fixed',
              inset: 0,
              background: 'rgba(26, 5, 5, 0.35)',
              zIndex: 1,
              pointerEvents: 'none',
            }} />
          )}

          {/* App Content */}
          <div style={isPortsSection ? {
            position: 'relative',
            zIndex: 2,
            opacity: gContentOpacity,
            transition: 'opacity 0.5s ease-in',
            pointerEvents: gContentOpacity ? 'auto' : 'none',
          } : undefined}>
          {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
          {quickRate && (
            <QuickRateModal
              port={quickRate}
              onClose={() => setQuickRate(null)}
              currentUserName={currentUserName}
              onSaved={(err) => {
                setQuickRate(null);
                showToast(err || 'Rating saved!', err ? 'error' : 'success');
                setView('list');
              }}
            />
          )}

          {/* Header */}
          <header className="border-b border-white/5">
            <div className="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <button onClick={onBack} className="p-2 rounded-lg glass-light text-port-300 hover:text-port-100 transition" title="Back to menu">
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                  </svg>
                </button>
                <h1 className="font-display text-xl text-port-100 leading-tight">{sectionTitle}</h1>
              </div>
              <div className="flex gap-2">
                <button
                  onClick={exportData}
                  className="p-2 rounded-lg glass-light text-port-400 hover:text-port-200 transition"
                  title="Export Data"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                </button>
                {isPortsSection && view !== 'add' && (
                  <button
                    onClick={() => setView('add')}
                    className="flex items-center gap-1.5 px-4 py-2 rounded-lg bg-port-700 text-port-100 hover:bg-port-600 transition text-sm"
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>
                    Add Port
                  </button>
                )}
                {isMeetingsSection && meetingView !== 'add' && (
                  <button
                    onClick={() => setMeetingView('add')}
                    className="flex items-center gap-1.5 px-4 py-2 rounded-lg bg-port-700 text-port-100 hover:bg-port-600 transition text-sm"
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>
                    Create Meeting
                  </button>
                )}
              </div>
            </div>
          </header>

          {/* Main Content */}
          <main className="max-w-5xl mx-auto px-4 py-6">
            {isPortsSection && (
              <>
                {view === 'list' && (
                  <PortList
                    key={Date.now()}
                    onSelect={(id) => { setSelectedPort(id); setView('detail'); }}
                    onAdd={() => setView('add')}
                    initialPorts={preloadedPorts}
                    initialRatings={preloadedRatings}
                  />
                )}
                {view === 'add' && (
                  <PortForm
                    onSave={handleAddPort}
                    onCancel={() => setView('list')}
                  />
                )}
                {view === 'edit' && editPort && (
                  <PortForm
                    port={editPort}
                    onSave={handleEditPort}
                    onCancel={() => { setView('detail'); setEditPort(null); }}
                  />
                )}
                {view === 'detail' && selectedPort && (
                  <PortDetail
                    key={selectedPort}
                    portId={selectedPort}
                    onBack={() => { setView('list'); setSelectedPort(null); }}
                    onEdit={(p) => { setEditPort(p); setView('edit'); }}
                    onDelete={() => { setView('list'); setSelectedPort(null); }}
                    showToast={showToast}
                    onNavigateToMeeting={(mid) => onNavigateToSection('meetings', { type: 'meeting', id: mid })}
                    currentUserName={currentUserName}
                  />
                )}
              </>
            )}
            {isMeetingsSection && (
              <>
                {meetingView === 'list' && (
                  <MeetingList
                    key={Date.now()}
                    onSelect={(id) => { setSelectedMeeting(id); setMeetingView('detail'); }}
                    onAdd={() => setMeetingView('add')}
                  />
                )}
                {meetingView === 'add' && (
                  <MeetingForm
                    onSave={handleAddMeeting}
                    onCancel={() => setMeetingView('list')}
                    currentUserName={currentUserName}
                  />
                )}
                {meetingView === 'edit' && editMeeting && (
                  <MeetingForm
                    meeting={editMeeting}
                    onSave={handleEditMeeting}
                    onCancel={() => { setMeetingView('detail'); setEditMeeting(null); }}
                    currentUserName={currentUserName}
                  />
                )}
                {meetingView === 'detail' && selectedMeeting && (
                  <MeetingDetail
                    key={selectedMeeting}
                    meetingId={selectedMeeting}
                    onBack={() => { setMeetingView('list'); setSelectedMeeting(null); }}
                    onEdit={(m) => { setEditMeeting(m); setMeetingView('edit'); }}
                    showToast={showToast}
                    onNavigateToPort={(portId) => onNavigateToSection('garrafeira', { type: 'port', id: portId })}
                    currentUserName={currentUserName}
                  />
                )}
              </>
            )}
          </main>

          <footer className="max-w-5xl mx-auto px-4 py-4 text-center">
            <p className="text-port-500 text-xs">Cloud storage &mdash; data is shared across all Port Committee members.</p>
          </footer>
          </div>
        </div>
      );
    }

    /* ───────────────── Root Wrapper ───────────────── */

    function Root() {
      const [authChecked, setAuthChecked] = useState(false);
      const [currentUserName, setCurrentUserName] = useState(null);
      const [entered, setEntered] = useState(false);
      const [activeSection, setActiveSection] = useState(null);
      const [initialNav, setInitialNav] = useState(null);

      // Listen for auth state changes
      useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged(async (user) => {
          if (user) {
            const profile = await getUserProfile(user.uid);
            if (profile) {
              setCurrentUserName(profile.name);
              localStorage.setItem('pc_member', profile.name);
            } else {
              // Authenticated but no profile yet (will show login name step)
              setCurrentUserName(null);
            }
          } else {
            setCurrentUserName(null);
          }
          setAuthChecked(true);
        });
        return () => unsubscribe();
      }, []);

      const handleLoginSuccess = useCallback((name) => {
        setCurrentUserName(name);
        localStorage.setItem('pc_member', name);
      }, []);

      const handleLogout = useCallback(async () => {
        try {
          await auth.signOut();
          setCurrentUserName(null);
          setEntered(false);
          setActiveSection(null);
          setInitialNav(null);
        } catch (err) {
          console.error('Logout error:', err);
        }
      }, []);

      const handleNavigateToSection = useCallback((section, navTarget) => {
        setInitialNav(navTarget || null);
        setActiveSection(section);
      }, []);

      const handleBack = useCallback(() => {
        setActiveSection(null);
        setInitialNav(null);
      }, []);

      // Loading while checking auth
      if (!authChecked) {
        return (
          <div className="min-h-screen flex items-center justify-center">
            <Spinner />
          </div>
        );
      }

      // Not authenticated — show login
      if (!currentUserName) {
        return <PhoneLoginScreen onLoginSuccess={handleLoginSuccess} />;
      }

      return (
        <>
          {!entered && <LandingPage onEnter={() => setEntered(true)} />}
          {entered && !activeSection && (
            <Dashboard
              onSelectSection={setActiveSection}
              currentUserName={currentUserName}
              onLogout={handleLogout}
            />
          )}
          {entered && activeSection === 'library' && (
            <LibrarySection onBack={handleBack} currentUserName={currentUserName} />
          )}
          {entered && (activeSection === 'garrafeira' || activeSection === 'meetings') && (
            <App
              key={activeSection + ':' + (initialNav?.id || '')}
              section={activeSection}
              onBack={handleBack}
              initialNav={initialNav}
              onNavigateToSection={handleNavigateToSection}
              currentUserName={currentUserName}
            />
          )}
        </>
      );
    }

    /* ───────────────── Mount ───────────────── */
    ReactDOM.createRoot(document.getElementById('root')).render(<Root />);
  </script>
</body>
</html>
